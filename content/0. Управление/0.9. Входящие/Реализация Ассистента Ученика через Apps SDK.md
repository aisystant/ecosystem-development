
## Описание архитектуры Apps SDK + MCP + цифровой двойник + идентификация

### 1) Клиент пользователя (хост + UI на Apps SDK)
- **Что это физически:** веб-страница ChatGPT (или другой хост), внутри которой запускается ваш интерфейс на Apps SDK (виджеты).    
- **Роль:** показывает интерфейс, отправляет действия пользователя (кнопки, формы), отображает ответы ассистента и визуальные блоки прогресса.    
- **Где живёт:** в браузере пользователя.    

### 2) LLM-модель (генерация ответов и вызов инструментов)
- **Что это физически:** большая языковая модель у провайдера (OpenAI), которую хост (ChatGPT) вызывает для генерации текста и решения “нужно ли вызвать инструмент”.    
- **Роль:** ведёт диалог по вашей методологии, формирует рекомендации, интерпретирует данные из цифрового двойника, инициирует вызовы MCP-инструментов (через хост).    
- **Где живёт:** в инфраструктуре провайдера модели (не у вас).    

### 3) Сервер MCP (ваш шлюз инструментов)
- **Что это физически:** ваш серверный сервис (HTTP) с реализацией протокола MCP и набора инструментов (handlers), задеплоенный в облаке.    
- **Роль:** принимает вызовы инструментов от хоста/модели, проверяет авторизацию, обращается к цифровому двойнику, выполняет детерминированные расчёты (например, план недели) и возвращает структурированный результат.    
- **Где живёт:** в вашей инфраструктуре (контейнер/виртуальная машина/серверлес).    

### 4) Сервис идентификации (ваш логин и выпуск токенов)
- **Что это физически:** отдельный сервис или модуль вашего бэкенда, который проводит вход пользователя, выдаёт и обновляет токены, хранит/проверяет сессии.    
- **Роль:** подтверждает “кто пользователь”, выдаёт токен доступа, обеспечивает привязку “пользователь → цифровой двойник” (через реестр связей).    
- **Где живёт:** в вашей инфраструктуре (как отдельный микросервис или часть бэкенда).    

### 5) Реестр привязок “пользователь ↔ цифровой двойник”
- **Что это физически:** таблица/коллекция в базе (или отдельное хранилище), где хранится соответствие идентификатора пользователя (из токена/аккаунта) и идентификатора цифрового двойника (`twin_id`). Это “телефонная книга соответствий” между аккаунтом человека и записью его цифрового двойника.   
- **Роль:** позволяет серверу MCP быстро понять, к каким данным цифрового двойника можно обращаться при каждом запросе инструмента.    
- **Где живёт:** в вашей базе данных (часть слоя идентификации или часть базы цифрового двойника).    

### 6) Цифровой двойник (персональные данные и история)
- **Что это физически:** база данных (плюс схема и внутренний API доступа), где лежат персональные данные пользователя: профиль, цели, ограничения, журнал помидорок, заметки, планы, итоги, метрики регулярности.    
- **Роль:** хранит “память” между сессиями и является источником фактов для персонализации рекомендаций.    
- **Где живёт:** в вашей инфраструктуре хранения данных (управляемая база/кластер/облако).
    

### 7) Конфигурация поведения Ассистента (методология как артефакты)
- **Что это физически:** набор версионируемых артефактов (файлы в репозитории + при необходимости конфигурация в хранилище), которые подключаются при вызове LLM-модели и/или исполняются как код на сервере MCP.    
- **Роль:** задаёт правила: как определять ступень, как формировать ответ, какие инварианты держать, какие расчёты делать детерминированно (например, раскладка помидорок), чтобы поведение было устойчивым и повторяемым.    
- **Где живёт:** в вашем репозитории (Git) и в коде/конфигурации сервисов, которые вы деплоите.-

## Рабочие продукты, которые необходимо создать

### А. Методология и поведение ассистента

**1) Документ “Методология Ассистента” (единый источник правил)**
- **Для чего:** чтобы LLM-модель всегда работала по одним и тем же правилам; чтобы команда могла изменять методологию контролируемо.    
- **Содержание:** ступени, критерии агентности/мастерства, алгоритм оценки, формат ответа (ступень + признаки + шаги недели + микрошаг + эксперимент), недельный цикл, правила про “один экран”, словарь терминов.    
- **Где размещён:** репозиторий (Git) как файл документации; используется при сборке/конфигурации ассистента.    

**2) Версионирование методологии (правило и журнал изменений)**
- **Для чего:** чтобы изменения методологии не “ломали” старые сценарии и можно было воспроизводить результаты.    
- **Содержание:** номер версии, что изменилось, обратная совместимость, дата ввода, миграционные заметки.    
- **Где размещён:** репозиторий (Git) рядом с методологией + записи релизов (например, в `CHANGELOG`).    

**3) Контент-словарь рабочих продуктов пользователя**
- **Для чего:** чтобы данные в цифровом двойнике были стандартизированы, и UI/аналитика понимали типы результатов.    
- **Содержание:** перечень типов (“заметка”, “черновик”, “домашнее задание”, “план недели”, “итог недели”), обязательные поля, примеры.    
- **Где размещён:** репозиторий (Git), и отражён в схеме базы (типы/перечисления).    

---

### B. Данные цифрового двойника

**4) Схема данных цифрового двойника**
- **Для чего:** чтобы все сервисы одинаково читали/писали данные, и чтобы история пользователя была цельной.    
- **Содержание:** таблицы/коллекции и связи: пользователь, привязка к двойнику, помидорки, заметки, планы недели, итоги недели, выявленные барьеры/мемы, метрики регулярности.    
- **Где размещён:** в кодовой базе (миграции/DDL/схемы) + в базе данных (фактическая структура).    

**5) Политика хранения данных (ретеншн и удаление)**
- **Для чего:** безопасность и соответствие ожиданиям пользователя; контроль объёма и рисков.    
- **Содержание:** что хранится, как долго, как пользователь удаляет/экспортирует, что попадает в логи, как обезличивается.    
- **Где размещён:** репозиторий (политика) + настройки в инфраструктуре (сроки хранения логов/бэкапов).    

**6) Внутренний API цифрового двойника (контракт доступа к данным)**
- **Для чего:** чтобы сервер MCP работал с двойником через стабильный интерфейс, независимо от конкретной базы.    
- **Содержание:** методы/эндпоинты: получить сводку, получить неделю, записать помидорку, сохранить заметку, сохранить план/итог, получить историю.    
- **Где размещён:** в бэкенд-сервисе (код + спецификация контрактов).    

---

### C. Идентификация и права доступа

**7) Сервис идентификации (логин и выпуск токенов)**
- **Для чего:** чтобы понять “кто пользователь” и безопасно выдать доступ к его двойнику.    
- **Содержание:** сценарии логина, выдача/обновление токенов, управление сессиями, отзыв доступа.    
- **Где размещён:** отдельный сервис или модуль бэкенда; конфигурация секретов в секрет-хранилище.    

**8) Реестр сопоставления “пользователь ↔ цифровой двойник”**
- **Для чего:** чтобы по идентификатору пользователя быстро находить `twin_id` и не путать данные разных людей.    
- **Содержание:** таблица/коллекция `twin_links`: идентификатор субъекта, `twin_id`, дата привязки, статус, источник, метки согласий.    
- **Где размещён:** в вашей базе данных (часть цифрового двойника или отдельное хранилище идентификации).    

**9) Модель прав доступа (скоупы/разрешения)**
- **Для чего:** чтобы ограничить, что именно можно читать/писать, и делать “минимально необходимый доступ”.    
- **Содержание:** набор прав: чтение сводки, чтение недели, запись помидорки, запись заметки, запись планов/итогов, экспорт/удаление; матрица ролей.    
- **Где размещён:** репозиторий (описание) + реализация в сервисах (проверки прав).    

**10) Поток авторизации для MCP-инструментов**
- **Для чего:** чтобы каждый вызов инструмента на сервере MCP был безопасно привязан к конкретному пользователю и его двойнику.    
- **Содержание:** как MCP-сервер получает токен, как валидирует, как извлекает идентификатор пользователя, как находит `twin_id`, как обрабатывает просрочку/отказ.    
- **Где размещён:** код сервера MCP + документация для поддержки/отладки.    

---

### D. MCP-сервер и инструменты

**11) Сервер MCP (каркас сервиса)**
- **Для чего:** быть шлюзом между LLM-моделью и вашими данными/логикой.    
- **Содержание:** реализация протокола MCP, маршрутизация инструментов, обработка ошибок, логирование, конфиги окружений.    
- **Где размещён:** отдельный репозиторий сервиса или папка в монорепозитории; задеплоен в облако.    

**12) Набор MCP-инструментов (минимальный)**
- **Для чего:** дать LLM-модели управляемый доступ к чтению/записи и расчётам без прямого доступа к базе.    
- **Содержание:**    
    - - получить обзор ученика (цели, ограничения, текущий фокус)    
	- получить состояние недели (активные действия за неделю, дни с активностью)    
	- получить инвестированное время за неделю и среднее за день    
	- получить систематичность слота саморазвития (сколько дней удержан слот за неделю)    
	- настроить слот саморазвития (время, дни недели, длительность)    
	- получить количество рабочих продуктов за неделю (заметки, черновики, заготовки)    
	- сохранить рабочий продукт (заметка / черновик / заготовка)    
	- собрать план недели по двум числам (детерминированно, 2 варианта)    
	- сохранить план недели    
	- сохранить итог недели (итоги, что помогало/мешало, следующий микрошаг, эксперимент)        
- **Где размещён:** код сервера MCP (как обработчики инструментов).    

**13) Контракты инструментов (вход/выход, схемы)**
- **Для чего:** чтобы UI и LLM-модель получали предсказуемые структуры, а вы могли менять реализацию без поломок.    
- **Содержание:** JSON-схемы параметров и ответов, примеры запросов/ответов, коды ошибок, требования к авторизации.    
- **Где размещён:** репозиторий MCP-сервера (спецификация рядом с кодом).    

**14) Тесты инструментов и расчётов**
- **Для чего:** чтобы методология (особенно расчёты плана) не “плыла” при изменениях.    
- **Содержание:** юнит-тесты планировщика, интеграционные тесты чтения/записи в двойник, тесты отказов авторизации.    
- **Где размещён:** репозиторий MCP-сервера, запускаются в непрерывной интеграции.    

---

### E. Интерфейс на Apps SDK

**15) Карта пользовательских сценариев (user flows) и макеты экранов**
- **Для чего:** чтобы согласовать, что именно пользователь делает в онбординге, ежедневно и по итогам недели.    
- **Содержание:** схемы экранов: подключение двойника, ежедневный трекер, план недели, итог недели, прогресс; состояния “не подключено/нужна авторизация/ошибка”.    
- **Где размещён:** дизайн-док (например, файл в репозитории или макеты в дизайнерском инструменте).    

**16) Реализация виджетов Apps SDK**
- **Для чего:** дать пользователю управляемые кнопки и формы, а не только текстовый чат.    
- **Содержание:** компоненты UI: кнопки “начать/залогировать”, форма заметки, выбор числа помидорок/дней, карточки прогресса, обработка ошибок и повторов.    
- **Где размещён:** фронтенд-проект Apps SDK (репозиторий), сборка публикуется как приложение.    

**17) Управление состояниями UI**
- **Для чего:** чтобы интерфейс корректно переживал авторизацию, потери сети, пустые данные и повторные входы.    
- **Содержание:** модель состояний: подключён/не подключён, токен истёк, запись успешна/ошибка, синхронизация, локальный кэш.    
- **Где размещён:** код фронтенда Apps SDK + описание в документации проекта.    

---

### F. Безопасность, качество, эксплуатация

**18) Логи и аудит действий**
- **Для чего:** расследование инцидентов, понимание качества сервиса, контроль доступа.    
- **Содержание:** журнал вызовов инструментов (кто, когда, какой инструмент, результат), без лишнего содержимого персональных заметок.  
- **Где размещён:** система логирования (облако/лог-агрегатор) + минимальные записи в базе аудита (если нужно).    

**19) Документ по безопасности и приватности**
- **Для чего:** единые правила обращения с персональными данными и секретами.    
- **Содержание:** хранение токенов, секреты, ограничение частоты запросов, защита от утечек, политика доступа сотрудников.    
- **Где размещён:** репозиторий (политика) + настройки инфраструктуры (секрет-хранилище, лимиты).    

**20) Инфраструктура деплоя (описание окружений)**
- **Для чего:** предсказуемые релизы, разделение тестовой и боевой среды.    
- **Содержание:** контейнеризация, переменные окружения, секреты, маршрутизация, домены, сертификаты.    
- **Где размещён:** репозиторий (инфра-код) + облачная инфраструктура.    

**21) Мониторинг и метрики**
- **Для чего:** видеть сбои и деградации до того, как их заметит пользователь.  
- **Содержание:** метрики задержек инструментов, процент ошибок, успешность записей, нагрузка, алерты.    
- **Где размещён:** система мониторинга (облако/метрики).

## План работ

### Пользовательский сценарий Релиза 1

1. Пользователь открывает UI на Apps SDK → нажимает “Подключить цифрового двойника” → проходит идентификацию.    
2. Нажимает “Показать неделю” → получает либо список действий, либо инвестированное время.    
3. Ассистент, видя данные недели, даёт рекомендации по траектории (шаги на неделю + микрошаг сегодня).

### Релиз 1 — минимально работающий продукт (обновлённый)

#### Пакет 1.1. Онбординг и связка “пользователь ↔ цифровой двойник” (без изменений)
- **UI на Apps SDK:** экран подключения, статусы, ошибки авторизации.    
- **Сервис идентификации:** логин, токены, обновление.    
- **Реестр привязок:** `пользователь → twin_id`.    
- **Сервер MCP:** проверка токена, получение `twin_id`.    
**Критерий готовности:** любой запрос к данным идёт строго в контексте правильного `twin_id`.

---

#### Пакет 1.2. Чтение сводки (можно оставить, но сводка будет опираться на неделю)
- **Цифровой двойник:** минимальные поля профиля + агрегаты недели (если есть).    
- **MCP-инструмент:** `get_twin_summary` (структурированный ответ).    
- **UI на Apps SDK:** карточка “Сводка” + “обновить”.
**Критерий готовности:** ассистент может выдать рекомендации, используя сводку и факт недели.

---

#### Пакет 1.3. Чтение “активных действий за неделю” или “инвестированного времени за неделю” (замена записи помидорки)
Выберите один из двух вариантов (или сделайте оба, но начать проще с одного).
#### Вариант А: список активных действий за неделю
- **Что считается “действием”:** любое событие, которое ваш двойник уже фиксирует (например: прочитал раздел, сделал задание, написал заметку, создал черновик, опубликовал, провёл тренировку и т.д.).    
- **Цифровой двойник:**    
    - сущность `actions` с полями: `twin_id`, время, тип, длительность (если есть), источник, короткое описание.        
    - метод: `get_week_actions(twin_id, дата_начала, дата_конца)`.        
- **Сервер MCP:**    
    - инструмент `get_week_actions` возвращает структурировано:        
        - список действий,            
        - количество,            
        - разбиение по типам.            
- **UI на Apps SDK:**    
    - экран “Неделя”: список действий + фильтр по типу (минимально).        
    - индикатор: “дней с активностью” и “всего действий”.
**Критерий готовности:** пользователь подключился → видит список действий за неделю → ассистент строит рекомендацию на фактах (“у вас 3 дня активности, 7 действий, провал в середине недели”).

#### Вариант Б: инвестированное время за неделю (сумма)
- **Цифровой двойник:**    
    - либо хранит события с длительностью,        
    - либо хранит уже готовый агрегат “время за неделю”.        
    - метод: `get_week_time(twin_id, дата_начала, дата_конца)` → минуты/часы + (опционально) по категориям.        
- **Сервер MCP:**    
    - инструмент `get_week_time` возвращает:        
        - суммарное время,            
        - время по дням (если есть),            
        - время по категориям (если есть).            
- **UI на Apps SDK:**    
    - экран “Неделя”: число часов + простая лента по дням (можно даже без графиков на старте).
**Критерий готовности:** пользователь подключился → видит “сколько времени инвестировано за неделю” → ассистент даёт следующий шаг (“добавим один фиксированный слот”).

---

#### Пакет 1.4. Минимальная “конфигурация поведения Ассистента” под новый тип данных
- Правило: если пришли **недельные действия/время**, ассистент:    
    - фиксирует факт (числа, дни),        
    - определяет текущую ступень **на основании устойчивости за период**, а не одного дня,        
    - выдаёт шаги недели + микрошаг сегодня.        
- Если данных нет: ассистент предлагает настроить источник событий или “ручной минимум” (например, отметить 1 действие в день через UI) — но это уже опционально.
**Критерий готовности:** ответы стабильны и привязаны к фактам недели.


### Релиз 2 — недельный планировщик и итоги (в общем виде)

Цель: появится **персональная траектория на неделю** и регулярный “ритм”.
### Пакеты работ

- **Планировщик недели**
    
    - MCP-инструмент `build_week_plan(помидорки в день, дней в неделю)` с детерминированной логикой (ваши правила).
        
    - Сохранение плана: `save_week_plan`.
        
    - UI: экран планирования (ввод 2 чисел, показ 2 вариантов плана).
        
- **Недельный итог**
    
    - MCP-инструмент `get_week_state` и `save_week_review`.
        
    - UI: экран “Итоги недели” (дни с практикой, помидорки, рабочие продукты, что мешало/помогало).
        
- **Рабочие продукты пользователя**
    
    - Минимальные типы в двойнике: “заметка”, “черновик”, “домашнее задание”, “план недели”, “итог недели”.
        
    - UI для сохранения короткой заметки после помидорки (1–3 предложения).
        

**Критерий готовности:** пользователь планирует неделю за 1–2 минуты и в конце недели получает итог с предложением следующего шага.

---

### Релиз 3 — качество, безопасность, мониторинг (в общем виде)

Цель: система становится **надёжной**, управляемой и безопасной для масштаба.

### Пакеты работ

- **Безопасность и приватность**
    
    - Стандарты логирования без утечек (не писать сырые заметки в логи).
        
    - Ограничения доступа (скоупы), отзыв токенов, политика удаления/экспорта.
        
    - Ограничение частоты запросов (rate limiting) для MCP.
        
- **Наблюдаемость**
    
    - Метрики: задержки инструментов, ошибки по типам, успешность записи помидорок, процент “нужна авторизация”.
        
    - Алерты: недоступна база, всплеск ошибок, рост задержек.
        
- **Качество продукта**
    
    - Автотесты сценариев (онбординг → сводка → запись → план → итог).
        
    - Регресс-тесты методологии: чтобы при обновлении версии не менялся формат/логика.
        
- **Эксплуатация**
    
    - Разделение сред (тестовая/боевая), безопасные миграции схемы.
        
    - Бэкапы и восстановление, контроль стоимости хранения.
        

**Критерий готовности:** вы видите, что ломается и почему; можете безопасно обновлять методологию и инструменты без “сюрпризов”.