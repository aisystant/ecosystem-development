---
type: architecture
status: draft
version: 0.1
created: 2025-12-29
layer: platform
scope: ecosystem
description: "Архитектура доступа ИИ-агентов к данным экосистемы для персонализированных рекомендаций"
related:
  - "Канонический шаблон описания MCP Tools и Resources"
  - "FSM-архитектура ИИ-ассистентов 3.2"
  - "Общая архитектура ИТ-платформы 3.2"
---

# Архитектура доступа ИИ к данным экосистемы

## Назначение документа

Документ описывает архитектуру системы, которая позволяет:

1. **Персонализированные рекомендации** — ИИ-агенты получают доступ к данным Цифрового двойника для формирования персональных траекторий развития
2. **Открытость для сообщества** — участники экосистемы могут создавать собственных ИИ-агентов
3. **Гарантия приватности** — автор агента не получает сырые данные пользователей, только агрегированные метрики (опционально)

---

## Ключевой сценарий: "Агент Ивана для Васи"

```
Иван (автор агента)              Вася (пользователь)
       │                                │
       │ публикует пакет агента         │ выбирает агента
       ▼                                │ даёт consent (scopes)
┌─────────────────────────────────────────────────────────────┐
│            ДОВЕРЕННАЯ СРЕДА ЭКОСИСТЕМЫ                     │
│                                                             │
│  Агент Ивана исполняется здесь                             │
│  • Иван НЕ получает сырые данные Васи                      │
│  • Вася получает персональные рекомендации                 │
│  • Платформа гарантирует приватность через Policy Engine   │
└─────────────────────────────────────────────────────────────┘
       │                                │
       │ (опционально)                  │
       ▼                                ▼
  агрегированные             персональные рекомендации
  метрики для Ивана          и руководства для Васи
```

**Гарантия приватности:**
- Агент Ивана исполняется в Managed Runtime экосистемы
- Внешний автор (Иван) не получает сырые данные Васи
- Наружу — только результат и (опционально) агрегированные метрики
- PEP (Policy Enforcement Point) находится в MCP Gateway: он режет доступ по scopes и контексту

---

## Схема архитектуры

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  АКТОРЫ                           ИНТЕРФЕЙСЫ (клиенты)                      │
│                                                                             │
│  ┌─────────────────┐              ┌─────────────────────────────────────┐  │
│  │ Иван            │              │ Apps SDK UI (App «Проводник» и др.) │  │
│  │ создатель агента│              │ ChatGPT UI                          │  │
│  │ (пакета логики) │              │ Telegram / Web / Custom             │  │
│  └────────┬────────┘              └──────────────────┬──────────────────┘  │
│           │                                          │                      │
│           │ публикация                               │ запуск сессии       │
│           │ пакета                                   │                      │
│  ┌────────┴────────┐                                 │                      │
│  │ Вася            │─────────────────────────────────┘                      │
│  │ пользователь,   │   выбор агента                  ▲                      │
│  │ владелец ЦД     │                                 │ результаты:          │
│  └─────────────────┘                                 │ рекомендации +       │
│                                                      │ руководства          │
└──────────────────────────────────────────────────────┼──────────────────────┘
                                                       │
┌──────────────────────────────────────────────────────┼──────────────────────┐
│  СЛОЙ 1: ЛОГИКА И ВЫЧИСЛЕНИЕ                         │                      │
│  (Managed Runtime — доверенная среда)                │                      │
│                                                      │                      │
│  ┌───────────────────────────────────────────────────┴──────────────────┐  │
│  │ Реестр / Маркетплейс агентов                                         │  │
│  │   • Публикация и версионирование пакетов                             │  │
│  │   • Пакет агента: методология, FSM-граф, политика минимизации,       │  │
│  │     настройки tool-use, тесты                                        │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ Managed Agent Runtime                                                │  │
│  │   • FSM-оркестрация состояний агента                                │  │
│  │   • Интеграция с LLM (Claude, GPT и др.)                            │  │
│  │   • Генерация рекомендаций и персональных руководств                │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │ State Store                 │  │ Trajectory Store                    │  │
│  │   • Сессии пользователей    │  │   • Персональные маршруты           │  │
│  │   • Прогресс выполнения     │  │   • Сгенерированные руководства     │  │
│  └─────────────────────────────┘  └─────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       │ аутентификация + проверка согласия
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  СЛОЙ 2: ДОВЕРИЕ (Identity / Consent / Policy)                              │
│                                                                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────┐  │
│  │ Identity Provider│  │ Consent Service  │  │ Policy Engine            │  │
│  │   • OIDC/OAuth   │  │   • Согласие на  │  │   • ABAC/ReBAC           │  │
│  │   • Аутентиф.    │  │     доступ агенту│  │   • Правила доступа      │  │
│  │     пользователей│  │   • Scopes       │  │   • Минимизация данных   │  │
│  │     и агентов    │  │   • Срок/отзыв   │  │                          │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────────────┘  │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ Audit Log                                                            │  │
│  │   • Кто / что / когда / какие scopes                                 │  │
│  │   • Журнал всех обращений к данным                                   │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       │ user-bound token + scopes
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  СЛОЙ 3: ДОСТУП К ДАННЫМ (Access Services / MCP)                            │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ MCP Gateway / Router                                                 │  │
│  │   • Единая точка входа для всех MCP-запросов                        │  │
│  │   • PEP (Policy Enforcement Point) — принуждение политик            │  │
│  │   • Маршрутизация к доменным MCP-серверам                           │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐ ┌──────────────┐ │
│  │ DigitalTwin    │ │ Guides MCP     │ │ Exercises MCP  │ │ Exocortex    │ │
│  │ MCP            │ │                │ │                │ │ MCP          │ │
│  │                │ │ Доступ к       │ │ Доступ к       │ │              │ │
│  │ Доступ к       │ │ руководствам   │ │ упражнениям    │ │ Доступ к     │ │
│  │ данным ЦД      │ │ и шаблонам     │ │ и рубрикам     │ │ базе знаний  │ │
│  └────────────────┘ └────────────────┘ └────────────────┘ └──────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       │ read / write back по контракту
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  СЛОЙ 4: ДАННЫЕ ЭКОСИСТЕМЫ (Data Assets)                                    │
│                                                                             │
│  ┌─────────────────────────────────────┐  ┌─────────────────────────────┐  │
│  │ ПЕРСОНАЛЬНЫЕ ДАННЫЕ (per user)      │  │ ОБЩИЕ ДАННЫЕ (shared)       │  │
│  │                                     │  │                             │  │
│  │ • Digital Twin Store                │  │ • Guides Repository         │  │
│  │   (персональные метрики, состояние) │  │   (руководства, шаблоны)    │  │
│  │                                     │  │                             │  │
│  │ • Exocortex / Knowledge Base        │  │ • Exercises Bank            │  │
│  │   (личные материалы, заметки)       │  │   (упражнения, рубрики)     │  │
│  │                                     │  │                             │  │
│  │ • User Trajectory                   │  │ • Course Catalog            │  │
│  │   (прогресс, история)               │  │   (курсы, методологии)      │  │
│  └─────────────────────────────────────┘  └─────────────────────────────┘  │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ Telemetry & Audit Store                                              │  │
│  │   • Журналы использования (анонимизированные)                       │  │
│  │   • Метрики качества данных                                          │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Детальное описание слоёв

### Слой 1: Логика и вычисление (Managed Runtime)

**Назначение:** Исполнение логики ИИ-агентов в доверенной среде экосистемы.

**Почему так:**
- Логика агентов от сообщества должна исполняться в контролируемой среде, чтобы гарантировать приватность
- Автор агента не должен иметь прямого доступа к данным пользователей
- Централизованное исполнение позволяет применять единые политики безопасности

#### Компоненты слоя:

| Компонент | Назначение | Что внутри |
|-----------|------------|------------|
| **Реестр / Маркетплейс агентов** | Хранение и версионирование пакетов агентов | Метаданные пакетов, версии, статусы аудита, рейтинги |
| **Пакет агента** | Единица публикации от автора | FSM-граф, промпты, политика минимизации данных, tool-use настройки, тесты |
| **Managed Agent Runtime** | Среда исполнения агентов | FSM-движок, LLM-интеграция, генератор рекомендаций |
| **State Store** | Хранение состояния сессий | Текущее состояние FSM, контекст диалога, прогресс |
| **Trajectory Store** | Хранение персональных траекторий | Сгенерированные маршруты, персональные руководства |

---

### Слой 2: Доверие (Identity / Consent / Policy)

**Назначение:** Управление идентификацией, согласиями и политиками доступа.

**Почему так:**
- Без явного согласия пользователя агент не должен получать доступ к его данным
- Политики доступа должны быть централизованы и аудируемы
- Нужен полный журнал: кто, когда, к каким данным обращался

#### Компоненты слоя:

| Компонент | Назначение | Что внутри |
|-----------|------------|------------|
| **Identity Provider** | Аутентификация пользователей и агентов | OIDC/OAuth провайдер, токены, сессии |
| **Consent Service** | Управление согласиями пользователей | Записи consent: user → agent → scopes → срок → статус |
| **Policy Engine** | Вычисление разрешений на доступ | ABAC/ReBAC правила, политики минимизации данных |
| **Audit Log** | Журналирование всех обращений | Записи: timestamp, actor, action, resource, scopes, result |

#### Модель согласия (Consent):

```
Consent Record:
  user_id: "vasia"
  agent_id: "ivan/trajectory-advisor"
  scopes: ["dt:read:progress", "dt:read:goals"]
  granted_at: "2025-12-29T10:00:00Z"
  expires_at: "2026-01-29T10:00:00Z"
  revoked: false
```

---

### Слой 3: Доступ к данным (MCP Gateway + Domain MCP)

**Назначение:** Единая точка входа для доступа к данным с применением политик.

**Почему так:**
- MCP Gateway как PEP гарантирует, что все запросы проходят через проверку политик
- Доменные MCP-серверы инкапсулируют логику доступа к конкретным типам данных
- Разделение по доменам позволяет независимо развивать и масштабировать каждый MCP

#### Компоненты слоя:

| Компонент | Назначение | Что внутри |
|-----------|------------|------------|
| **MCP Gateway / Router** | Единая точка входа, PEP | Маршрутизатор запросов, валидатор токенов, enforcement политик |
| **DigitalTwin MCP** | Доступ к данным Цифрового двойника | Tools: `dt.get_*`, `dt.save_*`; Resources: `dt://catalogs/*` |
| **Guides MCP** | Доступ к руководствам и шаблонам | Tools: `guides.get_*`, `guides.search`; Resources: `guides://catalog` |
| **Exercises MCP** | Доступ к упражнениям и рубрикам | Tools: `exercises.get_*`, `exercises.check`; Resources: `exercises://bank` |
| **Exocortex MCP** | Доступ к базе знаний пользователя | Tools: `exo.search`, `exo.get_*`; Resources: `exo://index` |

---

### Слой 4: Данные экосистемы (Data Assets)

**Назначение:** Хранение данных с разделением на персональные и общие.

**Почему так:**
- Персональные данные принадлежат пользователю и требуют consent для доступа
- Общие данные (руководства, упражнения) доступны всем участникам экосистемы
- Разделение позволяет применять разные политики хранения и доступа

#### Компоненты слоя:

| Компонент | Тип | Назначение | Что внутри |
|-----------|-----|------------|------------|
| **Digital Twin Store** | Персональный | Состояние и метрики пользователя | Прогресс курсов, инвестированное время, цели, достижения |
| **Exocortex / KB** | Персональный | Личная база знаний | Заметки, конспекты, рефлексии, связи между понятиями |
| **User Trajectory** | Персональный | История и прогресс | Пройденные шаги, результаты упражнений, рекомендации |
| **Guides Repository** | Общий | Руководства и шаблоны | Методологии, шаблоны документов, best practices |
| **Exercises Bank** | Общий | Упражнения и рубрики | Задания, критерии оценки, примеры решений |
| **Course Catalog** | Общий | Каталог курсов | Описания курсов, структура, пререквизиты |
| **Telemetry & Audit** | Системный | Журналы и метрики | Логи использования, метрики качества данных |

---

## Таблица объектов архитектуры

### Сводная таблица: объекты, модули, размещение

| Объект | Слой | Модуль реализации | Размещение | Технологии |
|--------|------|-------------------|------------|------------|
| **Реестр агентов** | Логика | `agent-registry` | Platform Backend | PostgreSQL + S3 для пакетов |
| **Пакет агента** | Логика | — (артефакт) | S3 / Git repo | JSON/YAML + промпты |
| **Managed Agent Runtime** | Логика | `agent-runtime` | Platform Backend | Python/Node + LLM API |
| **State Store** | Логика | `state-store` | Platform Backend | Redis / PostgreSQL |
| **Trajectory Store** | Логика | `trajectory-store` | Platform Backend | PostgreSQL + vector DB |
| **Identity Provider** | Доверие | `idp` | Platform Auth | Keycloak / Auth0 / Custom |
| **Consent Service** | Доверие | `consent-service` | Platform Auth | PostgreSQL + API |
| **Policy Engine** | Доверие | `policy-engine` | Platform Auth | OPA (Open Policy Agent) |
| **Audit Log** | Доверие | `audit-log` | Platform Observability | ClickHouse / PostgreSQL |
| **MCP Gateway** | Доступ | `mcp-gateway` | Platform API | Node.js / Go |
| **DigitalTwin MCP** | Доступ | `dt-mcp` | MCP Server | TypeScript (MCP SDK) |
| **Guides MCP** | Доступ | `guides-mcp` | MCP Server | TypeScript (MCP SDK) |
| **Exercises MCP** | Доступ | `exercises-mcp` | MCP Server | TypeScript (MCP SDK) |
| **Exocortex MCP** | Доступ | `exocortex-mcp` | MCP Server | TypeScript (MCP SDK) |
| **Digital Twin Store** | Данные | `dt-store` | Data Layer | PostgreSQL + TimescaleDB |
| **Exocortex KB** | Данные | `exocortex-store` | Data Layer | PostgreSQL + pgvector |
| **Guides Repository** | Данные | `guides-repo` | Data Layer | Git repo / S3 + PostgreSQL |
| **Exercises Bank** | Данные | `exercises-bank` | Data Layer | PostgreSQL + S3 |
| **Telemetry Store** | Данные | `telemetry` | Data Layer | ClickHouse |

---

### Таблица: потоки данных между объектами

| От | К | Данные | Протокол |
|----|---|--------|----------|
| Интерфейс (UI) | Managed Runtime | Запрос пользователя, выбор агента | HTTPS / WebSocket |
| Managed Runtime | Policy Engine | Запрос на проверку доступа | gRPC / HTTP |
| Policy Engine | Consent Service | Запрос consent для user+agent | Internal API |
| Managed Runtime | MCP Gateway | Tool call с user-bound token | MCP Protocol |
| MCP Gateway | Domain MCP | Маршрутизированный запрос | MCP Protocol |
| Domain MCP | Data Store | Read/Write данных | SQL / API |
| Managed Runtime | Интерфейс | Рекомендации, руководства | HTTPS / WebSocket |
| Все компоненты | Audit Log | События аудита | Async (queue) |

---

## Уровни доступа к данным

| Уровень | Описание | Кто видит | Пример |
|---------|----------|-----------|--------|
| **user-only** | Только владелец данных | Вася | Личные заметки экзокортекса |
| **agent-mediated** | ИИ-агент (не автор агента!) | Агент Ивана для Васи | Прогресс Васи для рекомендаций |
| **aggregate** | Агрегированные метрики | Иван (автор агента) | "60% пользователей прошли шаг 3" |
| **public** | Все участники экосистемы | Любой | Руководства, упражнения |

---

## Scopes для Consent

| Scope | Описание | Данные |
|-------|----------|--------|
| `dt:read:progress` | Чтение прогресса по курсам | Пройденные модули, даты |
| `dt:read:goals` | Чтение целей пользователя | Список целей, приоритеты |
| `dt:read:time` | Чтение инвестированного времени | Метрики времени |
| `dt:write:reflection` | Запись рефлексий | Заметки от агента |
| `exo:read:notes` | Чтение заметок экзокортекса | Конспекты, связи |
| `trajectory:read` | Чтение траектории | Текущий маршрут |
| `trajectory:write` | Запись в траекторию | Рекомендации, шаги |

---

## Жизненный цикл взаимодействия

```
1. ПУБЛИКАЦИЯ АГЕНТА (Иван)
   ┌─────────────────────────────────────────────────────────────┐
   │ Иван создаёт пакет агента:                                  │
   │   • FSM-граф диалога                                        │
   │   • Промпты для LLM                                         │
   │   • Политика минимизации: "нужны только dt:read:progress"   │
   │   • Тесты                                                   │
   │                                                             │
   │ Иван публикует в Реестр агентов                            │
   │ (опционально: проходит аудит платформы)                     │
   └─────────────────────────────────────────────────────────────┘

2. ВЫБОР АГЕНТА (Вася)
   ┌─────────────────────────────────────────────────────────────┐
   │ Вася видит агента в маркетплейсе                            │
   │ Вася выбирает агента                                        │
   │                                                             │
   │ Consent Service показывает:                                 │
   │   "Агент запрашивает доступ к: прогресс по курсам"          │
   │                                                             │
   │ Вася даёт согласие (consent)                                │
   └─────────────────────────────────────────────────────────────┘

3. СЕССИЯ (Вася + Агент Ивана)
   ┌─────────────────────────────────────────────────────────────┐
   │ Вася запускает сессию через UI (ChatGPT / Apps SDK / etc)   │
   │                                                             │
   │ Managed Runtime:                                            │
   │   • Загружает пакет агента Ивана                           │
   │   • Запускает FSM с состояния "start"                       │
   │   • При необходимости данных → запрос к MCP Gateway        │
   │                                                             │
   │ MCP Gateway:                                                │
   │   • Проверяет token Васи                                    │
   │   • Проверяет consent Васи для агента Ивана                │
   │   • Проверяет scope запроса                                 │
   │   • Если OK → маршрутизирует к DigitalTwin MCP             │
   │                                                             │
   │ Агент получает данные, генерирует рекомендации             │
   │ Вася получает персональное руководство                      │
   └─────────────────────────────────────────────────────────────┘

4. АУДИТ
   ┌─────────────────────────────────────────────────────────────┐
   │ Все обращения логируются в Audit Log:                       │
   │   • timestamp: 2025-12-29T12:34:56Z                         │
   │   • actor: agent:ivan/trajectory-advisor                    │
   │   • on_behalf_of: user:vasia                                │
   │   • action: dt.get_progress                                 │
   │   • result: success                                         │
   │   • scopes_used: [dt:read:progress]                         │
   └─────────────────────────────────────────────────────────────┘
```

---

## Связь с существующими документами

- **[[Канонический шаблон описания MCP Tools и Resources]]** — формат описания Tools и Resources для MCP-серверов
- **[[FSM-архитектура ИИ-ассистентов 3.2]]** — архитектура FSM-логики агентов
- **[[Общая архитектура ИТ-платформы 3.2]]** — место MCP в общей архитектуре платформы

---

## Открытые вопросы

| # | Вопрос | Статус |
|---|--------|--------|
| 1 | Формат пакета агента (JSON Schema?) | Требует проработки |
| 2 | Процесс аудита агентов от сообщества | Отложен |
| 3 | Механизм отзыва consent в реальном времени | Требует проработки |
| 4 | Версионирование FSM при обновлении агента | Требует проработки |
| 5 | Квоты на использование LLM для агентов сообщества | Требует проработки |

---

## Changelog

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-29 | v0.1 | Первичная версия архитектуры |
