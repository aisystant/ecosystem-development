---
type: architecture
status: draft
version: 0.6
created: 2025-12-29
updated: 2025-12-29
layer: platform
scope: ecosystem
description: "Архитектура доступа ИИ-агентов к данным экосистемы для персонализированных рекомендаций"
related:
  - "Канонический шаблон описания MCP Tools и Resources"
  - "FSM-архитектура ИИ-ассистентов 3.2"
  - "Общая архитектура ИТ-платформы 3.2"
---

# Архитектура доступа ИИ к данным экосистемы

## Назначение документа

Документ описывает архитектуру системы, которая позволяет:

1. **Персонализированные рекомендации** — ИИ-системы получают доступ к данным Цифрового двойника для формирования персональных траекторий развития
2. **Открытость для сообщества** — участники экосистемы могут создавать собственных ИИ-агентов
3. **Единая логика работы** — все ИИ-системы (и МИМ, и сообщества) работают через общую инфраструктуру
4. **Гарантия приватности** — автор агента не получает сырые данные пользователей

---

## Два типа ИИ-систем

В экосистеме существуют два типа ИИ-систем, работающих по единой архитектуре:

| Тип | Владелец | Примеры | Особенности |
|-----|----------|---------|-------------|
| **ИИ-системы МИМ** | Платформа МИМ | Проводник, ДЗ-чекер, Рефлексия | Системные агенты, расширенные права, гарантированная доступность |
| **Агенты сообщества** | Участники экосистемы | Агент Ивана для машиностроителей | Проходят аудит, ограниченные квоты, публикуются в маркетплейсе |

**Единая логика:** Оба типа работают через один Managed Runtime, используют одни MCP-серверы, подчиняются единому Policy Engine. Различия только в уровне доверия и квотах.

---

## Схема архитектуры

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            ПОЛЬЗОВАТЕЛИ                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐ │
│  │ Вася                │  │ Петя                │  │ Маша                │ │
│  │                     │  │                     │  │                     │ │
│  │ • Владелец своего   │  │ • Владелец своего   │  │ • Владелец своего   │ │
│  │   Цифрового двойника│  │   Цифрового двойника│  │   Цифрового двойника│ │
│  │ • Выбирает агентов  │  │ • Выбирает агентов  │  │ • Выбирает агентов  │ │
│  │ • Даёт consent      │  │ • Даёт consent      │  │ • Даёт consent      │ │
│  │ • Получает пользу   │  │ • Получает пользу   │  │ • Получает пользу   │ │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ взаимодействует через
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ИНТЕРФЕЙСЫ (клиенты)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌───────────┐ │
│  │ Apps SDK UI     │ │ ChatGPT UI      │ │ Telegram Bot    │ │ Web App   │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ └───────────┘ │
│                                                                             │
│  Интерфейсы — только клиенты. Не хранят данные, не исполняют логику.       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ запросы пользователей
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    СЛОЙ 1: ИИ-АГЕНТЫ (Agents Layer)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Все агенты работают в единой доверенной среде по общей логике.            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Реестр / Маркетплейс агентов                                        │   │
│  │   • Публикация и версионирование пакетов                            │   │
│  │   • Статусы: verified (МИМ) / audited (сообщество) / experimental   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Пакеты агентов (владелец указан в названии)                         │   │
│  │                                                                     │   │
│  │  ИИ-системы МИМ:                    Агенты сообщества:              │   │
│  │  ┌─────────────────────────────┐    ┌─────────────────────────────┐ │   │
│  │  │ • Проводник (МИМ)           │    │ • Траектория (Иван)         │ │   │
│  │  │ • ДЗ-чекер (МИМ)            │    │ • HR-навигатор (Мария)      │ │   │
│  │  │ • Рефлексия (МИМ)           │    │ • DevOps-ментор (Сергей)    │ │   │
│  │  │ • Методолог (МИМ)           │    │ • ...                       │ │   │
│  │  └─────────────────────────────┘    └─────────────────────────────┘ │   │
│  │                                                                     │   │
│  │  verified: расширенные права,       audited: требует consent,       │   │
│  │  без квот, implicit consent         квоты LLM, автор не видит данные│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Managed Agent Runtime                                               │   │
│  │   • FSM-оркестрация состояний агента                               │   │
│  │   • Интеграция с LLM (Claude, GPT и др.)                           │   │
│  │   • Генерация рекомендаций и персональных руководств               │   │
│  │   • Единый движок для ВСЕХ агентов (и МИМ, и сообщества)           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │ State Store                 │  │ Trajectory Store                    │  │
│  │   • Сессии пользователей    │  │   • Персональные маршруты           │  │
│  │   • Прогресс выполнения     │  │   • Сгенерированные руководства     │  │
│  └─────────────────────────────┘  └─────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       │ аутентификация + проверка согласия
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                  СЛОЙ 2: ДОВЕРИЕ (Identity / Consent / Policy)              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────┐  │
│  │ Identity Provider│  │ Consent Service  │  │ Policy Engine            │  │
│  │                  │  │                  │  │                          │  │
│  │ • OIDC/OAuth     │  │ • Согласие на    │  │ • ABAC/ReBAC             │  │
│  │ • Аутентификация │  │   доступ агенту  │  │ • Правила для МИМ        │  │
│  │   пользователей  │  │ • Scopes         │  │ • Правила для сообщества │  │
│  │ • Аутентификация │  │ • Срок/отзыв     │  │ • Минимизация данных     │  │
│  │   агентов        │  │                  │  │                          │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────────────┘  │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ Audit Log                                                            │  │
│  │   • Кто / что / когда / какие scopes                                 │  │
│  │   • Журнал для агентов МИМ и сообщества (единый формат)             │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       │ user-bound token + scopes
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   СЛОЙ 3: ДОСТУП К ДАННЫМ (MCP Services)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ MCP Gateway / Router                                                 │  │
│  │   • Единая точка входа для всех MCP-запросов                        │  │
│  │   • PEP (Policy Enforcement Point) — принуждение политик            │  │
│  │   • Маршрутизация к доменным MCP-серверам                           │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐ ┌──────────────┐ │
│  │ DigitalTwin    │ │ Guides MCP     │ │ Exercises MCP  │ │ Exocortex    │ │
│  │ MCP            │ │                │ │                │ │ MCP          │ │
│  │                │ │ Доступ к       │ │ Доступ к       │ │              │ │
│  │ Доступ к       │ │ руководствам   │ │ упражнениям    │ │ Доступ к     │ │
│  │ данным ЦД      │ │ и шаблонам     │ │ и рубрикам     │ │ базе знаний  │ │
│  └────────────────┘ └────────────────┘ └────────────────┘ └──────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       │ read / write back по контракту
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     СЛОЙ 4: ДАННЫЕ (Data Assets)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────┐  ┌─────────────────────────────┐  │
│  │ ПЕРСОНАЛЬНЫЕ ДАННЫЕ (per user)      │  │ ОБЩИЕ ДАННЫЕ (shared)       │  │
│  │                                     │  │                             │  │
│  │ • Digital Twin Store                │  │ • Guides Repository         │  │
│  │   (метрики, состояние, цели)        │  │   (руководства, шаблоны)    │  │
│  │                                     │  │                             │  │
│  │ • Exocortex / Knowledge Base        │  │ • Exercises Bank            │  │
│  │   (личные материалы, заметки)       │  │   (упражнения, рубрики)     │  │
│  │                                     │  │                             │  │
│  │ • User Trajectory                   │  │ • Course Catalog            │  │
│  │   (прогресс, история)               │  │   (курсы, методологии)      │  │
│  └─────────────────────────────────────┘  └─────────────────────────────┘  │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ Telemetry & Audit Store                                              │  │
│  │   • Журналы использования (анонимизированные)                       │  │
│  │   • Метрики качества данных                                          │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Взаимодействие между слоями

### 1. Интерфейсы → Слой 1 (Агенты)

**Связь:** `запросы пользователей`

```
┌─────────────────────┐
│ Интерфейс (ChatGPT) │
└──────────┬──────────┘
           │
           │  HTTP/WebSocket
           │  • Текст запроса пользователя
           │  • ID сессии
           │  • Выбранный агент ("Проводник (МИМ)")
           │  • Access token пользователя (от Identity Provider)
           ▼
┌─────────────────────────────────────────────┐
│ Managed Agent Runtime                       │
│   → загружает пакет агента из реестра      │
│   → запускает FSM-логику                   │
└─────────────────────────────────────────────┘
```

**Что передаётся:**
- Сообщение пользователя (текст)
- Идентификатор выбранного агента
- Токен аутентификации (получен при входе в интерфейс)

**Ключевое:** Интерфейс — "тупой клиент", он только передаёт запрос и отображает ответ. Логики нет.

---

### 2. Слой 1 (Агенты) → Слой 2 (Доверие)

**Связь:** `аутентификация + проверка согласия`

```
┌─────────────────────────────────────────────┐
│ Managed Agent Runtime                       │
│   Агент хочет вызвать: dt.get_progress()   │
└──────────┬──────────────────────────────────┘
           │
           │  Запрос к Слою 2:
           │  • "Кто пользователь?" → Identity Provider
           │  • "Есть ли consent?" → Consent Service
           │  • "Разрешено ли?" → Policy Engine
           ▼
┌─────────────────────────────────────────────┐
│ Identity: user=vasia, verified=true         │
│ Consent: dt:read:progress = granted         │
│ Policy: agent=МИМ → allow implicit consent  │
│                                             │
│ Результат: token с scopes [dt:read:progress]│
└─────────────────────────────────────────────┘
```

**Что передаётся туда:**
- Access token пользователя
- ID агента и его статус (verified/audited)
- Запрашиваемые scopes (какие данные нужны)

**Что возвращается:**
- Подтверждённая идентичность (user_id)
- Список разрешённых scopes
- User-bound token для следующего слоя

**Ключевое:** Для МИМ — implicit consent (не спрашивает). Для сообщества — проверяет явное согласие.

---

### 3. Слой 2 (Доверие) → Слой 3 (Доступ / MCP)

**Связь:** `user-bound token + scopes`

```
┌─────────────────────────────────────────────┐
│ Policy Engine выдал:                        │
│   token: "eyJ..." (подписанный JWT)        │
│   scopes: [dt:read:progress, guides:search] │
│   user_id: vasia                            │
│   agent_id: provodnik-mim                   │
│   ttl: 5 min                                │
└──────────┬──────────────────────────────────┘
           │
           │  MCP Protocol call:
           │  dt.get_progress({user_id: "vasia"})
           │  + заголовок Authorization: Bearer <token>
           ▼
┌─────────────────────────────────────────────┐
│ MCP Gateway (PEP)                           │
│   1. Валидирует token                       │
│   2. Проверяет scope dt:read:progress ✓    │
│   3. Маршрутизирует → DigitalTwin MCP      │
└─────────────────────────────────────────────┘
```

**Что передаётся:**
- MCP tool call (название + параметры)
- User-bound token со scopes
- Audit metadata (agent_id, request_id)

**Ключевое:** MCP Gateway — это PEP (Policy Enforcement Point). Он режет любой запрос, который выходит за рамки scopes в токене.

---

### 4. Слой 3 (MCP) → Слой 4 (Данные)

**Связь:** `read / write back по контракту`

```
┌─────────────────────────────────────────────┐
│ DigitalTwin MCP                             │
│   Запрос: dt.get_progress(user_id=vasia)   │
└──────────┬──────────────────────────────────┘
           │
           │  SQL/API to Data Layer:
           │  SELECT * FROM progress
           │  WHERE user_id = 'vasia'
           │
           │  Контракт (JSON Schema):
           │  • Что возвращать
           │  • В каком формате
           │  • Метаданные качества
           ▼
┌─────────────────────────────────────────────┐
│ Digital Twin Store (SurrealDB)              │
│                                             │
│   Возврат:                                  │
│   {                                         │
│     progress: [...],                        │
│     data_quality: { coverage: 0.95 }        │
│   }                                         │
└─────────────────────────────────────────────┘
```

**Что передаётся туда:**
- Запрос по контракту MCP Tool (см. [[Канонический шаблон описания MCP Tools и Resources]])
- user_id для фильтрации персональных данных

**Что возвращается:**
- Данные по схеме (JSON)
- Метаданные качества (coverage, last_sync)
- Ошибки валидации, если есть

**Ключевое:** MCP-сервер знает *как* получить данные. Он абстрагирует хранилище — агент не знает, что под капотом SurrealDB.

---

### Сводная таблица связей

| Связь | Протокол | Что передаётся | Кто проверяет |
|-------|----------|----------------|---------------|
| Интерфейсы → Агенты | HTTPS/WS | Запрос + session token | Runtime |
| Агенты → Доверие | Internal API | User token + scopes request | Identity, Consent, Policy |
| Доверие → MCP | MCP Protocol | Tool call + user-bound token | MCP Gateway (PEP) |
| MCP → Данные | SQL/API | Query по контракту | MCP-сервер |

---

## Сценарий 1: Вася использует ИИ-систему МИМ "Проводник (МИМ)"

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  Вася ──► Интерфейс (ChatGPT UI) ──► выбирает "Проводник (МИМ)"            │
│                                                                             │
│       │  Consent НЕ требуется для базовых функций                          │
│       │  (системный агент, verified статус)                                 │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Managed Agent Runtime                                               │   │
│  │                                                                     │   │
│  │  "Проводник (МИМ)" запрашивает:                                    │   │
│  │    • dt.get_progress() — прогресс по курсам                        │   │
│  │    • guides.search() — релевантные руководства                     │   │
│  │                                                                     │   │
│  │  Генерирует персональную траекторию                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       ▼                                                                     │
│  Вася получает: "Рекомендую начать с модуля X, затем Y..."                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Сценарий 2: Вася использует агент сообщества "Траектория (Иван)"

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  Вася ──► Интерфейс ──► Маркетплейс ──► видит "Траектория (Иван)"          │
│                                                                             │
│       │  Агент сообщества требует явного согласия                          │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Consent Service                                                     │   │
│  │   "Траектория (Иван) запрашивает доступ к:                         │   │
│  │    • Прогресс по курсам                                            │   │
│  │    • Ваши цели"                                                    │   │
│  │                                                                     │   │
│  │   [Разрешить]  [Отклонить]                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       │ Вася даёт согласие                                                 │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Managed Agent Runtime (тот же, что для ИИ-систем МИМ!)             │   │
│  │                                                                     │   │
│  │  "Траектория (Иван)" исполняется в доверенной среде                │   │
│  │  Иван НЕ получает сырые данные Васи                                │   │
│  │  Policy Engine проверяет scopes при каждом запросе                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       ▼                                                                     │
│  Вася получает: специализированные рекомендации для машиностроителей       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Гарантия приватности

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         МОДЕЛЬ ПРИВАТНОСТИ                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Для ИИ-систем МИМ (например, "Проводник (МИМ)"):                   │   │
│  │                                                                     │   │
│  │  • Базовый доступ без явного consent (verified статус)             │   │
│  │  • Расширенные scopes требуют согласия пользователя                │   │
│  │  • Все обращения логируются в Audit Log                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Для агентов сообщества (например, "Траектория (Иван)"):            │   │
│  │                                                                     │   │
│  │  • Любой доступ требует явного consent от пользователя             │   │
│  │  • Автор агента НИКОГДА не видит сырые данные пользователей        │   │
│  │  • Агент исполняется в Managed Runtime экосистемы                  │   │
│  │  • PEP в MCP Gateway режет доступ по scopes                        │   │
│  │  • Автор может получить только агрегированные метрики              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Детальное описание слоёв

### Слой 1: ИИ-агенты (Agents Layer)

**Назначение:** Единый слой для всех ИИ-систем — и МИМ, и сообщества.

**Почему единый слой:**
- Общая инфраструктура снижает сложность
- Единые правила = предсказуемое поведение
- Агенты сообщества получают те же возможности, что и системные

#### Компоненты слоя:

| Компонент | Назначение | Что внутри |
|-----------|------------|------------|
| **Реестр / Маркетплейс агентов** | Хранение и версионирование пакетов | Метаданные, версии, статусы (verified/audited/experimental) |
| **Пакет агента** | Единица публикации | FSM-граф, промпты, политика минимизации, tool-use, тесты |
| **Managed Agent Runtime** | Среда исполнения (общая для всех!) | FSM-движок, LLM-интеграция, генератор рекомендаций |
| **State Store** | Хранение состояния сессий | Текущее состояние FSM, контекст диалога |
| **Trajectory Store** | Персональные траектории | Маршруты, сгенерированные руководства |

#### Различия между типами агентов:

| Аспект | ИИ-системы МИМ | Агенты сообщества |
|--------|----------------|-------------------|
| Статус в реестре | `verified` | `audited` / `experimental` |
| Базовый доступ | Без явного consent | Требует consent |
| Квоты LLM | Без ограничений | Ограниченные квоты |
| Доступ к данным | Расширенный | Только по scopes в consent |
| Аудит | Внутренний | Обязательный перед публикацией |

---

### Слой 2: Доверие (Identity / Consent / Policy)

**Назначение:** Единый слой управления доступом для всех типов агентов.

| Компонент | Назначение | Что внутри |
|-----------|------------|------------|
| **Identity Provider** | Аутентификация | OIDC/OAuth, токены для пользователей и агентов |
| **Consent Service** | Управление согласиями | Записи: user → agent → scopes → срок |
| **Policy Engine** | Вычисление разрешений | Правила ABAC/ReBAC, отдельные политики для МИМ и сообщества |
| **Audit Log** | Журналирование | Единый формат для всех агентов |

#### Модель согласия:

```
Consent Record (для агента сообщества):
  user_id: "vasia"
  agent_id: "community/ivan/machinist-advisor"
  agent_type: "community"
  scopes: ["dt:read:progress", "dt:read:goals"]
  granted_at: "2025-12-29T10:00:00Z"
  expires_at: "2026-01-29T10:00:00Z"

Implicit Consent (для ИИ-систем МИМ):
  user_id: "vasia"
  agent_id: "mim/navigator"
  agent_type: "system"
  scopes: ["dt:read:progress", "guides:read"]  # базовые scopes
  granted_at: "2025-12-29T10:00:00Z"  # при регистрации
  implicit: true
```

---

### Слой 3: Доступ к данным (MCP Services)

**Назначение:** Единая точка входа к данным для всех агентов.

| Компонент | Назначение | Что внутри |
|-----------|------------|------------|
| **MCP Gateway** | Единая точка входа, PEP | Маршрутизация, enforcement политик |
| **DigitalTwin MCP** | Данные ЦД | `dt.get_*`, `dt.save_*` |
| **Guides MCP** | Руководства | `guides.get_*`, `guides.search` |
| **Exercises MCP** | Упражнения | `exercises.get_*`, `exercises.check` |
| **Exocortex MCP** | База знаний | `exo.search`, `exo.get_*` |

---

### Слой 4: Данные (Data Assets)

**Назначение:** Хранение данных экосистемы.

| Компонент | Тип | Назначение |
|-----------|-----|------------|
| **Digital Twin Store** | Персональный | Метрики, состояние, цели пользователя |
| **Exocortex / KB** | Персональный | Личные заметки, конспекты |
| **User Trajectory** | Персональный | Прогресс, история, рекомендации |
| **Guides Repository** | Общий | Руководства, шаблоны |
| **Exercises Bank** | Общий | Упражнения, рубрики оценки |
| **Course Catalog** | Общий | Курсы, методологии |
| **Telemetry Store** | Системный | Журналы, метрики качества |

---

## Таблица объектов архитектуры

### Сводная таблица: объекты, модули, размещение

| Объект | Слой | Модуль | Размещение | Технологии |
|--------|------|--------|------------|------------|
| **Реестр агентов** | Агенты | `agent-registry` | Platform Backend | SurrealDB + S3 |
| **Пакет агента (МИМ)** | Агенты | — (артефакт) | Internal Git | JSON/YAML + промпты |
| **Пакет агента (community)** | Агенты | — (артефакт) | S3 + Git | JSON/YAML + промпты |
| **Managed Agent Runtime** | Агенты | `agent-runtime` | Platform Backend | Python/Node + LLM API |
| **State Store** | Агенты | `state-store` | Platform Backend | Redis / SurrealDB |
| **Trajectory Store** | Агенты | `trajectory-store` | Platform Backend | SurrealDB (vector) |
| **Identity Provider** | Доверие | `idp` | Platform Auth | Keycloak / Custom |
| **Consent Service** | Доверие | `consent-service` | Platform Auth | SurrealDB + API |
| **Policy Engine** | Доверие | `policy-engine` | Platform Auth | OPA |
| **Audit Log** | Доверие | `audit-log` | Platform Observability | ClickHouse |
| **MCP Gateway** | Доступ | `mcp-gateway` | Platform API | Node.js / Go |
| **DigitalTwin MCP** | Доступ | `dt-mcp` | MCP Server | TypeScript (MCP SDK) |
| **Guides MCP** | Доступ | `guides-mcp` | MCP Server | TypeScript (MCP SDK) |
| **Exercises MCP** | Доступ | `exercises-mcp` | MCP Server | TypeScript (MCP SDK) |
| **Exocortex MCP** | Доступ | `exocortex-mcp` | MCP Server | TypeScript (MCP SDK) |
| **Digital Twin Store** | Данные | `dt-store` | Data Layer | SurrealDB (time-series) |
| **Exocortex KB** | Данные | `exocortex-store` | Data Layer | SurrealDB (vector) |
| **Guides Repository** | Данные | `guides-repo` | Data Layer | Git + SurrealDB |
| **Exercises Bank** | Данные | `exercises-bank` | Data Layer | SurrealDB + S3 |
| **Telemetry Store** | Данные | `telemetry` | Data Layer | ClickHouse |

---

### Таблица: потоки данных

| От | К | Данные | Протокол |
|----|---|--------|----------|
| Интерфейс (UI) | Agent Runtime | Запрос пользователя | HTTPS / WebSocket |
| Agent Runtime | Policy Engine | Проверка доступа | gRPC / HTTP |
| Policy Engine | Consent Service | Проверка consent | Internal API |
| Agent Runtime | MCP Gateway | Tool call + token | MCP Protocol |
| MCP Gateway | Domain MCP | Запрос с scopes | MCP Protocol |
| Domain MCP | Data Store | Read/Write | SQL / API |
| Agent Runtime | Интерфейс | Результаты | HTTPS / WebSocket |
| Все компоненты | Audit Log | События | Async (queue) |

---

## Scopes для Consent

| Scope | Описание | Доступ МИМ | Доступ community |
|-------|----------|------------|------------------|
| `dt:read:progress` | Прогресс по курсам | implicit | требует consent |
| `dt:read:goals` | Цели пользователя | implicit | требует consent |
| `dt:read:time` | Инвестированное время | implicit | требует consent |
| `dt:write:reflection` | Запись рефлексий | implicit | требует consent |
| `exo:read:notes` | Заметки экзокортекса | требует consent | требует consent |
| `trajectory:read` | Текущая траектория | implicit | требует consent |
| `trajectory:write` | Изменение траектории | implicit | требует consent |

---

## Связь с OpenAI Apps SDK

Документ **[[Интеграция ассистентов через OpenAI Apps SDK 0.9]]** описывает конкретную реализацию доступа к ИИ-системе "Проводник (МИМ)" через ChatGPT. Эта архитектура является обобщением и расширением того подхода.

### Соответствие компонентов

| Apps SDK компонент | Слой этой архитектуры | Комментарий |
|--------------------|----------------------|-------------|
| ChatGPT UI + iframe | **Интерфейсы** | Один из клиентов |
| `fsm-mcp` | **Managed Agent Runtime** | MCP-сервер с FSM-логикой |
| MCP ЦД (Twin) | **DigitalTwin MCP** | Доступ к персональным данным |
| "Согласие на доступ к ЦД" | **Consent Service** | Детализировано в этой архитектуре |

### Как fsm-mcp соотносится с Managed Agent Runtime

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Managed Agent Runtime                                    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ fsm-mcp (для ИИ-систем МИМ)                                         │   │
│  │   • get_instruction(state?) — FSM-логика Проводника                │   │
│  │   • states/*.md — определения состояний                            │   │
│  │   • UI-компонент для Apps SDK                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ community-agents-runtime (для агентов сообщества)                   │   │
│  │   • Загрузка пакетов агентов из реестра                            │   │
│  │   • FSM-движок для исполнения графов                               │   │
│  │   • Квотирование и изоляция                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Общие компоненты:                                                         │
│    • LLM-интеграция (Claude, GPT)                                          │
│    • State Store, Trajectory Store                                         │
│    • Интеграция с MCP Gateway                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Вывод:** `fsm-mcp` — это конкретная реализация части Managed Agent Runtime для ИИ-систем МИМ. Агенты сообщества будут использовать аналогичный, но отдельный runtime с дополнительной изоляцией.

### Расширение модели Apps SDK для агентов сообщества

Apps SDK описывает только системного "Проводника". Для агентов сообщества потребуется:

1. **Маркетплейс в интерфейсе** — пользователь выбирает агента
2. **Consent flow** — перед первым использованием
3. **Изоляция runtime** — агент сообщества не может выйти за пределы scopes

---

## Открытые вопросы

| # | Вопрос | Статус |
|---|--------|--------|
| 1 | Формат пакета агента (JSON Schema?) | Требует проработки |
| 2 | Процесс аудита агентов от сообщества | Отложен |
| 3 | Механизм отзыва consent в реальном времени | Требует проработки |
| 4 | Квоты LLM для агентов сообщества | Требует проработки |
| 5 | Монетизация агентов сообщества | Не рассмотрено |

---

## Связанные документы

- **[[Интеграция ассистентов через OpenAI Apps SDK 0.9]]** — конкретная реализация для ChatGPT
- **[[Канонический шаблон описания MCP Tools и Resources]]** — формат Tools/Resources
- **[[FSM-архитектура ИИ-ассистентов 3.2]]** — архитектура FSM-логики
- **[[Общая архитектура ИТ-платформы 3.2]]** — место в платформе

---

## Changelog

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-29 | v0.1 | Первичная версия |
| 2025-12-29 | v0.2 | Добавлено разделение МИМ/сообщество, рефакторинг схемы по слоям |
| 2025-12-29 | v0.3 | Пользователи отдельно, владелец в названии агента (МИМ)/(Иван) |
| 2025-12-29 | v0.4 | Добавлена связь с OpenAI Apps SDK, соответствие fsm-mcp и Runtime |
| 2025-12-29 | v0.5 | Замена PostgreSQL на SurrealDB (multi-model: time-series, vector) |
| 2025-12-29 | v0.6 | Добавлен раздел "Взаимодействие между слоями" с детальными схемами |
