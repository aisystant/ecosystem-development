# ДЗ-чекер v2 — Semantic Search архитектура

> **Статус:** draft
> **Семейство:** F0 (Управление знаниями)
> **Автор:** Claude
> **Дата:** 2026-01-04
> **Версия:** 0.9

## 0. Назначение документа

Описание новой архитектуры ДЗ-чекера на основе семантического поиска (`semantic_search`), которая не требует знания slug раздела и работает напрямую с текстом вопроса.

**Потребители:**
- Архитектор (проектирование и развёртывание)
- Разработчики (интеграция с LMS)
- Операторы (мониторинг и отладка)

**Связанные документы:**
- [[Workflow ДЗ-чекера в n8n 0.9]] — предыдущая версия (deprecated)
- [[Структура репозитория руководств 0.9]]
- [[Канонический шаблон описания MCP Tools и Resources]]

---

## 1. Проблема предыдущего подхода

### Старая архитектура (v1)

```
course_name → guide_slug (маппинг)
section_name → section_slug (fuzzy match)
get_guide_sections → get_section_content → норматив
```

**Проблемы:**

| Проблема | Описание |
|----------|----------|
| **Нет slug на фронте** | Пользователь на странице вопросов, не на текстовом разделе |
| **Жёсткая структура** | Требуется уникальность заголовков и точный маппинг |
| **Два вызова MCP** | `get_guide_sections` + `get_section_content` |
| **Fuzzy matching** | Ненадёжно при похожих названиях разделов |

---

## 2. Новая архитектура (v2)

### Ключевая идея

**Вместо резолвинга section → slug используем семантический поиск по тексту вопроса.**

```
question_text → semantic_search → релевантные фрагменты → LLM оценивает ответ
```

### Преимущества

| Аспект | v1 (старый) | v2 (новый) |
|--------|-------------|------------|
| Резолвинг slug | Требуется | **Не нужен** |
| Количество вызовов MCP | 2 | **1** |
| Работа с неточными названиями | Fuzzy match | **Семантический поиск** |
| Структура руководства | Жёсткая | **Любая** |

---

## 3. Входные данные (с фронта LMS)

```json
{
  "question_text": "Почему важно развивать мышление письмом?",
  "answer_text": "Ответ стажера...",
  "course_name": "Системное саморазвитие",
  "section_name": "Мышление письмом"
}
```

| Поле | Обязательное | Использование |
|------|--------------|---------------|
| `question_text` | **Да** | Запрос для semantic_search |
| `answer_text` | **Да** | Ответ для оценки |
| `course_name` | Нет | Контекст для LLM (опционально) |
| `section_name` | Нет | Контекст для LLM (опционально) |

**Важно:** `section_name` больше не используется для поиска — только как контекст в промпте.

---

## 4. Схема workflow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         n8n workflow v2                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────┐    ┌──────────┐    ┌─────────────────────────────────┐   │
│  │ Webhook  │───▶│ Validate │───▶│         AI Agent                │   │
│  │ POST     │    │          │    │                                 │   │
│  │ /check   │    │          │    │  Tool: semantic_search          │   │
│  └──────────┘    └──────────┘    │  ├── query: question_text       │   │
│                                  │  ├── lang: "ru"                 │   │
│                                  │  └── limit: 3-5                 │   │
│                                  │                                 │   │
│                                  │  LLM: сравнивает answer_text    │   │
│                                  │       с найденными фрагментами  │   │
│                                  └─────────────────────────────────┘   │
│                                           │                             │
│  ┌──────────┐    ┌──────────┐             │                             │
│  │ Respond  │◀───│  Parse   │◀────────────┘                             │
│  │ Webhook  │    │ + Format │                                           │
│  └──────────┘    └──────────┘                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Количество узлов:** 4 (вместо 7+ в v1)

---

## 5. Доступные инструменты MCP

MCP-сервер: `https://guides-mcp.aisystant.workers.dev/mcp`

### 5.1 semantic_search (основной)

Семантический поиск по руководствам. Возвращает релевантные фрагменты с контекстом.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `query` | string | Да | Поисковый запрос (текст вопроса) |
| `lang` | string | Нет | Язык (`ru`, `en`). По умолчанию `ru` |
| `limit` | number | Нет | Количество результатов. По умолчанию 5 |

**Пример вызова (JSON-RPC 2.0):**

```json
{
  "jsonrpc": "2.0",
  "id": "search-1",
  "method": "tools/call",
  "params": {
    "name": "semantic_search",
    "arguments": {
      "query": "Почему важно развивать мышление письмом?",
      "lang": "ru",
      "limit": 3
    }
  }
}
```

**Ожидаемый ответ:**

```json
{
  "jsonrpc": "2.0",
  "id": "search-1",
  "result": {
    "content": [
      {
        "type": "text",
        "text": "[{\"chunk\": \"...\", \"score\": 0.92, \"source\": \"...\"}, ...]"
      }
    ]
  }
}
```

### 5.2 Вспомогательные инструменты

| Инструмент | Назначение | Использование в v2 |
|------------|------------|-------------------|
| `get_guides_list` | Список руководств | Опционально (для валидации course_name) |
| `get_guide_sections` | Секции руководства | Не используется |
| `get_section_content` | Контент секции | Не используется |

---

## 6. Детальное описание узлов

### 6.1 Webhook (POST /check)

**Тип:** `n8n-nodes-base.webhook`
**Путь:** `/check`
**Метод:** POST

Принимает входящий запрос с данными для проверки ДЗ.

**Пример запроса:**

```json
{
  "answer_text": "Мышление письмом важно потому что...",
  "question_text": "Почему важно развивать мышление письмом?",
  "course_name": "Системное саморазвитие",
  "section_name": "Мышление письмом"
}
```

---

### 6.2 Code — Валидация входных данных

**Назначение:** Проверка обязательных полей.

**Обязательные поля (v2):**
- `question_text` — для semantic_search
- `answer_text` — для оценки

**Опциональные поля:**
- `course_name` — контекст для LLM
- `section_name` — контекст для LLM

```javascript
const body = items[0]?.json?.body ?? items[0]?.json ?? {};

const required = ["question_text", "answer_text"];
const missing = required.filter(k => !body[k]);

if (missing.length) {
  return [{
    json: {
      ok: false,
      status: 400,
      body: {
        ok: false,
        error: {
          code: "bad_request",
          message: `Missing required fields: ${missing.join(", ")}`
        }
      }
    }
  }];
}

const request_id = `req_${Date.now()}_${Math.random().toString(16).slice(2)}`;

return [{
  json: {
    ok: true,
    request_id,
    received_at: new Date().toISOString(),
    question_text: body.question_text,
    answer_text: body.answer_text,
    course_name: body.course_name ?? null,
    section_name: body.section_name ?? null,
    debug: !!body.debug
  }
}];
```

---

### 6.3 AI Agent (semantic_search + оценка)

**Тип:** `@n8n/n8n-nodes-langchain.agent`
**Модель:** Claude 3.5 Haiku

**Системный промпт:**

```
Ты — проверяющий ответы стажёров по нормативам из руководств.

АЛГОРИТМ:
1. Вызови semantic_search с query = текст вопроса из пользовательского сообщения
2. Получи релевантные фрагменты из руководства (это норматив)
3. Сравни ответ стажера с нормативом по критериям:
   - Полнота: все ли ключевые идеи из норматива отражены
   - Корректность: нет ли противоречий с нормативом
   - Терминология: используется ли терминология из норматива
   - Структура: логичен ли ответ

ФОРМАТ ОТВЕТА (строго JSON):
{
  "verdict": "accepted" | "needs_revision" | "rejected",
  "score": 0-100,
  "strengths": ["...", "..."],
  "issues": [
    {"criterion": "...", "issue": "...", "suggestion": "..."}
  ],
  "next_step": "..."
}

ПРАВИЛА ОЦЕНКИ:
- 90-100: accepted (ответ полный и корректный)
- 60-89: needs_revision (есть что улучшить)
- 0-59: rejected (ответ не соответствует нормативу)
```

**Пользовательский промпт (шаблон):**

```
Курс: {{course_name}}
Раздел: {{section_name}}

ВОПРОС:
{{question_text}}

ОТВЕТ СТАЖЕРА:
{{answer_text}}

Найди релевантный норматив через semantic_search и оцени ответ.
```

**Подключённые инструменты:**

| Инструмент | Описание |
|------------|----------|
| `semantic_search` | HTTP Request Tool к MCP-серверу |

---

### 6.4 HTTP Request Tool — semantic_search

**Тип:** `n8n-nodes-base.httpRequestTool`
**URL:** `https://guides-mcp.aisystant.workers.dev/mcp`
**Метод:** POST

**Тело запроса:**

```javascript
={{
  ({
    jsonrpc: "2.0",
    id: "search-1",
    method: "tools/call",
    params: {
      name: "semantic_search",
      arguments: {
        query: $fromAI("query"),
        lang: "ru",
        limit: 5
      }
    }
  })
}}
```

---

### 6.5 Code — Parse + Format

**Назначение:** Парсинг ответа LLM и форматирование комментария.

Аналогично v1, но проще — нет проверок на вызов get_guide_sections/get_section_content.

---

### 6.6 Respond to Webhook

Возвращает результат проверки.

```json
{
  "ok": true,
  "request_id": "req_...",
  "checked_at": "2026-01-04T12:00:00.000Z",
  "verdict": "needs_revision",
  "score": 75,
  "comment": "**На доработку** (75/100)...",
  "strengths": [...],
  "issues": [...],
  "next_step": "..."
}
```

---

## 7. Поток данных

```
┌───────────────────────────────────────────────────────────────────────┐
│                           ВХОДНЫЕ ДАННЫЕ                              │
│  question_text (обязательно), answer_text (обязательно)              │
│  course_name (опционально), section_name (опционально)               │
└─────────────────────────────────┬─────────────────────────────────────┘
                                  │
                                  ▼
┌───────────────────────────────────────────────────────────────────────┐
│                    MCP-СЕРВЕР (guides-mcp)                            │
│                                                                       │
│  semantic_search(query=question_text, lang="ru", limit=5)            │
│  → релевантные фрагменты из руководств                               │
└─────────────────────────────────┬─────────────────────────────────────┘
                                  │
                                  ▼
┌───────────────────────────────────────────────────────────────────────┐
│                         CLAUDE LLM                                    │
│                                                                       │
│  Входы:                                                               │
│  - question_text                                                      │
│  - answer_text                                                        │
│  - найденные фрагменты (норматив)                                    │
│                                                                       │
│  Выход: verdict, score, strengths, issues, next_step                 │
└─────────────────────────────────┬─────────────────────────────────────┘
                                  │
                                  ▼
┌───────────────────────────────────────────────────────────────────────┐
│                        ВЫХОДНЫЕ ДАННЫЕ                                │
│  ok, request_id, checked_at, verdict, score, comment, ...            │
└───────────────────────────────────────────────────────────────────────┘
```

---

## 8. Сравнение v1 и v2

| Аспект | v1 | v2 |
|--------|----|----|
| Входные данные | 4 обязательных поля | 2 обязательных + 2 опциональных |
| Резолвинг slug | course_name → guide_slug | **Не нужен** |
| Резолвинг секции | section_name → section_slug | **Не нужен** |
| Вызовы MCP | 2 (sections + content) | **1 (semantic_search)** |
| Поиск норматива | Точное/fuzzy совпадение | **Семантический поиск** |
| Узлы workflow | 7+ | **4** |
| Обработка неточностей | Сложная логика | **Встроена в search** |

---

## 9. Обработка ошибок

| Ситуация | Обработка |
|----------|-----------|
| Нет question_text или answer_text | Ошибка 400 |
| semantic_search не нашёл результатов | verdict: "needs_revision", issue: "normative_not_found" |
| MCP-сервер недоступен | Ошибка 503, retry |
| LLM вернул не-JSON | Fallback-структура с raw_text |

---

## 10. Открытые вопросы

1. **Формат ответа semantic_search** — уточнить структуру возвращаемых чанков
2. **Фильтрация по guide** — нужно ли передавать guide_slug для ограничения поиска?
3. **Scoring релевантности** — как использовать score из semantic_search для валидации?
4. **Кэширование** — нужно ли кэшировать результаты поиска?

---

## 11. Следующие шаги

1. Получить формат ответа `semantic_search` от MCP-сервера
2. Создать n8n workflow по новой архитектуре
3. Протестировать на реальных вопросах
4. Обновить интеграцию с LMS (убрать section_name из обязательных)

---

*Документ описывает архитектуру ДЗ-чекера v2 с использованием семантического поиска.*
