# Проверщик ДЗ (ДЗ-чекер)

Система автоматической проверки домашних заданий стажёров с использованием LLM.

## Назначение

ДЗ-чекер — это агент, который:
- Принимает ответы стажёров из LMS
- Сопоставляет их с нормативными материалами из репозитория
- Оценивает по заданным критериям (рубрикам) с помощью LLM
- Возвращает структурированную обратную связь в LMS

---

## Системы и их взаимодействие

```
                                              ┌────────────────┐
                                              │                │
                                              │  Репозиторий   │
                                              │                │
                                              └────────────────┘
                                                 ▲          │
                                            [A3] │          │ [A4]
                                                 │          ▼
┌────────────────┐  [A1]  ┌────────────────┐  [A2]  ┌────────────────┐  [A5]  ┌────────────────┐
│                │        │                │        │                │        │                │
│    Стажёр      │ ─────▶ │      LMS       │ ─────▶ │   ДЗ-чекер     │ ─────▶ │      LLM       │
│                │        │                │        │                │        │                │
│                │ ◀───── │                │ ◀───── │                │ ◀───── │                │
│                │  [A8]  │                │  [A7]  │                │  [A6]  │                │
└────────────────┘        └────────────────┘        └────────────────┘        └────────────────┘
```

### Роли систем

| Система | Роль | Данные |
|---------|------|--------|
| **Стажёр** | Источник ответа | Текст ответа на вопрос ДЗ |
| **LMS (Aisystant)** | Хранилище и интерфейс | Вопросы, ответы, метаданные, результаты |
| **ДЗ-чекер** | Движок проверки | Логика сборки контекста и запросов |
| **Репозиторий** | Источник норматива | Тексты руководств, рубрики, карта вопросов |
| **LLM** | Исполнитель проверки | Сопоставление ответа с критериями |

---

## Артефакты (пакеты), которые "текут" по процессу

| № | Артефакт | Откуда → Куда | Описание |
|---|----------|---------------|----------|
| A1 | Ответ стажёра | Стажёр → LMS | Текст ответа + действие «Отправить» |
| A2 | Пакет на проверку | LMS → ДЗ-чекер | Ответ + вопрос + метаданные |
| A3 | Запрос контекста | ДЗ-чекер → Репозиторий | Идентификатор вопроса для поиска норматива |
| A4 | Контекст проверки | Репозиторий → ДЗ-чекер | Норматив (фрагмент руководства) + рубрика |
| A5 | Запрос к LLM | ДЗ-чекер → LLM | Промпт с ответом, нормативом и критериями |
| A6 | Результат проверки | LLM → ДЗ-чекер | Вердикт, баллы, замечания, рекомендации |
| A7 | Пакет результата | ДЗ-чекер → LMS | Форматированный комментарий для записи |
| A8 | Отображение результата | LMS → Стажёр | Комментарий ИИ-наставника в интерфейсе |

---

## Процесс проверки по шагам

### Шаг 1. Стажёр отправляет ответ в LMS

**Вход:**
- Текст ответа, набранный стажёром в интерфейсе

**Действие (стажёр в интерфейсе LMS):**
- Ввод текста ответа в поле
- Нажатие кнопки «Отправить»

**Выход → LMS (артефакт A1: Ответ стажёра):**
- Текст ответа
- Идентификатор стажёра
- Идентификатор вопроса
- Время отправки

---

### Шаг 2. LMS отправляет пакет на проверку

**Вход:**
- Артефакт A1 (ответ стажёра)
- Данные вопроса из банка заданий LMS

**Действие (внутри LMS):**
- Сохранение ответа в базу данных
- Извлечение текста вопроса по идентификатору
- Добавление метаданных (курс, урок, раздел)
- Формирование пакета на проверку

**Выход → ДЗ-чекер (артефакт A2: Пакет на проверку):**
- Идентификатор попытки
- Идентификатор стажёра
- Идентификатор вопроса
- Текст вопроса
- Текст ответа
- Идентификаторы курса и урока
- Время отправки

---

### Шаг 3. ДЗ-чекер запрашивает контекст из репозитория

**Вход:**
- Артефакт A2 (пакет на проверку) — идентификатор вопроса

**Действие (внутри ДЗ-чекера):**
- Валидация входящего пакета
- Формирование запроса к репозиторию

**Выход → Репозиторий (артефакт A3: Запрос контекста):**
- Идентификатор вопроса
- Идентификатор курса (опционально)

---

### Шаг 4. Репозиторий возвращает контекст проверки

**Вход:**
- Артефакт A3 (запрос контекста)

**Действие (внутри репозитория):**
- Поиск в карте вопросов по идентификатору вопроса
- Определение пути к разделу руководства
- Загрузка фрагмента текста руководства (норматив)
- Загрузка рубрики проверки (критерии с весами)

**Выход → ДЗ-чекер (артефакт A4: Контекст проверки):**
- Идентификатор вопроса
- Путь к разделу руководства
- Название раздела
- Текст норматива (фрагмент руководства)
- Рубрика проверки:
  - Название рубрики
  - Список критериев (идентификатор, вес, описание)
- Версия материалов

---

### Шаг 5. ДЗ-чекер отправляет запрос в LLM

**Вход:**
- Артефакт A2 (пакет на проверку) — вопрос и ответ
- Артефакт A4 (контекст проверки) — норматив и рубрика

**Действие (внутри ДЗ-чекера):**
- Загрузка системного промпта (роль наставника)
- Загрузка шаблона проверки
- Подстановка данных: вопрос, ответ, норматив, критерии
- Формирование запроса к API

**Выход → LLM (артефакт A5: Запрос к LLM):**
- Системный промпт (роль и принципы проверки)
- Текст вопроса
- Текст ответа студента
- Текст норматива
- Список критериев оценки
- Требования к формату ответа

---

### Шаг 6. LLM возвращает результат проверки

**Вход:**
- Артефакт A5 (запрос к LLM)

**Действие (внутри LLM):**
- Анализ ответа студента
- Сопоставление с нормативом
- Оценка по каждому критерию рубрики
- Формирование структурированного ответа

**Выход → ДЗ-чекер (артефакт A6: Результат проверки):**
- Вердикт (принято / на доработку / не принято)
- Общий балл (0–100)
- Сильные стороны ответа (список)
- Замечания (список):
  - Критерий
  - Что не так
  - Как исправить
- Рекомендация следующего шага
- Баллы по отдельным критериям

---

### Шаг 7. ДЗ-чекер отправляет результат в LMS

**Вход:**
- Артефакт A6 (результат проверки) от LLM
- Артефакт A2 (пакет на проверку) — идентификатор попытки

**Действие (внутри ДЗ-чекера):**
- Проверка полноты результата
- Форматирование в читаемый вид (Markdown)
- Добавление метаданных (модель, время, ссылка на источник)

**Выход → LMS (артефакт A7: Пакет результата):**
- Идентификатор попытки
- Статус (принято / на доработку / не принято)
- Балл
- Текст комментария (форматированный)
- Время проверки
- Идентификатор модели

---

### Шаг 8. LMS показывает результат стажёру

**Вход:**
- Артефакт A7 (пакет результата) от ДЗ-чекера

**Действие (внутри LMS):**
- Поиск попытки по идентификатору
- Запись комментария в поле «Комментарий проверяющего»
- Обновление статуса попытки
- Обновление отображения в интерфейсе

**Выход → Стажёр (артефакт A8: Отображение результата):**
- Стажёр видит комментарий ИИ-наставника в интерфейсе LMS

---

## Что нужно сделать по каждой системе

### LMS (Aisystant)

| Задача | Приоритет | Описание |
|--------|-----------|----------|
| **API отправки на проверку** | MVP | Эндпоинт или webhook для отправки артефакта A2 в ДЗ-чекер |
| **API приёма результата** | MVP | Эндпоинт для записи артефакта A7 в попытку |
| **Поле «Комментарий ИИ»** | MVP | Новое поле в интерфейсе стажёра для отображения A8 |
| **Маппинг question_id** | MVP | Стабильные идентификаторы вопросов для карты вопросов |
| **Триггер автопроверки** | v0.2 | Автоматический вызов ДЗ-чекера при отправке ответа |
| **Статусы проверки** | v0.2 | Отображение: «На проверке ИИ», «Проверено ИИ», «На проверке наставника» |

### ДЗ-чекер (Репозиторий)

| Задача | Приоритет | Описание |
|--------|-----------|----------|
| **CLI-скрипт проверки** | MVP | Приём пакета, возврат результата |
| **Карта вопросов** | MVP | Связь идентификаторов вопросов с руководствами |
| **Рубрики проверки** | MVP | Критерии с весами для разных типов вопросов |
| **Промпты** | MVP | Системный промпт и шаблон проверки |
| **Интеграция с Claude API** | MVP | Вызов API и разбор ответа |
| **Валидация пакетов** | MVP | Проверка входящих и исходящих данных |
| **Webhook-сервер** | v0.2 | HTTP-эндпоинт для приёма запросов от LMS |
| **Очередь задач** | v0.2 | Асинхронная обработка для пакетных проверок |
| **Логирование** | v0.2 | Журнал проверок для аудита и отладки |

### Репозиторий (Контент)

| Задача | Приоритет | Описание |
|--------|-----------|----------|
| **Структура руководств** | MVP | Организация файлов с чёткими разделами |
| **Якоря разделов** | MVP | Заголовки с идентификаторами для точной навигации |
| **Наполнение карты вопросов** | MVP | Связать все вопросы ДЗ с разделами руководств |
| **Версионирование** | v0.2 | Git-теги для отслеживания версий материалов |

### LLM (Внешний сервис)

| Задача | Приоритет | Описание |
|--------|-----------|----------|
| **API-ключ** | MVP | Настройка доступа к Claude API |
| **Fallback-модели** | v0.3 | Резервные модели (GPT-4, Gemini) при недоступности |
| **Ограничение частоты** | v0.2 | Контроль частоты запросов |

---

## Интерфейс для стажёра (третий экран)

```
┌────────────────────────────────────────────────────────────┐
│  Комментарий ИИ-наставника                                │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ✓ Принято (85/100)                    08.09.2025 в 20:35 │
│                                                            │
│  Сильные стороны:                                          │
│  • Верно указано, что любая модель фокусируется на        │
│    определённых свойствах                                  │
│  • Хороший пример с программным продуктом                  │
│                                                            │
│  Замечания:                                                │
│  • Не использован термин «описание системы» —              │
│    рекомендую использовать точную терминологию             │
│                                                            │
│  Следующий шаг:                                            │
│  Попробуйте привести ещё один пример из вашей практики    │
│                                                            │
│  ─────────────────────────────────────────────────────     │
│  Проверено: Claude 3.5 Sonnet                             │
│  По материалам: Глава 1, раздел 1.1                        │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## Ключевые компоненты в репозитории

### Карта вопросов

Связывает идентификаторы вопросов LMS с материалами:

- **Идентификатор вопроса** → путь к файлу руководства
- **Раздел руководства** → конкретный заголовок/якорь
- **Рубрика** → какой набор критериев применять
- **Ключевые слова** → для поиска и проверки

### Рубрики проверки

Критерии с весами для оценки:

- **Понимание концепции:**
  - Ключевая идея (40%)
  - Собственный пример (30%)
  - Терминология (20%)
  - Полнота (10%)

- **Глубокое понимание:**
  - Суть концепции (35%)
  - Аргументация (35%)
  - Связи с другими понятиями (20%)
  - Рефлексия (10%)

---

## Пороги автоматических решений

| Диапазон баллов | Действие |
|-----------------|----------|
| 80–100 | Автоматически принять |
| 60–79 | Отправить наставнику на проверку |
| 0–59 | Автоматически вернуть на доработку |

---

## Реализация

Код агента: `agents-core/homework-checker/`

```
agents-core/homework-checker/
├── README.md                 # Техническая документация
├── manifest.json             # Манифест агента
├── check.py                  # CLI-скрипт проверки
├── config.yaml               # Конфигурация
├── data/
│   ├── questions_map.yaml    # Карта вопросов
│   ├── rubrics.yaml          # Рубрики
│   └── prompts/              # Промпты для LLM
├── schemas/                  # Схемы данных
└── examples/                 # Примеры данных
```

---

## Roadmap

### v0.1 — MVP
- CLI-интерфейс
- Загрузка карты вопросов и рубрик
- Интеграция с Claude API

### v0.2 — Интеграция
- Webhook для LMS
- Пакетная обработка
- Логирование

### v0.3 — Улучшения
- Резервные модели
- Кэширование
- Обратная связь от наставников

### v1.0 — Production
- API для LMS
- Панель мониторинга
- Поддержка нескольких курсов

---

## Открытые вопросы

1. **Формат обмена с LMS** — webhook, REST API, или файловый обмен?
2. **Хранение результатов** — в LMS, в репозитории, или в отдельной БД?
3. **Роль наставника** — всегда проверяет после ИИ или только спорные случаи?
4. **Версионирование материалов** — как отслеживать, по какой версии руководства проверяли?

---

**Статус:** Концепция
**Дата:** 2025-12-22
