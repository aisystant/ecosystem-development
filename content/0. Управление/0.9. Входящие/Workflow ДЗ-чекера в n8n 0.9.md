# Workflow ДЗ-чекера в n8n

> **Статус:** draft
> **Семейство:** F0 (Управление знаниями)
> **Автор:** Claude
> **Дата:** 2026-01-02
> **Версия:** 0.9

## 0. Назначение документа

Описание workflow автоматической проверки домашних заданий (ДЗ-чекер) на платформе n8n.

**Потребители:**
- Архитектор (развёртывание и поддержка)
- Разработчики (интеграция с LMS)
- Операторы (мониторинг и отладка)

**Связанные документы:**
- [[Структура репозитория руководств 0.9]]
- [[Канонический шаблон описания MCP Tools и Resources]]

---

## 1. Общая схема workflow

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Webhook   │───▶│  Валидация  │───▶│ Получение   │───▶│  Поиск      │
│  POST /check│    │   входных   │    │  секций     │    │  секции по  │
│             │    │   данных    │    │  курса      │    │  названию   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │
│  Respond to │◀───│Форматирова- │◀───│   Вызов     │◀──────────┘
│   Webhook   │    │ние ответа   │    │ Claude API  │◀───┐
│             │    │             │    │             │    │
└─────────────┘    └─────────────┘    └─────────────┘    │
                                                          │
                                      ┌─────────────┐    │
                                      │Формирование │────┘
                                      │  промпта    │◀───┐
                                      │             │    │
                                      └─────────────┘    │
                                                          │
                                      ┌─────────────┐    │
                                      │ Получение   │────┘
                                      │ контента    │
                                      │ секции      │
                                      └─────────────┘
```

---

## 2. Детальное описание узлов

### 2.1 Webhook (POST /check)

**Тип:** `n8n-nodes-base.webhook`
**Путь:** `/check`
**Метод:** POST

Принимает входящий запрос с данными для проверки ДЗ.

**Обязательные поля запроса:**

| Поле | Тип | Описание |
|------|-----|----------|
| `answer_text` | string | Ответ стажёра на вопрос ДЗ |
| `question_text` | string | Текст вопроса домашнего задания |
| `course_name` | string | Название курса |
| `section_name` | string | Название раздела курса |

**Пример запроса:**

```json
{
  "answer_text": "Целевая система — это мобильное приложение...",
  "question_text": "Опишите целевую систему вашего проекта",
  "course_name": "Системное саморазвитие",
  "section_name": "О руководстве"
}
```

---

### 2.2 Code in JavaScript — Валидация входных данных

**Назначение:** Проверка наличия обязательных полей и подготовка данных.

**Логика:**
1. Проверяет наличие 4 обязательных полей: `answer_text`, `question_text`, `course_name`, `section_name`
2. При отсутствии полей возвращает ошибку 400 с указанием недостающих полей
3. Добавляет `guide_slug: "systems-self-development"` для привязки к руководству
4. Сохраняет исходные данные в поле `original` для последующего использования

**Выход при ошибке:**

```json
{
  "status": 400,
  "error": "Missing: answer_text, section_name"
}
```

---

### 2.3 HTTP Request — Получение секций курса

**URL:** `https://guides-mcp.aisystant.workers.dev/mcp`
**Метод:** POST
**Content-Type:** `application/json`

**Тело запроса (JSON-RPC 2.0):**

```json
{
  "jsonrpc": "2.0",
  "id": "sections-1",
  "method": "tools/call",
  "params": {
    "name": "get_guide_sections",
    "arguments": { "guide_slug": "systems-self-development" }
  }
}
```

**Ответ содержит:** Массив секций с полями `url`, `title`, `slug`, `order`.

---

### 2.4 Code in JavaScript1 — Поиск секции по названию

**Назначение:** Найти URL секции, соответствующей `section_name` из запроса.

**Логика:**
1. Парсит JSON-массив секций из ответа MCP-сервера
2. Ищет секцию по точному совпадению `title === section_name`
3. Извлекает `section_url` для запроса контента
4. Если секция не найдена — использует первую секцию (fallback)

**Выходные данные:**

```json
{
  "guide_slug": "systems-self-development",
  "section_url": "https://...",
  "sections_count": 5,
  "original": { ... }
}
```

---

### 2.5 HTTP Request1 — Получение контента секции

**URL:** `https://guides-mcp.aisystant.workers.dev/mcp`
**Метод:** POST

**Тело запроса:**

```json
{
  "jsonrpc": "2.0",
  "id": "section-1",
  "method": "tools/call",
  "params": {
    "name": "get_section_content",
    "arguments": { "section_url": "<section_url>" }
  }
}
```

**Ответ содержит:** Текст секции (норматив) — эталонное содержание для проверки ответа.

---

### 2.6 Code in JavaScript2 — Формирование промпта для LLM

**Назначение:** Собрать промпт для проверки ответа стажёра.

**Структура промпта:**

```markdown
## Вопрос домашнего задания
{question_text}

## Ответ стажера
{answer_text}

## Норматив
{normative_text — контент секции}

## Инструкция
Проверь ответ стажера, опираясь на норматив.
Верни JSON: {verdict, score, strengths, issues, next_step}
```

**Выходные данные:**
- `prompt` — готовый промпт для LLM
- `normative_text` — текст норматива для отладки

---

### 2.7 HTTP Request2 — Вызов Claude API

**URL:** `https://api.anthropic.com/v1/messages`
**Метод:** POST

**Заголовки:**
- `x-api-key`: API-ключ Anthropic
- `anthropic-version`: `2023-06-01`

**Тело запроса:**

```json
{
  "model": "claude-3-haiku-20240307",
  "max_tokens": 800,
  "system": "...",
  "messages": [
    {
      "role": "user",
      "content": [
        { "type": "text", "text": "<prompt>" }
      ]
    }
  ]
}
```

**Модель:** `claude-3-haiku-20240307` — быстрая и экономичная модель для массовых проверок.

---

### 2.8 Code in JavaScript3 — Форматирование ответа

**Назначение:** Преобразовать JSON-ответ LLM в читаемый комментарий.

**Ожидаемый формат ответа LLM:**

```json
{
  "verdict": "accepted" | "needs_revision" | "rejected",
  "score": 0-100,
  "strengths": ["Сильная сторона 1", "Сильная сторона 2"],
  "issues": [
    {
      "criterion": "Название критерия",
      "issue": "Описание проблемы",
      "suggestion": "Рекомендация по исправлению"
    }
  ],
  "next_step": "Рекомендуемое следующее действие"
}
```

**Маппинг вердиктов:**

| verdict | Отображение |
|---------|-------------|
| `accepted` | ✓ Принято |
| `needs_revision` | На доработку |
| `rejected` | Не принято |

**Формат выходного комментария:**

```markdown
**✓ Принято** (85/100)

Сильные стороны:
- Правильно определена целевая система
- Указаны границы системы

Замечания:
- полнота: Не указана надсистема
  _Рекомендация: Добавьте описание надсистемы_

Следующий шаг:
Доработать раздел о надсистеме и повторить попытку
```

**Выходные данные:**

```json
{
  "comment": "<отформатированный комментарий>",
  "checked_at": "2026-01-02T12:00:00.000Z",
  "raw_llm": { ... }
}
```

---

### 2.9 Respond to Webhook

**Тип:** `n8n-nodes-base.respondToWebhook`

Возвращает результат проверки вызывающей системе (LMS, Telegram-бот, Apps SDK).

---

## 3. Поток данных

```
                    ┌───────────────────────────────────────────────────┐
                    │                   ВХОДНЫЕ ДАННЫЕ                  │
                    │  answer_text, question_text, course_name,         │
                    │  section_name                                      │
                    └────────────────────────┬──────────────────────────┘
                                             │
                                             ▼
                    ┌───────────────────────────────────────────────────┐
                    │              MCP-СЕРВЕР (guides-mcp)              │
                    │                                                    │
                    │  1. get_guide_sections → список секций            │
                    │  2. get_section_content → текст норматива         │
                    └────────────────────────┬──────────────────────────┘
                                             │
                                             ▼
                    ┌───────────────────────────────────────────────────┐
                    │                  CLAUDE API                        │
                    │                                                    │
                    │  Промпт: вопрос + ответ + норматив                │
                    │  Результат: verdict, score, strengths, issues     │
                    └────────────────────────┬──────────────────────────┘
                                             │
                                             ▼
                    ┌───────────────────────────────────────────────────┐
                    │                 ВЫХОДНЫЕ ДАННЫЕ                    │
                    │  comment (форматированный), checked_at, raw_llm   │
                    └───────────────────────────────────────────────────┘
```

---

## 4. Интеграции

### 4.1 MCP-сервер guides-mcp

**URL:** `https://guides-mcp.aisystant.workers.dev/mcp`
**Протокол:** JSON-RPC 2.0

**Используемые инструменты:**

| Инструмент | Назначение |
|------------|------------|
| `get_guide_sections` | Получить список секций руководства |
| `get_section_content` | Получить содержимое секции (норматив) |

### 4.2 Claude API (Anthropic)

**URL:** `https://api.anthropic.com/v1/messages`
**Модель:** `claude-3-haiku-20240307`
**Параметры:** `max_tokens: 800`

---

## 5. Обработка ошибок

| Ситуация | Обработка |
|----------|-----------|
| Отсутствуют обязательные поля | Ошибка 400 с перечислением полей |
| Секция не найдена | Fallback на первую секцию |
| MCP-сервер возвращает ошибку | Пробрасывается в ответ |
| LLM вернул не-JSON | Создаётся структура с `raw_text` |
| Норматив не найден | Подставляется "(норматив не найден)" |

---

## 6. Возможные улучшения

1. **Кэширование секций** — хранить список секций для уменьшения запросов к MCP
2. **Retry-логика** — повторные попытки при сетевых ошибках
3. **Логирование** — сохранение истории проверок для аналитики
4. **Расширение guide_slug** — поддержка нескольких руководств (не только systems-self-development)
5. **Webhook-аутентификация** — добавить проверку токена для защиты эндпоинта
6. **Batch-проверка** — возможность проверять несколько ответов за один запрос

---

## 7. Примечания по безопасности

- API-ключ Anthropic хранится в параметрах узла HTTP Request2
- Рекомендуется вынести ключ в переменные окружения n8n
- Webhook не имеет аутентификации — требуется добавить проверку при продуктовом использовании

---

*Документ создан для команды разработки экосистемы развития.*
