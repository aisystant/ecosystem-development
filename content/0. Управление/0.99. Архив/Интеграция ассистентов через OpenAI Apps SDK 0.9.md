---
type: adr
status: draft
version: 0.3
created: 2025-12-27
updated: 2025-12-30
layer: architecture
scope: ecosystem
related:
  - "Архитектура доступа ИИ к данным экосистемы 0.9"
  - "FSM-архитектура ИИ-ассистентов 3.2"
  - "Описание ИИ-ассистента Проводник (Ассистент Ученика) 3.2"
description: "ADR: интеграция MCP-серверов экосистемы через OpenAI Apps SDK для доступа пользователей через ChatGPT"
---

# Интеграция MCP-серверов с LLM через OpenAI Apps SDK

> **ADR (Architecture Decision Record):** Архитектурное решение для предоставления пользователям доступа к ИИ-ассистентам экосистемы через интерфейс ChatGPT с использованием OpenAI Apps SDK.

---

## 0. Резюме решения

**Проблема:** Как дать пользователю простой доступ к ИИ-ассистентам экосистемы без необходимости настраивать собственный LLM-клиент?

**Решение:** Использовать **OpenAI Apps SDK** — платформу для публикации приложений внутри ChatGPT. LLM (GPT) получает доступ ко всем MCP-серверам напрямую.

**Ключевой принцип:**
```
LLM вызывает любой MCP напрямую
Все MCP на одном уровне, независимы друг от друга
```

---

## 1. Контекст

### 1.1 Архитектура MCP-серверов

Экосистема использует два типа MCP-серверов:

| Тип | Назначение | Примеры |
|-----|------------|---------|
| **MCP-app** | Логика ИИ-ассистентов, FSM-инструкции | fsm-mcp |
| **MCP-data** | Доступ к данным | dt-mcp, guides-mcp, exercises-mcp |

**Ключевое:** Все MCP на одном уровне. LLM вызывает каждый MCP напрямую. MCP не зависят друг от друга.

### 1.2 Текущее состояние

| Компонент | Статус | Расположение |
|-----------|--------|--------------|
| **fsm-mcp** (MCP-app) | Работает | [github.com/aisystant/fsm-mcp](https://github.com/aisystant/fsm-mcp) |
| **dt-mcp** (MCP-data) | Планируется | — |
| **guides-mcp** (MCP-data) | Планируется | — |
| **exercises-mcp** (MCP-data) | Планируется | — |

### 1.3 Архитектура подключения через Apps SDK

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            ChatGPT / GPT                                    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Apps SDK                                    │   │
│  │                                                                     │   │
│  │  Подключает все MCP-серверы на одном уровне                        │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                    GPT вызывает любой MCP напрямую                         │
│                                    │                                        │
└────────────────────────────────────┼────────────────────────────────────────┘
                                     │
         ┌───────────────────────────┼───────────────────────────┐
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│    fsm-mcp      │      │    dt-mcp       │      │  guides-mcp     │
│   (MCP-app)     │      │   (MCP-data)    │      │   (MCP-data)    │
│                 │      │                 │      │                 │
│ get_instruction │      │ dt.get_progress │      │ guides.search   │
│                 │      │ dt.get_goals    │      │ guides.get      │
└─────────────────┘      └─────────────────┘      └─────────────────┘
         │                           │                           │
         │                           ▼                           │
         │               ┌─────────────────┐                     │
         │               │  Digital Twin   │                     │
         │               │   (SurrealDB)   │                     │
         │               └─────────────────┘                     │
         │                                                       │
         └───────────────────────────────────────────────────────┘
                     Все MCP независимы друг от друга
```

---

## 2. Конфигурация Apps SDK

### 2.1 Подключение всех MCP

Apps SDK позволяет подключить несколько MCP-серверов. GPT видит все инструменты всех MCP.

```json
{
  "mcpServers": {
    "fsm-mcp": {
      "url": "https://fsm-mcp.aisystant.workers.dev/mcp"
    },
    "dt-mcp": {
      "url": "https://dt-mcp.aisystant.workers.dev/mcp"
    },
    "guides-mcp": {
      "url": "https://guides-mcp.aisystant.workers.dev/mcp"
    },
    "exercises-mcp": {
      "url": "https://exercises-mcp.aisystant.workers.dev/mcp"
    }
  }
}
```

### 2.2 Какие инструменты видит GPT

| MCP-сервер | Инструменты | Назначение |
|------------|-------------|------------|
| **fsm-mcp** | `get_instruction(state?)` | Получить инструкции FSM-состояния |
| **dt-mcp** | `dt.get_progress()`, `dt.get_goals()`, `dt.save_*` | Работа с цифровым двойником |
| **guides-mcp** | `guides.search()`, `guides.get()` | Поиск и чтение руководств |
| **exercises-mcp** | `exercises.get()`, `exercises.check()` | Работа с упражнениями |

### 2.3 Как GPT выбирает инструмент

GPT выбирает инструмент по контексту запроса пользователя:

| Запрос пользователя | GPT вызывает | Почему |
|---------------------|--------------|--------|
| "Подведи итоги недели" | `get_instruction()` → `dt.get_week_summary()` | Сложный сценарий, нужны FSM-инструкции |
| "Найди руководство по мышлению" | `guides.search()` | Простой запрос данных |
| "Какой у меня прогресс?" | `dt.get_progress()` | Простой запрос данных |

---

## 3. Сценарии взаимодействия

### 3.1 Сценарий с FSM-логикой

```
Пользователь: "Подведи итоги недели"

1. GPT вызывает get_instruction() → fsm-mcp
2. fsm-mcp возвращает инструкции для состояния weekly_reflection
3. GPT вызывает dt.get_week_summary() → dt-mcp (по инструкции)
4. dt-mcp возвращает данные
5. GPT формирует структурированный ответ по инструкции
```

### 3.2 Сценарий прямого запроса к данным

```
Пользователь: "Найди руководство по системному мышлению"

1. GPT вызывает guides.search("системное мышление") → guides-mcp напрямую
2. guides-mcp возвращает список руководств
3. GPT формирует ответ
```

### 3.3 Диаграмма последовательности

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  ChatGPT    │      │    GPT      │      │  fsm-mcp    │      │   dt-mcp    │
└──────┬──────┘      └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
       │                    │                    │                    │
       │                    │                    │                    │
       │  Вариант 1: MCP-app + MCP-data          │                    │
       │  ─────────────────────────────          │                    │
       │                    │                    │                    │
       │                    │  get_instruction() │                    │
       │                    │───────────────────>│                    │
       │                    │<───────────────────│ (инструкции)       │
       │                    │                    │                    │
       │                    │  dt.get_week_summary() (по инструкции)  │
       │                    │────────────────────────────────────────>│
       │                    │<────────────────────────────────────────│
       │                    │                    │                    │
       │                    │                    │                    │
       │  Вариант 2: напрямую к MCP-data         │                    │
       │  ──────────────────────────────         │                    │
       │                    │                    │                    │
       │                    │  dt.get_progress() │                    │
       │                    │────────────────────────────────────────>│
       │                    │<────────────────────────────────────────│
       │                    │                    │                    │
```

---

## 4. Авторизация

### 4.1 Поток авторизации

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  1. Пользователь входит через ChatGPT                                      │
│                                                                             │
│  2. OAuth авторизация через Aisystant Identity                             │
│     • Пользователь логинится                                               │
│     • Получает access_token                                                │
│                                                                             │
│  3. Токен передаётся в каждый MCP-запрос                                   │
│     • GPT → любой MCP (Authorization: Bearer <token>)                      │
│                                                                             │
│  4. Каждый MCP проверяет токен                                             │
│     • Валидность токена                                                    │
│     • Извлекает user_id                                                    │
│     • Возвращает только данные этого пользователя                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Важно: MCP не зависят друг от друга

- Каждый MCP получает токен напрямую от Apps SDK
- MCP не передают токены друг другу
- Каждый MCP самостоятельно проверяет авторизацию

---

## 5. UI-компонент (опционально)

### 5.1 Что это

Apps SDK позволяет добавить UI-компонент — HTML-страницу в iframe ChatGPT.

**Назначение:**
- Визуализация прогресса ученика
- Интерактивные элементы (карточки, чекбоксы)
- Отображение данных из цифрового двойника

### 5.2 Структура

```
github.com/aisystant/fsm-mcp/
├── src/
│   ├── index.ts              MCP-сервер
│   └── widget/               UI-компонент
│       ├── index.html
│       ├── styles.css
│       └── app.js
```

### 5.3 Взаимодействие UI с GPT

```javascript
// Получение данных от инструмента
const data = window.openai?.toolOutput?.structuredContent;

// Вызов инструмента из UI
await window.openai.callTool('get_instruction', { state: 'weekly_reflection' });
```

---

## 6. Регистрация в OpenAI

### 6.1 Параметры коннектора

| Поле | Значение |
|------|----------|
| Name | Aisystant Student Guide |
| MCP URLs | fsm-mcp, dt-mcp, guides-mcp, exercises-mcp |
| Description | Помогает стать проактивным учеником |
| Category | Education, Productivity |

### 6.2 Требования

| Требование | Статус |
|------------|--------|
| Верифицированный аккаунт разработчика | Требуется |
| Developer Mode в ChatGPT | Включить |
| HTTPS для всех MCP-эндпоинтов | ✓ (Cloudflare Workers) |

---

## 7. Безопасность

### 7.1 Принципы

- **Минимальные данные:** Каждый MCP возвращает только необходимое
- **Изоляция:** UI работает в sandbox OpenAI
- **Независимость:** MCP не зависят друг от друга

### 7.2 Content Security Policy

```json
{
  "connect_domains": [
    "fsm-mcp.aisystant.workers.dev",
    "dt-mcp.aisystant.workers.dev",
    "guides-mcp.aisystant.workers.dev",
    "exercises-mcp.aisystant.workers.dev"
  ]
}
```

---

## 8. План реализации

### Этап 1: Базовая интеграция

| # | Задача | Результат |
|---|--------|-----------|
| 1.1 | Включить Developer Mode в ChatGPT | Доступ к созданию коннекторов |
| 1.2 | Создать коннектор с fsm-mcp | Тестовое приложение |
| 1.3 | Протестировать get_instruction | Работающий FSM |

### Этап 2: Добавление MCP-data

| # | Задача | Результат |
|---|--------|-----------|
| 2.1 | Создать dt-mcp | MCP-сервер цифрового двойника |
| 2.2 | Создать guides-mcp | MCP-сервер руководств |
| 2.3 | Подключить к Apps SDK | Все инструменты доступны GPT |

### Этап 3: UI-компонент (опционально)

| # | Задача | Результат |
|---|--------|-----------|
| 3.1 | Создать виджет прогресса | UI-компонент |
| 3.2 | Связать с инструментами | outputTemplate |

### Этап 4: Публикация

| # | Задача | Результат |
|---|--------|-----------|
| 4.1 | Подготовить метаданные | Описание, иконка |
| 4.2 | Отправить на ревью | Заявка в OpenAI |

---

## 9. Альтернативные каналы

Apps SDK — один из каналов доступа. Архитектура поддерживает другие:

```
                    Пользователи
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
   ┌──────────┐   ┌──────────┐   ┌──────────┐
   │ ChatGPT  │   │ Telegram │   │ Web App  │
   │ Apps SDK │   │   Bot    │   │  + LLM   │
   └────┬─────┘   └────┬─────┘   └────┬─────┘
        │              │              │
        └──────────────┼──────────────┘
                       │
                       ▼
        ┌──────────────────────────────────┐
        │     Все MCP на одном уровне      │
        │                                  │
        │  fsm-mcp  dt-mcp  guides-mcp     │
        └──────────────────────────────────┘
```

Все каналы используют одни и те же MCP-серверы.

---

## 10. Связь с общей архитектурой

Этот документ описывает конкретную реализацию интеграции через Apps SDK.

Общая архитектура доступа ИИ к данным описана в **[[Архитектура доступа ИИ к данным экосистемы 0.9]]**.

| Этот документ | Общая архитектура |
|---------------|-------------------|
| Apps SDK как интерфейс | Интерфейсы (ChatGPT, Telegram, Web) |
| Конфигурация MCP | Все MCP на одном уровне |
| OAuth авторизация | Авторизация через Aisystant Identity |

---

## 11. Источники

### Официальная документация OpenAI Apps SDK

- [Apps SDK Overview](https://developers.openai.com/apps-sdk)
- [Quickstart Guide](https://developers.openai.com/apps-sdk/quickstart)
- [API Reference](https://developers.openai.com/apps-sdk/reference)
- [Example Apps](https://github.com/openai/openai-apps-sdk-examples)

### Внутренние документы

- [[Архитектура доступа ИИ к данным экосистемы 0.9]] — общая архитектура
- [[FSM-архитектура ИИ-ассистентов 3.2]] — архитектура ассистентов
- [[Описание ИИ-ассистента Проводник (Ассистент Ученика) 3.2]] — описание Проводника

---

## 12. Связанные документы

- **[[Архитектура доступа ИИ к данным экосистемы 0.9]]** — общая архитектура доступа ИИ к данным
- [[FSM-архитектура ИИ-ассистентов 3.2]] — ADR: архитектура FSM
- [[Описание ИИ-ассистента Проводник (Ассистент Ученика) 3.2]] — целевой ассистент
- [github.com/aisystant/fsm-mcp](https://github.com/aisystant/fsm-mcp) — репозиторий fsm-mcp

---

## Changelog

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-27 | v0.1 | Документ создан |
| 2025-12-29 | v0.2 | Добавлена связь с общей архитектурой |
| 2025-12-30 | v0.3 | Полное обновление: все MCP на одном уровне, убраны server-to-server вызовы, упрощена архитектура |
