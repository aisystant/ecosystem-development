---
type: adr
status: draft
version: 0.2
created: 2025-12-27
layer: architecture
scope: ecosystem
related:
  - "Архитектура доступа ИИ к данным экосистемы 0.9"
  - "FSM-архитектура ИИ-ассистентов 3.2"
  - "Описание ИИ-ассистента Проводник (Ассистент Ученика) 3.2"
  - "Общая архитектура ИТ-платформы 3.2"
description: "ADR: интеграция ИИ-ассистентов экосистемы через OpenAI Apps SDK для доступа пользователей через ChatGPT"
---

# Интеграция ассистентов через OpenAI Apps SDK

> **ADR (Architecture Decision Record):** Архитектурное решение для предоставления пользователям доступа к ИИ-ассистентам экосистемы через интерфейс ChatGPT с использованием OpenAI Apps SDK.

---

## 0. Резюме решения

**Проблема:** Как дать любому пользователю простой доступ к Ассистенту Ученика (Проводнику) без необходимости настраивать собственный LLM-клиент?

**Решение:** Использовать **OpenAI Apps SDK** — платформу для публикации приложений внутри ChatGPT. Приложение состоит из MCP-сервера (уже есть: `fsm-mcp`) и веб-компонента (UI), который отображается в ChatGPT.

**Ключевой принцип:**
```
ChatGPT Apps SDK = MCP-сервер + UI-компонент + Коннектор
```

---

## 1. Контекст

### 1.1 Текущее состояние

У нас уже есть:

| Компонент | Статус | Расположение |
|-----------|--------|--------------|
| **MCP-сервер fsm-mcp** | Работает | [github.com/aisystant/fsm-mcp](https://github.com/aisystant/fsm-mcp) |
| **MCP-эндпоинт** | Развёрнут | `https://fsm-mcp.aisystant.workers.dev/mcp` |
| **Состояния FSM** | Готовы | `/states/` в fsm-mcp |
| **Системный промпт** | Готов | `/instructions/` в fsm-mcp |

### 1.2 Что требуется добавить

Для публикации в ChatGPT через Apps SDK необходимо:

1. **UI-компонент** — веб-страница, отображаемая в iframe ChatGPT
2. **Расширение MCP-сервера** — регистрация UI-ресурса и метаданных
3. **Коннектор в OpenAI** — регистрация приложения в Developer Platform

### 1.3 Архитектура OpenAI Apps SDK

```
┌─────────────────────────────────────────────────────────────────┐
│                         ChatGPT                                  │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐  │
│  │  Диалог с LLM   │◄──►│  Apps Runtime   │◄──►│  UI iframe  │  │
│  └────────┬────────┘    └────────┬────────┘    └──────┬──────┘  │
│           │                      │                     │         │
└───────────┼──────────────────────┼─────────────────────┼─────────┘
            │                      │                     │
            ▼                      ▼                     ▼
┌───────────────────────────────────────────────────────────────┐
│                      MCP-СЕРВЕР (fsm-mcp)                      │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────────────┐│
│  │  Инструменты  │ │  UI Resource  │ │  Метаданные приложения││
│  │get_instruction│ │   (HTML/JS)   │ │  (OpenAI-specific)    ││
│  └───────────────┘ └───────────────┘ └───────────────────────┘│
│            │                                                   │
│            ▼                                                   │
│  ┌───────────────────────────────────────────────────────────┐│
│  │              Цифровой двойник (опционально)               ││
│  │              через отдельный MCP-сервер                    ││
│  └───────────────────────────────────────────────────────────┘│
└───────────────────────────────────────────────────────────────┘
```

---

## 2. Компоненты решения

### 2.1 MCP-сервер (уже есть, требует расширения)

**Репозиторий:** `github.com/aisystant/fsm-mcp`

**Текущие возможности:**
- Инструмент `get_instruction(state?)` — выдаёт инструкции FSM-состояний
- Эндпоинт `/mcp` — точка подключения по MCP

**Что нужно добавить:**

| Элемент | Назначение | Файл/место |
|---------|------------|------------|
| UI Resource | Регистрация веб-компонента | `src/index.ts` |
| Tool metadata | Аннотации для Apps SDK | `src/tools.ts` |
| Widget config | CSP, домены, описание | `src/config.ts` |

### 2.2 UI-компонент (новый)

**Что это:** HTML/CSS/JS страница, отображаемая в iframe внутри ChatGPT.

**Назначение:**
- Визуализация прогресса ученика (ступень, недельный план)
- Интерактивные элементы (карточки заданий, чекбоксы выполнения)
- Отображение данных из цифрового двойника (если подключён)

**Технологии:** Любой фреймворк (React, Vue, vanilla JS) или Apps SDK UI Library.

**Взаимодействие с ChatGPT:**

```javascript
// Получение данных от инструмента
const toolOutput = window.openai.toolOutput;

// Вызов инструмента из UI
await window.openai.callTool('get_instruction', { state: 'weekly_reflection' });

// Загрузка файла пользователем
const { fileId } = await window.openai.uploadFile(file);
```

### 2.3 Коннектор (регистрация в OpenAI)

**Что это:** Запись в OpenAI Developer Platform, связывающая приложение с ChatGPT.

**Параметры коннектора:**

| Поле | Значение |
|------|----------|
| Name | Aisystant Student Guide |
| MCP URL | `https://fsm-mcp.aisystant.workers.dev/mcp` |
| Description | Помогает стать проактивным учеником |
| Category | Education, Productivity |

---

## 3. Рабочие продукты и их расположение

### 3.1 Карта рабочих продуктов

```
github.com/aisystant/fsm-mcp/
├── src/
│   ├── index.ts              [ИЗМЕНИТЬ] Добавить UI resource
│   ├── tools.ts              [ИЗМЕНИТЬ] Добавить Apps SDK meta
│   ├── config.ts             [СОЗДАТЬ]  Конфигурация Apps SDK
│   └── widget/               [СОЗДАТЬ]  UI-компонент
│       ├── index.html
│       ├── styles.css
│       └── app.js
│
├── assets/                   [СОЗДАТЬ]  Скомпилированные UI-файлы
│   └── widget.html           (inline CSS/JS)
│
└── docs/
    └── apps-sdk-setup.md     [СОЗДАТЬ]  Инструкция по настройке
```

### 3.2 Детальное описание продуктов

#### 3.2.1 Расширение MCP-сервера (`src/index.ts`)

**Что добавить:**

```typescript
// Регистрация UI-ресурса
server.resource({
  uri: 'widget://student-guide',
  name: 'Student Progress Widget',
  mimeType: 'text/html+skybridge',
  async read() {
    return { contents: await loadWidget() };
  }
});

// Метаданные инструмента для Apps SDK
const getInstructionTool = {
  name: 'get_instruction',
  description: 'Получить инструкции для текущего состояния диалога',
  inputSchema: { /* ... */ },
  _meta: {
    'openai/outputTemplate': 'widget://student-guide',
    'openai/widgetAccessible': true,
    'openai/visibility': 'public',
    'openai/toolInvocation': {
      invoking: 'Анализирую запрос...',
      invoked: 'Инструкции получены'
    }
  }
};
```

#### 3.2.2 UI-компонент (`src/widget/`)

**Минимальная структура:**

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    .stage-card { /* стили карточки ступени */ }
    .task-list { /* стили списка задач */ }
  </style>
</head>
<body>
  <div id="app">
    <div class="stage-card">
      <h2>Ваша ступень: <span id="stage">—</span></h2>
      <p id="stage-description"></p>
    </div>
    <div class="task-list" id="tasks"></div>
  </div>

  <script>
    // Получение данных от инструмента
    const data = window.openai?.toolOutput?.structuredContent;

    if (data) {
      document.getElementById('stage').textContent = data.stage;
      document.getElementById('stage-description').textContent = data.description;
      renderTasks(data.tasks);
    }

    function renderTasks(tasks) {
      const container = document.getElementById('tasks');
      tasks.forEach(task => {
        const el = document.createElement('div');
        el.className = 'task-item';
        el.innerHTML = `<input type="checkbox"> ${task.title}`;
        container.appendChild(el);
      });
    }
  </script>
</body>
</html>
```

#### 3.2.3 Конфигурация Apps SDK (`src/config.ts`)

```typescript
export const appsSDKConfig = {
  // Описание виджета для модели
  widgetDescription: 'Интерактивная панель прогресса ученика. ' +
    'Показывает текущую ступень, задачи на неделю, статистику.',

  // Оформление
  widgetPrefersBorder: true,

  // Политика безопасности
  widgetCSP: {
    connect_domains: ['fsm-mcp.aisystant.workers.dev'],
    resource_domains: [],
    frame_domains: [],
    redirect_domains: []
  },

  // Домен виджета (опционально)
  widgetDomain: 'aisystant-widget.oaiusercontent.com'
};
```

#### 3.2.4 Документация (`docs/apps-sdk-setup.md`)

Содержание:
- Предварительные требования
- Шаги настройки Developer Mode
- Создание коннектора
- Тестирование
- Подготовка к публикации

---

## 4. План реализации

### Этап 1: Подготовка MCP-сервера

| # | Задача | Результат |
|---|--------|-----------|
| 1.1 | Добавить конфигурацию Apps SDK | `src/config.ts` |
| 1.2 | Расширить инструменты метаданными | `_meta` в `get_instruction` |
| 1.3 | Добавить возврат `structuredContent` | JSON-данные для UI |

### Этап 2: Создание UI-компонента

| # | Задача | Результат |
|---|--------|-----------|
| 2.1 | Создать базовую структуру виджета | `src/widget/index.html` |
| 2.2 | Добавить стили | `src/widget/styles.css` |
| 2.3 | Реализовать логику отображения | `src/widget/app.js` |
| 2.4 | Настроить сборку (Vite/esbuild) | `assets/widget.html` |

### Этап 3: Регистрация UI-ресурса

| # | Задача | Результат |
|---|--------|-----------|
| 3.1 | Добавить resource в MCP-сервер | `server.resource(...)` |
| 3.2 | Связать инструмент с виджетом | `outputTemplate` |
| 3.3 | Задеплоить на Cloudflare Workers | Обновлённый эндпоинт |

### Этап 4: Тестирование

| # | Задача | Результат |
|---|--------|-----------|
| 4.1 | Включить Developer Mode в ChatGPT | Доступ к созданию коннекторов |
| 4.2 | Создать коннектор | Тестовое приложение |
| 4.3 | Протестировать сценарии | Отчёт о тестировании |

### Этап 5: Публикация

| # | Задача | Результат |
|---|--------|-----------|
| 5.1 | Подготовить метаданные для каталога | Описание, иконка, категории |
| 5.2 | Отправить на ревью | Заявка в OpenAI |
| 5.3 | Доработать по замечаниям | Финальная версия |

---

## 5. Интеграция с цифровым двойником

### 5.1 Текущий подход (без ЦД)

Проводник работает в режиме `no_dt_mode`:
- Задаёт вопросы пользователю
- Не сохраняет данные между сессиями
- Полностью функционален, но без персистентности

### 5.2 Будущий подход (с ЦД)

```
┌─────────────────────────────────────────────────────────────────┐
│                         ChatGPT + Apps SDK                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    MCP-сервер fsm-mcp                       ││
│  │                                                              ││
│  │  get_instruction() ◄──── FSM-логика ─────► states/*.md      ││
│  │         │                                                    ││
│  │         ▼                                                    ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │            MCP-клиент к Цифровому двойнику              │││
│  │  │                                                          │││
│  │  │  dt_load_profile()  dt_load_week()  dt_save_reflection()│││
│  │  └─────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                   │
└──────────────────────────────┼───────────────────────────────────┘
                               ▼
                 ┌─────────────────────────────┐
                 │    MCP-сервер ЦД (Twin)     │
                 │                              │
                 │  Идентификация пользователя │
                 │  Хранение данных профиля    │
                 │  Недельные планы и рефлексии│
                 └─────────────────────────────┘
```

**Примечание:** Организация MCP-сервера цифрового двойника и идентификации — тема отдельного ADR.

---

## 5.3 Связь с общей архитектурой доступа ИИ

Этот документ описывает **конкретную реализацию** для ИИ-системы МИМ "Проводник". Общая архитектура доступа ИИ к данным экосистемы описана в **[[Архитектура доступа ИИ к данным экосистемы 0.9]]**.

### Место этого решения в общей архитектуре

| Компонент этого ADR | Слой общей архитектуры | Роль |
|---------------------|------------------------|------|
| ChatGPT + Apps SDK | **Интерфейсы** | Один из клиентов (наряду с Telegram, Web App) |
| `fsm-mcp` | **Managed Agent Runtime** | Реализация FSM-логики для ИИ-систем МИМ |
| MCP ЦД (Twin) | **DigitalTwin MCP → Data Assets** | Доступ к персональным данным через MCP Gateway |
| CSP, изоляция | **Policy Engine + MCP Gateway** | Enforcement политик доступа |

### Что добавляет общая архитектура

Общая архитектура расширяет этот подход:

1. **Агенты сообщества** — участники экосистемы могут создавать своих агентов (например, "Траектория (Иван)")
2. **Consent Service** — явное управление согласиями пользователей на доступ к их данным
3. **Маркетплейс агентов** — единый реестр всех ИИ-систем (и МИМ, и сообщества)
4. **Единый Policy Engine** — централизованное управление политиками доступа

### Рекомендация

При развитии `fsm-mcp` учитывать требования общей архитектуры:
- Интеграция с Consent Service для расширенных scopes
- Логирование в единый Audit Log
- Совместимость с MCP Gateway

---

## 6. Требования к инфраструктуре

### 6.1 Cloudflare Workers (уже есть)

- **Runtime:** Workers (V8 isolates)
- **Эндпоинт:** `/mcp`
- **Статика:** `/assets/` для UI-компонента

### 6.2 OpenAI Developer Platform

- **Аккаунт:** Требуется верифицированный аккаунт разработчика
- **Developer Mode:** Включить в Settings → Apps & Connectors → Advanced
- **Коннектор:** Создать и настроить

### 6.3 Домены и сертификаты

| Домен | Назначение |
|-------|------------|
| `fsm-mcp.aisystant.workers.dev` | MCP-эндпоинт |
| `*.oaiusercontent.com` | UI-виджет (sandbox OpenAI) |

---

## 7. Безопасность и приватность

### 7.1 Принципы

- **Минимальные данные:** Запрашивать только необходимое
- **Согласие:** Явное разрешение на доступ к ЦД
- **Изоляция:** UI работает в sandbox OpenAI
- **Аудит:** Логирование операций

### 7.2 Content Security Policy

```json
{
  "connect_domains": ["fsm-mcp.aisystant.workers.dev"],
  "resource_domains": [],
  "frame_domains": [],
  "redirect_domains": []
}
```

---

## 8. Мониторинг и аналитика

### 8.1 Метрики для отслеживания

| Метрика | Источник |
|---------|----------|
| Количество активаций приложения | OpenAI Analytics |
| Вызовы `get_instruction` | Логи Workers |
| Переходы между состояниями | Логи FSM |
| Ошибки UI-компонента | Sentry/LogFlare |

### 8.2 User Agent и локаль

Apps SDK передаёт:
- `_meta["openai/userAgent"]` — для аналитики
- `_meta["openai/locale"]` — для локализации
- `_meta["openai/subject"]` — анонимный ID пользователя

---

## 9. Ограничения и риски

### 9.1 Известные ограничения

| Ограничение | Влияние | Митигация |
|-------------|---------|-----------|
| Apps SDK в preview | Возможны изменения API | Следить за changelog |
| Доступ только Business/Enterprise/Edu | Ограниченная аудитория | Мониторить расширение доступа |
| UI в sandbox | Ограниченные возможности | Использовать разрешённые домены |

### 9.2 Риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Отклонение при ревью | Средняя | Высокое | Следовать гайдлайнам, тестировать |
| Изменение API | Высокая | Среднее | Версионирование, абстракции |
| Проблемы с latency | Низкая | Среднее | Кэширование, оптимизация |

---

## 10. Альтернативы

### 10.1 Рассмотренные альтернативы

| Альтернатива | Плюсы | Минусы | Решение |
|--------------|-------|--------|---------|
| Telegram Bot | Простота, широкая аудитория | Ограниченный UI, нет LLM | Дополнительный канал |
| Отдельный веб-интерфейс | Полный контроль | Нужен отдельный LLM-провайдер | Параллельно |
| Claude.ai Projects | Встроенный MCP | Меньше аудитория | Дополнительный канал |
| **OpenAI Apps SDK** | Огромная аудитория, нативный UI | Preview, ограничения | **Выбрано** |

### 10.2 Стратегия каналов

```
                    Пользователи
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
   ┌──────────┐   ┌──────────┐   ┌──────────┐
   │ ChatGPT  │   │ Telegram │   │ Web App  │
   │ Apps SDK │   │   Bot    │   │  + LLM   │
   └────┬─────┘   └────┬─────┘   └────┬─────┘
        │              │              │
        └──────────────┼──────────────┘
                       ▼
              ┌──────────────────┐
              │  MCP-сервер      │
              │  fsm-mcp         │
              └────────┬─────────┘
                       ▼
              ┌──────────────────┐
              │ Цифровой двойник │
              └──────────────────┘
```

---

## 11. Источники

### Официальная документация OpenAI Apps SDK

- [Apps SDK Overview](https://developers.openai.com/apps-sdk) — главная страница документации
- [Quickstart Guide](https://developers.openai.com/apps-sdk/quickstart) — быстрый старт
- [API Reference](https://developers.openai.com/apps-sdk/reference) — справочник API
- [Example Apps](https://github.com/openai/openai-apps-sdk-examples) — примеры приложений
- [Introducing Apps in ChatGPT](https://openai.com/index/introducing-apps-in-chatgpt/) — анонс платформы

### Внутренние документы

- [[FSM-архитектура ИИ-ассистентов 3.2]] — архитектура ассистентов
- [[Описание ИИ-ассистента Проводник (Ассистент Ученика) 3.2]] — описание Проводника
- [[Общая архитектура ИТ-платформы 3.2]] — место Apps SDK в архитектуре

---

## 12. Связанные документы

- **[[Архитектура доступа ИИ к данным экосистемы 0.9]]** — общая архитектура доступа ИИ к данным (обобщение этого ADR)
- [[FSM-архитектура ИИ-ассистентов 3.2]] — ADR: архитектура FSM
- [[Описание ИИ-ассистента Проводник (Ассистент Ученика) 3.2]] — целевой ассистент
- [[Общая архитектура ИТ-платформы 3.2]] — общая архитектура платформы
- [[Карта ИТ-систем 3.2]] — реестр ИТ-систем
- [github.com/aisystant/fsm-mcp](https://github.com/aisystant/fsm-mcp) — репозиторий реализации

---

## Changelog

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-27 | v0.1 | Документ создан. Статус: proposed |
| 2025-12-29 | v0.2 | Добавлена связь с общей архитектурой доступа ИИ |
