# Описание архитектуры: Apps SDK + MCP + Цифровой двойник

## Обзор архитектуры

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│    ChatGPT      │────▶│   MCP-сервер    │────▶│   Цифровой      │
│  (Apps SDK UI)  │     │  (Cloudflare)   │     │    двойник      │
│                 │◀────│                 │◀────│                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
      │                        │                       │
      │ Пользователь           │ MCP Protocol          │ REST API
      │ взаимодействует        │ (JSON-RPC)            │ (внутренний)
      │ с UI                   │                       │
```

## Компоненты

### 1. ChatGPT + Apps SDK UI

**Что это:** Пользовательский интерфейс внутри ChatGPT, построенный на OpenAI Apps SDK.

**Ответственность:**
- Отображение UI для пользователя
- Отправка запросов к MCP-серверу
- Рендеринг ответов от ассистента

**Технологии:**
- OpenAI Apps SDK
- React (внутри SDK)
- JSON для конфигурации

### 2. MCP-сервер

**Что это:** Серверная часть, реализующая Model Context Protocol.

**Ответственность:**
- Приём запросов от ChatGPT
- Преобразование в запросы к Цифровому двойнику
- Возврат данных в формате MCP

**Технологии:**
- Cloudflare Workers
- TypeScript
- MCP SDK

**Эндпоинт:** `https://digital-twin-mcp.aisystant.workers.dev/mcp`

### 3. Цифровой двойник

**Что это:** Хранилище данных о действиях и прогрессе пользователя.

**Ответственность:**
- Хранение событий пользователя
- Агрегация метрик за период
- Предоставление данных по запросу

**API:**
- REST API для MCP-сервера
- Внутренний API для других сервисов платформы

## Поток данных

1. Пользователь нажимает "Показать неделю" в UI
2. Apps SDK отправляет запрос к MCP-серверу
3. MCP-сервер определяет `twin_id` (демо или реальный)
4. MCP-сервер запрашивает данные из Цифрового двойника
5. Цифровой двойник возвращает агрегированные метрики
6. MCP-сервер форматирует ответ по контракту
7. ChatGPT получает данные и генерирует ответ
8. Пользователь видит результат в UI

## Преимущества архитектуры

| Преимущество | Описание |
|--------------|----------|
| Разделение ответственности | Каждый компонент делает одно дело |
| Масштабируемость | MCP на Cloudflare Workers — автоскейлинг |
| Безопасность | Данные не передаются напрямую в LLM |
| Гибкость | Можно заменить любой компонент |

---

**Связанные документы:**
- [[Потоки-данных-и-состояний]]
- [[Решения-и-обоснования]]
- [[../3.2.4.1.1.6 MCP-Сервер_отдельно/Ссылка-на-MCP-эндпоинт-и-описание]]
