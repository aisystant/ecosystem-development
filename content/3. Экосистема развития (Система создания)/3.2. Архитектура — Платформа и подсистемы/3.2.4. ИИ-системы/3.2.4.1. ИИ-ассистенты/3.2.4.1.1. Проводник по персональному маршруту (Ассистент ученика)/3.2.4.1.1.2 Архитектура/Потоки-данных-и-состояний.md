# Потоки данных и состояний

## Основной поток: запрос метрик недели

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│          │    │          │    │          │    │          │
│  User    │───▶│  ChatGPT │───▶│   MCP    │───▶│  Twin    │
│          │    │  + SDK   │    │  Server  │    │  API     │
│          │◀───│          │◀───│          │◀───│          │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
     │               │               │               │
     │ 1. Клик       │ 2. MCP call   │ 3. REST       │
     │ "Показать"    │ get_week_*    │ /metrics      │
     │               │               │               │
     │ 6. Видит      │ 5. Ответ      │ 4. JSON       │
     │ результат     │ ассистента    │ с данными     │
```

## Детализация шагов

### Шаг 1: Пользователь инициирует запрос
- Нажимает кнопку "Показать мою неделю"
- Apps SDK перехватывает событие
- Формирует intent для ChatGPT

### Шаг 2: ChatGPT вызывает MCP-инструменты
- GPT определяет, какие инструменты нужны
- Вызывает `get_week_state`, `get_week_time`, `get_work_products`
- Передаёт `twin_id` (демо или реальный)

### Шаг 3: MCP-сервер обрабатывает запрос
- Валидирует входные параметры
- Определяет источник данных
- Формирует запрос к Цифровому двойнику

### Шаг 4: Цифровой двойник возвращает данные
- Агрегирует события за неделю
- Считает метрики
- Возвращает JSON по контракту

### Шаг 5: MCP-сервер форматирует ответ
- Проверяет данные на соответствие схеме
- Добавляет метаданные (период, версия)
- Возвращает в ChatGPT

### Шаг 6: Пользователь видит результат
- GPT генерирует текстовый ответ
- Apps SDK рендерит UI
- Пользователь читает и действует

## Состояния системы

| Состояние | Описание | Действия |
|-----------|----------|----------|
| `idle` | Ожидание запроса | Показать UI с кнопкой |
| `loading` | Запрос в процессе | Показать спиннер |
| `success` | Данные получены | Показать метрики |
| `error` | Ошибка запроса | Показать сообщение |
| `empty` | Нет данных | Показать onboarding |

## Обработка ошибок

```
Ошибка сети     → Retry 3 раза → Показать "Попробуйте позже"
Ошибка MCP      → Логировать   → Показать fallback-данные
Нет данных      → Проверить ID → Показать "Неделя пуста"
Таймаут (>5s)   → Отменить     → Показать "Сервис недоступен"
```

---

**Связанные документы:**
- [[Описание-архитектуры-Apps-SDK+MCP+Двойник]]
- [[../3.2.4.1.1.4 Контракты-MCP/Список-инструментов-минимальный]]
