# D.2 Интеграция с репозиторием руководств

Спецификация взаимодействия ДЗ-чекера с репозиторием руководств для получения контекста проверки.

---

## Назначение

Репозиторий руководств предоставляет **нормативный контент** для проверки ответов:
- Тексты разделов руководств (норматив)
- Рубрики проверки (критерии с весами)

---

## v0.1 — Программа «Личное развитие»

### MCP-сервер

Репозиторий руководств реализуется как **MCP-сервер** по аналогии с [fsm-mcp](https://github.com/aisystant/fsm-mcp).

**MCP-эндпоинт:**
```
https://guides-mcp.aisystant.workers.dev/check-context
```

**HTTP Request нода в n8n:**
```
URL: https://guides-mcp.aisystant.workers.dev/check-context
Method: POST
Body: ={{ $json }}
```

> **Примечание:** В процессе разработки временно используется заглушка `httpbin.org/post`.

### Запрос контекста

**Параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `course_name` | string | Название курса (текстовое) |
| `section_name` | string | Название раздела из дерева навигации |

**Пример:**
```json
{
  "course_name": "Системное мышление",
  "section_name": "Физический мир и ментальное пространство"
}
```

### Ответ

```json
{
  "course_name": "string",
  "section_name": "string",
  "section_path": "string",
  "normative_text": "string",
  "rubric": {
    "name": "string",
    "passing_score": "number",
    "criteria": [
      {
        "id": "string",
        "weight": "number",
        "description": "string"
      }
    ]
  },
  "version": "string"
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `normative_text` | string | Текст норматива (фрагмент руководства) |
| `rubric` | object | Рубрика проверки с критериями |
| `version` | string | Версия материалов (git tag или commit) |

**Пример:**
```json
{
  "course_name": "Системное мышление",
  "section_name": "Физический мир и ментальное пространство",
  "section_path": "systems-thinking/chapter-01.md#section-1-1",
  "normative_text": "Физический мир существует объективно, независимо от нашего восприятия...",
  "rubric": {
    "name": "Понимание концепции",
    "passing_score": 60,
    "criteria": [
      {
        "id": "main_idea",
        "weight": 40,
        "description": "Студент передал ключевую идею из материала"
      },
      {
        "id": "own_example",
        "weight": 30,
        "description": "Приведён собственный пример, иллюстрирующий понимание"
      }
    ]
  },
  "version": "v2.3.1"
}
```

---

## Roadmap интеграции

### v0.1 — Программа «Личное развитие»

- MCP-сервер для руководств программы «Личное развитие»
- Курсы: Системное мышление, Моделирование, и др.

### v0.3 — Программа «Рабочее развитие»

- Расширение MCP-сервера для программы «Рабочее развитие»
- Дополнительные рубрики для рабочих задач

---

## Как используется в workflow

### Code (Build Prompt) нода

После получения контекста, Code нода собирает промпт:

```javascript
const criteriaText = (data.rubric?.criteria || [])
  .map(c => `- ${c.id} (${c.weight}%): ${c.description || ""}`)
  .join("\n");

const prompt = [
  "## Вопрос домашнего задания",
  data.question_text || "(нет вопроса)",
  "",
  "## Ответ стажера",
  data.answer_text || "(нет ответа)",
  "",
  "## Норматив",
  data.normative_text || "(норматив не найден)",
  "",
  "## Критерии оценки",
  criteriaText || "(критерии не переданы)",
  "",
  "## Инструкция",
  "Проверь ответ стажера по указанным критериям..."
].join("\n");
```

---

## Реализация MCP-сервера

### Архитектура

По аналогии с [fsm-mcp](https://github.com/aisystant/fsm-mcp):

| Компонент | Технология |
|-----------|------------|
| Хранилище | Git-репозиторий с руководствами |
| Хостинг | Cloudflare Workers |
| Протокол | MCP (Model Context Protocol) |

### Структура репозитория

```
guides-mcp/
├── src/                           # Код MCP-сервера
│   └── index.ts
├── guides/                        # Тексты руководств
│   ├── systems-thinking/
│   │   ├── chapter-01.md
│   │   └── ...
│   └── modeling/
│       └── ...
├── rubrics/                       # Рубрики проверки
│   ├── concept-understanding.yaml
│   └── deep-understanding.yaml
└── wrangler.toml
```

---

## Обработка ошибок

| Ситуация | Действие |
|----------|----------|
| Курс не найден | Вернуть ошибку с доступными курсами |
| Раздел не найден | Использовать общий текст курса |
| MCP недоступен | Вернуть 503, логировать |

---

## Связанные документы

- [fsm-mcp](https://github.com/aisystant/fsm-mcp) — референсная реализация
- [Общее описание Проверяльщика ДЗ](../Общее%20описание%20Проверяльщика%20ДЗ%20(ДЗ-чекер)%203.2.md)
- [D.4 Рубрики проверки](./D.4%20Рубрики%20проверки.md)

---

**Версия:** 0.1
**Дата:** 2025-12-31
**Статус:** MCP endpoint для программы «Личное развитие»
