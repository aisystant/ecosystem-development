# D.2 Интеграция с репозиторием руководств

Спецификация взаимодействия ДЗ-чекера с репозиторием руководств для получения контекста проверки.

---

## Назначение

Репозиторий руководств предоставляет **нормативный контент** для проверки ответов:
- Тексты разделов руководств (норматив)
- Рубрики проверки (критерии с весами)

---

## Референсная архитектура

Репозиторий руководств реализуется как **MCP-сервер** по аналогии с [fsm-mcp](https://github.com/aisystant/fsm-mcp).

| Компонент | Роль |
|-----------|------|
| **Git-репозиторий** | Хранилище руководств, рубрик, карт вопросов |
| **Cloudflare Workers** | Хостинг MCP-сервера (serverless) |
| **MCP-эндпоинт** | Интерфейс для ДЗ-чекера |

**MCP-эндпоинт:**
```
https://guides-mcp.aisystant.workers.dev/mcp
```

---

## Архитектура взаимодействия

```
┌─────────────┐    запрос контекста    ┌─────────────────────┐
│             │ ───────────────────────▶│                     │
│  ДЗ-чекер   │                        │  Репозиторий        │
│             │◀─────────────────────── │  руководств         │
│             │    норматив + рубрика  │                     │
└─────────────┘                        └─────────────────────┘
```

---

## MCP-эндпоинт /check-context

### Запрос

**Метод:** MCP tool call (или HTTP POST для прототипа)

**Параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `course_name` | string | Название курса (текстовое) |
| `section_name` | string | Название раздела из дерева навигации |

**Пример:**
```json
{
  "course_name": "Системное мышление",
  "section_name": "Физический мир и ментальное пространство"
}
```

### Ответ

```json
{
  "course_name": "string",
  "section_name": "string",
  "section_path": "string",
  "normative_content": "string",
  "rubric": {
    "name": "string",
    "passing_score": "number",
    "criteria": [
      {
        "id": "string",
        "name": "string",
        "weight": "number",
        "description": "string"
      }
    ]
  },
  "version": "string"
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `course_name` | string | Название курса |
| `section_name` | string | Название раздела |
| `section_path` | string | Путь к файлу раздела в репозитории |
| `normative_content` | string | Текст норматива (фрагмент руководства) |
| `rubric` | object | Рубрика проверки |
| `version` | string | Версия материалов (git tag или commit) |

**Пример:**
```json
{
  "course_name": "Системное мышление",
  "section_name": "Физический мир и ментальное пространство",
  "section_path": "systems-thinking/chapter-01.md#section-1-1",
  "normative_content": "Физический мир существует объективно, независимо от нашего восприятия. Однако мы можем описывать его разными способами, фокусируясь на разных свойствах...",
  "rubric": {
    "name": "Понимание концепции",
    "passing_score": 60,
    "criteria": [
      {
        "id": "main_idea",
        "name": "Ключевая идея",
        "weight": 40,
        "description": "Студент передал ключевую идею из материала"
      },
      {
        "id": "own_example",
        "name": "Собственный пример",
        "weight": 30,
        "description": "Приведён собственный пример, иллюстрирующий понимание"
      }
    ]
  },
  "version": "v2.3.1"
}
```

---

## Логика поиска

### Алгоритм v0.1

1. **Поиск курса** по точному совпадению `course_name`
2. **Поиск раздела** по вхождению `section_name` в заголовки
3. **Загрузка норматива** — текст раздела (до 8000 символов)
4. **Выбор рубрики** — базовая рубрика "Понимание концепции"

### Алгоритм v0.2+ (с картой вопросов)

1. Использование `questions_map.yaml` для точного сопоставления
2. Специфичные рубрики для разных типов вопросов
3. Кэширование контекстов

---

## Обработка ошибок

| Ситуация | Действие |
|----------|----------|
| Курс не найден | Вернуть ошибку с доступными курсами |
| Раздел не найден | Вернуть ошибку с доступными разделами курса |
| Норматив пустой | Использовать заглушку, логировать предупреждение |

---

## Требования к репозиторию руководств

### Структура файлов

```
guides/
├── systems-thinking/
│   ├── index.md           # Оглавление курса
│   ├── chapter-01.md      # Глава 1
│   ├── chapter-02.md      # Глава 2
│   └── ...
├── another-course/
│   └── ...
└── rubrics/
    ├── default.yaml       # Базовая рубрика
    └── deep.yaml          # Рубрика глубокого понимания
```

### Формат файлов

- Markdown с заголовками (# ## ###)
- Якоря для разделов (`{#section-id}`)
- Явные границы разделов

---

## v0.1: Заглушка

В первой версии используется заглушка:

```python
def get_check_context(course_name: str, section_name: str) -> dict:
    """Заглушка — возвращает базовый контекст."""
    return {
        "course_name": course_name,
        "section_name": section_name,
        "normative_content": f"[Норматив для раздела '{section_name}']",
        "rubric": DEFAULT_RUBRIC
    }
```

Реальная интеграция будет реализована после создания MCP-сервера в репозитории руководств.

---

## Связанные документы

### Архитектура
- [fsm-mcp](https://github.com/aisystant/fsm-mcp) — референсная реализация MCP-сервера
- [FSM-архитектура ИИ-ассистентов 3.2](../../3.2.4.1.%20Проводник%20по%20персональному%20маршруту%20(Ассистент%20ученика)/FSM-архитектура%20ИИ-ассистентов%203.2.md) — ADR по архитектуре

### Спецификации
- [Общее описание Проверяльщика ДЗ](../Общее%20описание%20Проверяльщика%20ДЗ%20(ДЗ-чекер)%203.2.md) — артефакты A3, A4
- [Структура репозитория руководств](../../../../0.%20Управление/0.9.%20Входящие/Структура%20репозитория%20руководств%200.9.md)

### Реализация
- Рабочий файл: `agents-core/homework-checker/check.py` → `get_check_context()`

---

**Версия:** 0.1
**Дата:** 2025-12-25
**Статус:** Ожидает реализации MCP-сервера (по аналогии с fsm-mcp)
