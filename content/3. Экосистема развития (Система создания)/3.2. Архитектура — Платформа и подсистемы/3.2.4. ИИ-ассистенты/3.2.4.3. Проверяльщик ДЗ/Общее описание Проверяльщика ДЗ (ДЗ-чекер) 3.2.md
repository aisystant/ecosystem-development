# ДЗ-чекер: ИИ-проверка домашних заданий

Система автоматической проверки домашних заданий студентов с использованием LLM, реализованная как n8n workflow.

## Назначение

ДЗ-чекер — это ИИ-агент, который:
- Принимает ответы студентов из LMS по заданиям типа «чеклист/дз»
- Сопоставляет их с нормативными материалами из **репозитория руководств**
- Оценивает по заданным критериям (рубрикам) с помощью LLM
- Возвращает структурированную обратную связь студенту

**Источник нормативных материалов:** [Репозиторий руководств](../../../../0.%20Управление/0.9.%20Входящие/Структура%20репозитория%20руководств%200.9.md) — хранилище текстов руководств образовательных программ ШСМ.

---

## Системы и их взаимодействие

```
                                              ┌────────────────┐
                                              │                │
                                              │  Репозиторий   │
                                              │  руководств    │
                                              └────────────────┘
                                                 ▲          │
                                            [A3] │          │ [A4]
                                                 │          ▼
┌────────────────┐  [A1]  ┌────────────────┐  [A2]  ┌────────────────┐  [A5]  ┌────────────────┐
│                │        │                │        │                │        │                │
│    Студент     │ ─────▶ │      LMS       │ ─────▶ │   ДЗ-чекер     │ ─────▶ │      LLM       │
│                │        │                │        │   (n8n)        │        │                │
│                │ ◀───── │                │ ◀───── │                │ ◀───── │                │
│                │  [A8]  │                │  [A7]  │                │  [A6]  │                │
└────────────────┘        └────────────────┘        └────────────────┘        └────────────────┘
```

### Роли систем

| Система | Роль | Данные |
|---------|------|--------|
| **Студент** | Источник ответа | Текст ответа на пункт чеклиста/ДЗ |
| **LMS (Aisystant)** | Хранилище и интерфейс | Вопросы, ответы, метаданные, результаты |
| **ДЗ-чекер (n8n)** | Движок проверки | Webhook + логика сборки промпта |
| **Репозиторий руководств** | Источник норматива | Тексты руководств, рубрики |
| **LLM (Claude)** | Исполнитель проверки | Сопоставление ответа с критериями |

---

## Артефакты (пакеты), которые "текут" по процессу

| № | Артефакт | Откуда → Куда | Описание |
|---|----------|---------------|----------|
| A1 | Ответ студента | Студент → LMS | Текст ответа + действие «Проверить с ИИ» |
| A2 | Пакет на проверку | LMS → ДЗ-чекер | `{answer_text, question_text, course_name, section_name}` |
| A3 | Запрос контекста | ДЗ-чекер → Репозиторий | course_name + section_name для поиска норматива |
| A4 | Контекст проверки | Репозиторий → ДЗ-чекер | `{normative_text, rubric}` |
| A5 | Запрос к LLM | ДЗ-чекер → LLM | Промпт с ответом, нормативом и критериями |
| A6 | Результат проверки | LLM → ДЗ-чекер | JSON: verdict, score, strengths, issues, next_step |
| A7 | Пакет результата | ДЗ-чекер → LMS | `{comment, checked_at, raw_llm}` |
| A8 | Отображение результата | LMS → Студент | Комментарий ИИ-проверки в интерфейсе |

---

## Архитектура n8n workflow

ДЗ-чекер реализован как workflow в n8n с 7 нодами:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         n8n: ДЗ-чекер workflow                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐              │
│  │ Webhook  │───▶│  Code    │───▶│  HTTP    │───▶│  Code    │              │
│  │ POST     │    │ Validate │    │ Request  │    │  Build   │              │
│  │ /check   │    │          │    │ Context  │    │  Prompt  │              │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘              │
│                                                        │                    │
│                                                        ▼                    │
│  ┌──────────┐    ┌──────────┐    ┌──────────────────────────┐              │
│  │ Respond  │◀───│  Code    │◀───│     HTTP Request         │              │
│  │    to    │    │  Format  │    │  (Anthropic Claude API)  │              │
│  │ Webhook  │    │  Result  │    │  claude-3-haiku-20240307 │              │
│  └──────────┘    └──────────┘    └──────────────────────────┘              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Ноды workflow

| № | Нода | Тип | Назначение |
|---|------|-----|------------|
| 1 | **Webhook** | Trigger | Принимает POST `/webhook/check` от LMS |
| 2 | **Code (Validate)** | Code | Проверяет наличие обязательных полей, возвращает 400 при ошибке |
| 3 | **HTTP Request (Context)** | HTTP Request | Запрос контекста из guides-mcp |
| 4 | **Code (Build Prompt)** | Code | Собирает промпт из вопроса, ответа, норматива, критериев |
| 5 | **HTTP Request (LLM)** | HTTP Request | Запрос к Claude API (`claude-3-haiku-20240307`) |
| 6 | **Code (Format)** | Code | Парсит ответ LLM, формирует comment в Markdown + checked_at |
| 7 | **Respond to Webhook** | Response | Возвращает `{comment, checked_at, raw_llm}` в LMS |

---

## Детали нод

### 1. Webhook

```
Метод: POST
Путь:  /webhook/check  (production)
       /webhook-test/check  (для Execute в редакторе)
Mode:  responseNode (ответ формируется в Respond to Webhook)
```

### 2. Code (Validate)

```javascript
const body = items[0]?.json?.body ?? {};
const required = ["answer_text", "question_text", "course_name", "section_name"];
const missing = required.filter(k => !body[k]);

if (missing.length) {
  return [{ json: { status: 400, error: `Missing: ${missing.join(", ")}` } }];
}

return [{ json: body }];
```

### 3. HTTP Request (Context)

Запрос к guides-mcp:

```
URL: https://guides-mcp.aisystant.workers.dev/check-context
Method: POST
Body: { course_name, section_name }
```

**Ответ MCP:**
- `normative_text` — текст норматива (фрагмент руководства)
- `rubric` — критерии проверки с весами

> **Примечание:** В процессе разработки временно используется заглушка `httpbin.org/post`.

### 4. Code (Build Prompt)

```javascript
const criteriaText = (data.rubric?.criteria || [])
  .map(c => `- ${c.id} (${c.weight}%): ${c.description || ""}`)
  .join("\n");

const prompt = [
  "## Вопрос домашнего задания",
  data.question_text || "(нет вопроса)",
  "",
  "## Ответ стажера",
  data.answer_text || "(нет ответа)",
  "",
  "## Норматив",
  data.normative_text || "(норматив не найден)",
  "",
  "## Критерии оценки",
  criteriaText || "(критерии не переданы)",
  "",
  "## Инструкция",
  "Проверь ответ стажера по указанным критериям, опираясь на норматив.",
  "Верни результат в формате JSON: verdict, score, strengths, issues [{criterion, issue, suggestion}], next_step, criterion_scores."
].join("\n");

return [{ json: { ...data, prompt } }];
```

### 5. HTTP Request (LLM)

```
URL: https://api.anthropic.com/v1/messages
Method: POST
Headers:
  x-api-key: {{API_KEY}}
  anthropic-version: 2023-06-01
  Content-Type: application/json

Body (Expression):
{{ JSON.stringify({
  model: "claude-3-haiku-20240307",
  max_tokens: 800,
  system: "…системный промпт…",
  messages: [
    {
      role: "user",
      content: [{ type: "text", text: $json.prompt || "" }]
      ]
    }
  ]
}) }}
```

**Важно:** Content-Type должен быть `application/json` (без знака `=`).

### 6. Code (Format)

```javascript
const rawText = items[0].json.content?.[0]?.text;
let llm;

if (rawText) {
  try {
    llm = JSON.parse(rawText);
  } catch (e) {
    llm = {
      verdict: "needs_revision",
      score: null,
      strengths: [],
      issues: [{ criterion: null, issue: "Ответ LLM не в JSON", suggestion: rawText }],
      next_step: "Верните JSON по шаблону",
      raw_text: rawText
    };
  }
} else {
  llm = items[0].json;
}

const verdictMap = { accepted: "✓ Принято", needs_revision: "На доработку", rejected: "Не принято" };
const strengths = (llm.strengths || []).map(s => `- ${s}`).join("\n") || "—";
const issues = (llm.issues || []).map(i =>
  `- ${i.criterion || "критерий"}: ${i.issue || ""}` +
  (i.suggestion ? `\n  _Рекомендация: ${i.suggestion}_` : "")
).join("\n") || "—";

const comment = [
  `**${verdictMap[llm.verdict] || llm.verdict || "—"}** (${llm.score !== null ? llm.score + "/100" : "—"})`,
  "",
  "**Сильные стороны:**",
  strengths,
  "",
  "**Замечания:**",
  issues,
  "",
  "**Следующий шаг:**",
  llm.next_step || "—"
].join("\n");

return [{ json: { comment, checked_at: new Date().toISOString(), raw_llm: llm } }];
```

### 7. Respond to Webhook

Возвращает JSON-ответ клиенту:
```json
{
  "comment": "**✓ Принято** (85/100)\n\n**Сильные стороны:**\n...",
  "checked_at": "2025-12-31T12:00:00.000Z",
  "raw_llm": { "verdict": "accepted", "score": 85, ... }
}
```

---

## Что осталось сделать для v0.1

| Задача | Статус | Описание |
|--------|--------|----------|
| guides-mcp | ⏳ TODO | Подключить guides-mcp для программы «Личное развитие» |
| Исправить LLM-ноду | ⏳ TODO | Content-Type = `application/json` (без `=`), тело через Expression |
| Использовать prod URL | ⏳ TODO | `/webhook/check` (не `/webhook-test/check`) |
| Интеграция с LMS | ⏳ TODO | Кнопка «Проверить с ИИ» + обработка ответов |

---

## Интеграция с фронтом LMS

### Кнопка «Проверить с ИИ»

Отправляет POST-запрос:

```javascript
const response = await fetch('/webhook/check', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    answer_text: answerInput.value,
    question_text: questionElement.textContent,
    course_name: courseName,
    section_name: sectionName
  })
});
```

### Обработка ответов

| Код | Действие |
|-----|----------|
| 200 | Рендерить `comment` как Markdown + показать `checked_at` |
| 400 | Показать: «Ошибка в запросе, проверьте текст ответа» |
| 500/503 | Показать: «Сервис временно недоступен, попробуйте позже» |

### Предупреждение v0.1

> **Важно:** В v0.1 результат проверки не сохраняется и потеряется при обновлении страницы или переходе на другие разделы курса.

---

## Интерфейс для студента

```
┌────────────────────────────────────────────────────────────┐
│  Результат ИИ-проверки                                     │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ✓ Принято (85/100)                    31.12.2025 в 12:00 │
│                                                            │
│  Сильные стороны:                                          │
│  • Верно указано, что любая модель фокусируется на        │
│    определённых свойствах                                  │
│  • Хороший пример с программным продуктом                  │
│                                                            │
│  Замечания:                                                │
│  • Не использован термин «описание системы» —              │
│    рекомендую использовать точную терминологию             │
│                                                            │
│  Следующий шаг:                                            │
│  Попробуйте привести ещё один пример из вашей практики    │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## Пороги автоматических решений

| Диапазон баллов | Вердикт | Действие |
|-----------------|---------|----------|
| 80–100 | `accepted` | Автоматически принять |
| 60–79 | `needs_revision` | Отправить наставнику на проверку |
| 0–59 | `needs_revision` / `rejected` | Вернуть на доработку |

---

## Roadmap

### v0.1 — Полная функциональность для «Личное развитие»

- n8n workflow с 7 нодами
- Claude 3 Haiku для проверки
- **guides-mcp** для программы «Личное развитие»
- Синхронный ответ без сохранения
- Интеграция с LMS (кнопка «Проверить с ИИ»)

### v0.2 — Интеграция с наставниками

- Сохранение результатов проверки в LMS
- Интеграция с ответами наставников (обратная связь для улучшения промптов)
- Логирование и мониторинг
- Статусы: «На проверке ИИ», «Проверено ИИ»

### v0.3 — Программа «Рабочее развитие»

- guides-mcp для программы «Рабочее развитие»
- Расширенные рубрики для рабочих задач
- Кэширование контекста

### v0.4 — Интеграция с экосистемой

- Интеграция с **Ассистентом ученика** (передача контекста обучения)
- Интеграция с **Цифровым двойником** (персонализация проверки)
- Fallback на другие LLM
- Пакетная обработка

---

## Связанные документы

- [D.1 Спецификация API](./Спецификации%20v0.1/D.1%20Спецификация%20API%20ДЗ-чекера.md)
- [D.2 Интеграция с репозиторием руководств](./Спецификации%20v0.1/D.2%20Интеграция%20с%20репозиторием%20руководств.md)
- [D.3 Описание промптов](./Спецификации%20v0.1/D.3%20Описание%20промптов.md)
- [D.4 Рубрики проверки](./Спецификации%20v0.1/D.4%20Рубрики%20проверки.md)
- [D.5 Требования к LMS](./Спецификации%20v0.1/D.5%20Требования%20к%20LMS.md)

---

**Статус:** Реализация v0.1 (n8n workflow)
**Дата:** 2025-12-31
