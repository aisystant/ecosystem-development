---
type: architecture
status: draft
version: 1.4
created: 2025-12-29
updated: 2025-12-30
layer: platform
scope: ecosystem
description: "Архитектура доступа ИИ-ассистентов к данным экосистемы"
related:
  - "FSM-архитектура ИИ-ассистентов 3.2"
  - "Интеграция MCP-серверов с LLM через OpenAI Apps SDK 3.2"
  - "Канонический шаблон описания MCP Tools и Resources"
---

# Архитектура доступа ИИ к данным экосистемы

## Назначение документа

Документ описывает архитектуру системы, которая позволяет:

1. **Пользователям** — получать персонализированные рекомендации через разные интерфейсы (ChatGPT, Telegram, Web)
2. **ИИ-ассистентам** — безопасно получать данные пользователей для формирования рекомендаций
3. **Разработчикам** — создавать новых ИИ-ассистентов с доступом к данным экосистемы

---

## Ключевые принципы

| Принцип | Реализация |
|---------|------------|
| **Разделение логики и данных** | MCP-app (логика) отдельно от MCP-data (доступ к данным) |
| **Приватность по умолчанию** | Агент получает только те данные, которые нужны для текущего сценария |
| **Один интерфейс — много ассистентов** | Через ChatGPT/Telegram можно подключить разных ассистентов |
| **Все MCP на одном уровне** | LLM вызывает любой MCP напрямую; MCP независимы друг от друга |

---

## Схема архитектуры

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ПОЛЬЗОВАТЕЛИ                                   │
│                                                                             │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                   │
│  │ Вася          │  │ Петя          │  │ Маша          │                   │
│  │ "Подведи      │  │ "Найди        │  │ "Какие        │                   │
│  │  итоги недели"│  │  руководство" │  │  мои цели?"   │                   │
│  └───────────────┘  └───────────────┘  └───────────────┘                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ взаимодействует через
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ИНТЕРФЕЙСЫ                                     │
│                                                                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐               │
│  │ ChatGPT         │ │ Telegram Bot    │ │ Web App         │               │
│  │ (Apps SDK)      │ │                 │ │                 │               │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘               │
│                                                                             │
│  Интерфейсы — только UI. Не хранят данные, не исполняют логику.            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ запросы пользователей
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 LLM                                         │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ GPT (OpenAI) / Claude (Anthropic) / другие                          │   │
│  │                                                                     │   │
│  │ • Понимает запрос пользователя                                     │   │
│  │ • Вызывает любые MCP-инструменты (MCP-app и MCP-data)              │   │
│  │ • Формирует ответ                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ вызов инструментов
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       MCP-СЕРВЕРЫ (один уровень)                            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           MCP-APP                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ fsm-mcp (Cloudflare Workers)                                │   │   │
│  │  │                                                             │   │   │
│  │  │ ИИ-ассистенты:                                              │   │   │
│  │  │ • Проводник по персональному маршруту развития              │   │   │
│  │  │   (Ассистент Ученика)                                        │   │   │
│  │  │ • ... (другие ассистенты в будущем)                          │   │   │
│  │  │                                                             │   │   │
│  │  │ Инструменты: get_instruction(state?)                        │   │   │
│  │  │                                                             │   │   │
│  │  │ Кто создаёт: Разработчики ИИ-ассистентов                    │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           MCP-DATA                                  │   │
│  │  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐          │   │
│  │  │ dt-mcp         │ │ guides-mcp     │ │ exercises-mcp  │          │   │
│  │  │ (Цифр. двойник)│ │ (Руководства)  │ │ (Упражнения)   │          │   │
│  │  │                │ │                │ │                │          │   │
│  │  │ dt.get_progress│ │ guides.search  │ │ exercises.get  │          │   │
│  │  │ dt.get_goals   │ │ guides.get     │ │ exercises.check│          │   │
│  │  │ dt.save_*      │ │                │ │                │          │   │
│  │  └────────────────┘ └────────────────┘ └────────────────┘          │   │
│  │                                                                     │   │
│  │  Кто создаёт: Архитектор ИИ-платформы                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Все MCP доступны для LLM напрямую. MCP независимы друг от друга.          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ доступ к БД только через MCP-data
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           БАЗЫ ДАННЫХ                                       │
│                                                                             │
│  ┌────────────────────┐ ┌────────────────────┐ ┌────────────────────┐      │
│  │ Digital Twin Store │ │ Guides Repository  │ │ Exercises Bank     │      │
│  │ (SurrealDB)        │ │ (Git + SurrealDB)  │ │ (SurrealDB + S3)   │      │
│  │                    │ │                    │ │                    │      │
│  │ • Прогресс         │ │ • Руководства      │ │ • Упражнения       │      │
│  │ • Цели             │ │ • Шаблоны          │ │ • Рубрики          │      │
│  │ • Метрики          │ │                    │ │                    │      │
│  └────────────────────┘ └────────────────────┘ └────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Два типа MCP-серверов

В архитектуре используются два типа MCP-серверов:

| Тип | Назначение | Примеры |
|-----|------------|---------|
| **MCP-app** | Логика ИИ-ассистентов | fsm-mcp (Ассистент Ученика) |
| **MCP-data** | Доступ к данным | dt-mcp, guides-mcp, exercises-mcp |

### MCP-app (логика)

| Характеристика | Описание |
|----------------|----------|
| **Назначение** | Оркестрация диалога, FSM-переходы между состояниями |
| **Инструменты** | `get_instruction(state?)` |
| **Содержимое** | `states/*.md` — инструкции для каждого состояния |
| **Вызывается** | LLM напрямую |
| **Кто создаёт** | Разработчики ИИ-ассистентов |
| **Размещение** | Cloudflare Workers |
| **Репозиторий** | [github.com/aisystant/fsm-mcp](https://github.com/aisystant/fsm-mcp) |

### MCP-data (данные)

| Характеристика | Описание |
|----------------|----------|
| **Назначение** | Чтение/запись данных в хранилища |
| **Инструменты (tools)** | `dt.get_progress()`, `guides.search()`, `exercises.get()` и др. |
| **Содержимое** | Логика доступа к базам данных |
| **Вызывается** | LLM напрямую |
| **Вызывает** | Данные из баз данных (только MCP-data имеет доступ к БД) |
| **Кто создаёт** | Архитектор ИИ-платформы |
| **Размещение** | Cloudflare Workers |

---

## Взаимодействие компонентов

### Два варианта вызова MCP

LLM может работать с MCP двумя способами:

| Вариант | Когда использовать | Пример |
|---------|-------------------|--------|
| **LLM → MCP-app, затем LLM → MCP-data** | Сложные сценарии с FSM-логикой | "Подведи итоги недели" |
| **LLM → MCP-data напрямую** | Простые запросы данных | "Найди руководство по системному мышлению" |

### Сценарий 1: Через MCP-app (FSM-логика)

```
Пользователь: "Подведи итоги недели"

1. LLM вызывает get_instruction() → fsm-mcp
2. fsm-mcp возвращает инструкции для состояния weekly_reflection
3. LLM вызывает dt.get_week_summary() → dt-mcp (по инструкции)
4. dt-mcp возвращает данные
5. LLM формирует структурированный ответ по инструкции
```

### Сценарий 2: Напрямую к MCP-data

```
Пользователь: "Найди руководство по системному мышлению"

1. LLM вызывает guides.search("системное мышление") → guides-mcp напрямую
2. guides-mcp возвращает список руководств
3. LLM формирует ответ
```

### Диаграмма: оба варианта

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  ChatGPT    │      │    GPT      │      │  fsm-mcp    │      │   dt-mcp    │
└──────┬──────┘      └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
       │                    │                    │                    │
       │                    │                    │                    │
       │  Вариант 1: MCP-app + MCP-data          │                    │
       │  ─────────────────────────────          │                    │
       │                    │                    │                    │
       │                    │  get_instruction() │                    │
       │                    │───────────────────>│                    │
       │                    │<───────────────────│ (инструкции)       │
       │                    │                    │                    │
       │                    │  dt.get_week_summary() (по инструкции)  │
       │                    │────────────────────────────────────────>│
       │                    │<────────────────────────────────────────│
       │                    │                    │                    │
       │                    │                    │                    │
       │  Вариант 2: напрямую к MCP-data         │                    │
       │  ──────────────────────────────         │                    │
       │                    │                    │                    │
       │                    │  dt.get_progress() │                    │
       │                    │────────────────────────────────────────>│
       │                    │<────────────────────────────────────────│
       │                    │                    │                    │
```

---

## Авторизация

### Поток авторизации

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  1. Пользователь входит через интерфейс (ChatGPT / Telegram / Web)         │
│                                                                             │
│  2. OAuth авторизация через Aisystant Identity                             │
│     • Пользователь логинится                                               │
│     • Получает access_token                                                │
│                                                                             │
│  3. Токен передаётся в каждый MCP-запрос                                   │
│     • LLM → любой MCP (Authorization: Bearer <token>)                      │
│                                                                             │
│  4. Каждый MCP проверяет токен                                             │
│     • Валидность токена                                                    │
│     • Извлекает user_id                                                    │
│     • Возвращает только данные этого пользователя                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Подключение через OpenAI Apps SDK

### Как это работает

OpenAI Apps SDK позволяет создать App в ChatGPT, который подключает несколько MCP-серверов. LLM (GPT) получает доступ ко всем инструментам всех подключённых MCP.

### Архитектура подключения

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  ChatGPT / GPT                                                              │
│     │                                                                       │
│     │  Apps SDK подключает все MCP на одном уровне                         │
│     │                                                                       │
│     ▼                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Все MCP-серверы                                │   │
│  │                                                                     │   │
│  │  ┌────────────────────────────────────────────────────────────┐    │   │
│  │  │ MCP-APP                                                     │    │   │
│  │  │ • fsm-mcp.aisystant.workers.dev/mcp                        │    │   │
│  │  │   Инструменты: get_instruction(state?)                      │    │   │
│  │  └────────────────────────────────────────────────────────────┘    │   │
│  │                                                                     │   │
│  │  ┌────────────────────────────────────────────────────────────┐    │   │
│  │  │ MCP-DATA                                                    │    │   │
│  │  │ • dt-mcp.aisystant.workers.dev/mcp                         │    │   │
│  │  │   Инструменты: dt.get_progress(), dt.get_goals(), ...      │    │   │
│  │  │ • guides-mcp.aisystant.workers.dev/mcp                     │    │   │
│  │  │   Инструменты: guides.search(), guides.get()               │    │   │
│  │  │ • exercises-mcp.aisystant.workers.dev/mcp                  │    │   │
│  │  │   Инструменты: exercises.get(), exercises.check()          │    │   │
│  │  └────────────────────────────────────────────────────────────┘    │   │
│  │                                                                     │   │
│  │  GPT вызывает любой MCP напрямую                                   │   │
│  │  Все MCP на одном уровне, независимы друг от друга                 │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Конфигурация Apps SDK

```json
{
  "mcpServers": {
    "fsm-mcp": {
      "url": "https://fsm-mcp.aisystant.workers.dev/mcp"
    },
    "dt-mcp": {
      "url": "https://dt-mcp.aisystant.workers.dev/mcp"
    },
    "guides-mcp": {
      "url": "https://guides-mcp.aisystant.workers.dev/mcp"
    },
    "exercises-mcp": {
      "url": "https://exercises-mcp.aisystant.workers.dev/mcp"
    }
  }
}
```

### Важные моменты

| Аспект | Решение |
|--------|---------|
| **Сколько MCP в Apps SDK** | Все: N MCP-app + N MCP-data |
| **Какие инструменты видит GPT** | Все инструменты всех подключённых MCP |
| **Как GPT выбирает инструмент** | По контексту запроса пользователя |
| **Авторизация** | OAuth через Aisystant Identity |
| **Токен** | Передаётся от Apps SDK → каждому MCP |

### Связь с документом

Подробнее см. **[[Интеграция MCP-серверов с LLM через OpenAI Apps SDK 3.2]]**

---

## Таблица компонентов

| Компонент | Тип | Размещение | Технологии |
|-----------|-----|------------|------------|
| **ChatGPT App** | Интерфейс | OpenAI | Apps SDK |
| **Telegram Bot** | Интерфейс | Сервер МИМ | Node.js / Python |
| **Web App** | Интерфейс | Vercel / CF Pages | React |
| **fsm-mcp** | MCP-app | Cloudflare Workers | TypeScript |
| **dt-mcp** | MCP-data | Cloudflare Workers | TypeScript |
| **guides-mcp** | MCP-data | Cloudflare Workers | TypeScript |
| **exercises-mcp** | MCP-data | Cloudflare Workers | TypeScript |
| **Identity Provider** | Авторизация | Сервер МИМ | Keycloak / Custom |
| **Digital Twin Store** | База данных | Cloud | SurrealDB |
| **Guides Repository** | База данных | Cloud | Git + SurrealDB |
| **Exercises Bank** | База данных | Cloud | SurrealDB + S3 |

---

## ИИ-ассистенты

### Текущий ассистент

| Название | Описание | MCP |
|----------|----------|-----|
| **Проводник по персональному маршруту развития** (Ассистент Ученика) | Помогает планировать обучение, подводить итоги, работать с затыками | fsm-mcp |

### Добавление новых ассистентов

Новые ассистенты создаются как:
1. Новые `states/*.md` в существующем MCP-app (если используют ту же логику)
2. Отдельный MCP-app (если логика существенно отличается)

Все ассистенты используют общие MCP-data (dt-mcp, guides-mcp).

---

## Связь с FSM-архитектурой

Этот документ **дополняет** принятую [[FSM-архитектура ИИ-ассистентов 3.2]]:

| FSM-архитектура | Этот документ |
|-----------------|---------------|
| Как организовать логику диалога | Как получить данные для диалога |
| `states/*.md`, `get_instruction()` | MCP-data (dt-mcp, guides-mcp) |
| Один MCP (fsm-mcp) | Два типа: MCP-app и MCP-data |
| Работает | Расширяет |

LLM использует **MCP-app** (fsm-mcp) для получения инструкций, а **MCP-data** — для получения данных пользователя.

---

## Связанные документы

- **[[FSM-архитектура ИИ-ассистентов 3.2]]** — архитектура FSM-логики ассистентов
- **[[Интеграция MCP-серверов с LLM через OpenAI Apps SDK 3.2]]** — подключение через ChatGPT
- **[[Канонический шаблон описания MCP Tools и Resources]]** — формат описания инструментов

---

## Changelog

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-29 | v0.1–v0.6 | Разработка концепции |
| 2025-12-30 | v1.0 | Упрощение: убраны Gateway, агенты сообщества, Policy Engine. Фокус на реальной архитектуре |
| 2025-12-30 | v1.1 | Введены термины MCP-app и MCP-data для двух типов MCP-серверов |
| 2025-12-30 | v1.2 | Все MCP на одном уровне: LLM может вызывать любой MCP напрямую, MCP-app также может вызывать MCP-data |
| 2025-12-30 | v1.3 | Уточнения: доступ к БД только через MCP-data; разные сценарии пользователей; N MCP-app; пример с guides |
| 2025-12-30 | v1.4 | MCP независимы: убраны все server-to-server; LLM вызывает каждый MCP напрямую |
