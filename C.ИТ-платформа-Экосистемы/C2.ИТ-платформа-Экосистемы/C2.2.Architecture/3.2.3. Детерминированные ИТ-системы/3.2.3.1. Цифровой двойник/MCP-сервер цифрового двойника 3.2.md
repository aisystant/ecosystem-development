---

title: MCP-сервер цифрового двойника
family: F8
cell: '3.2'
version: v2.0
status: active
date_created: '2025-12-09'
date_modified: '2025-12-20'
related:
- Модель данных цифрового двойника 3.2
- Описание цифрового двойника 3.2
- Описание ИИ-ассистента Проводник (Ассистент Ученика) 3.2
- Концепция Проводника (Ассистент Ученика) 3.2
description: 'Описание MCP-сервера над Моделью данных цифрового двойника: архитектура,
  tools, JSON-схемы, примеры тестирования, сценарии использования для ИИ-Проводника'
type: doc
created: '2025-12-12'
layer: operations
scope: local-edge
aliases:
- MCP-сервер ЦД
- Digital Twin MCP Server
---

# MCP-сервер цифрового двойника 3.2

## Цель и назначение

Документ описывает MCP-сервер над Моделью данных цифрового двойника — интерфейсный слой для работы ИИ-Проводника (`AGT.RouteGuide`), который ведёт человека по ступеням Ученика от Случайного до Проактивного.

**Документ включает:**
- Архитектуру и развёртывание MCP-сервера
- Полный список MCP-tools с JSON-схемами
- Примеры входов/выходов для тестирования
- Сценарии использования Проводником
- Чек-лист тестирования

---

## Текущее развёртывание

### Продуктивная среда

| Компонент | URL / Идентификатор |
|-----------|---------------------|
| **GPT "Ассистент Ученика"** | https://chatgpt.com/g/g-6931986f5d6081918c133a667bb2d1d5-assistent-uchenika |
| **MCP-сервер** | https://digital-twin-mcp.aisystant.workers.dev/mcp |
| **Платформа хостинга** | Cloudflare Workers |
| **Протокол** | MCP (Model Context Protocol) |

### Архитектура развёртывания

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПОЛЬЗОВАТЕЛЬ (Ученик)                        │
│         Общается через интерфейс ChatGPT                        │
└─────────────────────────────┬───────────────────────────────────┘
                              │ HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              OpenAI GPT "Ассистент Ученика"                     │
│  - Системный промпт с методикой ступеней                        │
│  - Подключён к MCP-серверу через Actions                        │
│  - Вызывает tools для получения/записи данных                   │
└─────────────────────────────┬───────────────────────────────────┘
                              │ MCP Protocol
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│       MCP-сервер (Cloudflare Workers)                           │
│       https://digital-twin-mcp.aisystant.workers.dev/mcp        │
│  - Принимает вызовы tools от GPT                                │
│  - Читает/записывает данные в хранилище                         │
│  - Возвращает структурированные ответы                          │
└─────────────────────────────┬───────────────────────────────────┘
                              │ SQL/API
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│            Централизованное хранилище (SurrealDB)               │
│  - Первичные данные (IND.1.*)                                   │
│  - Производные показатели (IND.2.*)                             │
│  - Маршруты, сессии, история ступеней                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 1. Главные объекты внимания

### 1.1. Человек (ученик) и его цифровой двойник

Центральный объект — взрослый человек, развивающий роль Ученика. Его цифровой двойник (`PRS.Twin`) включает:

**Первичные данные (IND.1.*):**
- Профиль в LMS и клубе
- Участие в курсах и потоках
- Учебные сессии и помидорки
- Задания и ответы
- Активность в клубе
- Логи ботов

**Производные показатели (IND.2.*):**
- 2.1.* — агентность и учебный ритм (часы, регулярность)
- 2.2.* — степень мастерства Ученика
- 2.3.* — индексы рефлексии, качества вопросов
- 2.4.2 — внутренняя ступень Ученика
- 2.4.3 — история ступеней
- 2.10.1 — профиль застревания

### 1.2. Проводник по персональному маршруту развития

Проводник (`AGT.RouteGuide`) — ИИ-ассистент с ролью методолога-наставника:
- Понимает ступени Ученика и критерии перехода
- Использует данные цифрового двойника через MCP-tools
- Помогает выйти на 15+ минут ежедневного слота и 10+ часов в неделю
- Ведёт человека к состоянию Проактивного ученика

### 1.3. MCP-сервер над цифровым двойником

MCP-сервер (`S.DigitalTwinMCP`):
- Предоставляет **функции чтения** агрегатов, событий, ступеней, маршрутов
- Предоставляет **функции записи** оценок ступени, маршрутов, результатов сессий
- Реализует фильтрацию и агрегацию данных под задачи Проводника
- Обеспечивает безопасный доступ без технических ID

---

## 2. Общая архитектура MCP-сервера

### 2.1. Потоки данных

```
┌─────────────────────────────────────────────────────────────────┐
│  Интерфейс (ChatGPT, LMS, Telegram-бот)                         │
│  Человек пишет запрос Проводнику                                │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Проводник (LLM)                                                │
│  - анализирует запрос                                           │
│  - вызывает MCP-tools                                           │
│  - формирует ответ и решения                                    │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  MCP-сервер над цифровым двойником                              │
│  - принимает вызовы от модели                                   │
│  - читает/обновляет данные в хранилище                          │
│  - возвращает агрегированные структуры                          │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Централизованное хранилище                                     │
│  - первичные данные и производные показатели                    │
│  - обновляется внешними системами и Проводником                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2. Направления потоков через MCP

**Чтение (diagnostics / analytics):**
- Сводки за период (часы, регулярность, практика, активность в клубе)
- Ядро показателей (IND.2.*)
- Текущая и прошлые ступени, профиль застревания
- Текущий маршрут и статусы шагов

**Запись (updates / logging):**
- Новая оценка ступени (IND.2.4.2 и обновление истории IND.2.4.3)
- Сформированный маршрут и шаги
- Лог сессии Проводника

### 2.3. Принцип работы MCP-сервера

> **MCP-сервер не меняет модель данных** — он не придумывает новые сущности и поля.
> **MCP-сервер обновляет данные внутри модели** — создаёт и изменяет записи (ступени, маршруты, сессии).

Модель данных (сущности, поля, связи, список показателей) задаётся отдельно в документе [[Модель данных цифрового двойника 3.2]].

---

## 3. Список MCP-tools с JSON-схемами

### 3.1. Группа A. Диагностика и ступени Ученика

#### A1. `get_learner_summary`

**Назначение:** Сводка по ученику за период — базовая статистика активности.

**JSON-схема входа:**
```json
{
  "tool": "get_learner_summary",
  "input": {
    "period_start": "2025-11-20",
    "period_end": "2025-12-20"
  }
}
```

**Альтернативный вход (предустановленный период):**
```json
{
  "tool": "get_learner_summary",
  "input": {
    "period": "4_weeks"
  }
}
```

**JSON-схема выхода:**
```json
{
  "total_hours": 12.5,
  "sessions_count": 18,
  "pomodoros_completed": 45,
  "tasks_completed": 7,
  "club_posts": 3,
  "club_comments": 12,
  "days_with_activity": 15,
  "avg_daily_minutes": 26,
  "period": {
    "start": "2025-11-20",
    "end": "2025-12-20"
  }
}
```

**Безопасность:** Без технических ID, только агрегированные данные.

---

#### A2. `get_learner_core_metrics`

**Назначение:** Ядро производных показателей (IND.2.*) для анализа ступени.

**JSON-схема входа:**
```json
{
  "tool": "get_learner_core_metrics",
  "input": {
    "period": "4_weeks"
  }
}
```

**Допустимые значения `period`:** `"4_weeks"`, `"8_weeks"`, `"3_months"`

**JSON-схема выхода:**
```json
{
  "metrics": {
    "2.1.1_hours_per_week": 3.2,
    "2.1.2_regularity_index": 0.42,
    "2.1.3_daily_slot_minutes": 15,
    "2.1.6_consistency_score": 2.1,
    "2.2.1_practice_score": 15,
    "2.2.7_mastery_index": 0.18,
    "2.3.1_reflection_count": 2,
    "2.3.2_question_quality_index": 0.35,
    "2.4.2_current_stage": "Случайный",
    "2.10.1_stagnation_profile": "Хаос"
  },
  "interpretation": {
    "regularity": "low",
    "stage_confidence": 0.85,
    "transition_readiness": 0.2,
    "risk_factors": ["irregular_schedule", "no_daily_slot"]
  },
  "period": {
    "weeks": 4,
    "start": "2025-11-20",
    "end": "2025-12-20"
  }
}
```

**Безопасность:** Агрегированные значения, без сырых текстов.

---

#### A3. `get_stage_history`

**Назначение:** История смены ступеней Ученика.

**JSON-схема входа:**
```json
{
  "tool": "get_stage_history",
  "input": {
    "limit": 10
  }
}
```

**JSON-схема выхода:**
```json
{
  "history": [
    {
      "date": "2025-12-15",
      "stage": "Случайный",
      "previous_stage": null,
      "reason": "Первичная диагностика",
      "key_metrics": {
        "hours_per_week": 1.5,
        "regularity_index": 0.14
      },
      "session_id": "session_2025-12-15_abc"
    },
    {
      "date": "2025-11-01",
      "stage": "Практикующий",
      "previous_stage": "Случайный",
      "reason": "Появился стабильный слот 20 мин/день",
      "key_metrics": {
        "hours_per_week": 4.2,
        "regularity_index": 0.57
      },
      "session_id": "session_2025-11-01_def"
    }
  ],
  "total_entries": 2,
  "current_stage": "Случайный"
}
```

---

#### A4. `upsert_learner_stage_evaluation`

**Назначение:** Записать или обновить оценку ступени.

**JSON-схема входа:**
```json
{
  "tool": "upsert_learner_stage_evaluation",
  "input": {
    "stage": "Практикующий",
    "reason": "Ежедневный слот 20+ минут стабильно 2 недели",
    "metrics_snapshot": {
      "hours_per_week": 4.5,
      "regularity_index": 0.64,
      "days_streak": 14,
      "daily_slot_minutes": 22
    },
    "confidence": 0.85
  }
}
```

**Допустимые значения `stage`:**
- `"Случайный"` / `"Random"`
- `"Практикующий"` / `"Practicing"`
- `"Систематический"` / `"Systematic"`
- `"Дисциплинированный"` / `"Disciplined"`
- `"Проактивный"` / `"Proactive"`

**JSON-схема выхода:**
```json
{
  "success": true,
  "evaluation_id": "eval_2025-12-20_abc123",
  "previous_stage": "Случайный",
  "new_stage": "Практикующий",
  "is_transition": true,
  "recorded_at": "2025-12-20T10:30:00Z"
}
```

---

### 3.2. Группа B. Маршрут и шаги маршрута

#### B1. `get_learning_route`

**Назначение:** Получить текущий маршрут Ученика.

**JSON-схема входа:**
```json
{
  "tool": "get_learning_route",
  "input": {}
}
```

**JSON-схема выхода:**
```json
{
  "route_id": "route_user123_v3",
  "version": 3,
  "created_at": "2025-12-10T08:00:00Z",
  "updated_at": "2025-12-18T14:30:00Z",
  "stage_focus": "Случайный",
  "goals": [
    {
      "id": "goal_1",
      "description": "Выйти на 15+ минут ежедневного слота",
      "target_date": "2025-12-31",
      "progress": 0.4,
      "status": "in_progress"
    }
  ],
  "steps": [
    {
      "id": "step_1",
      "title": "Установить напоминание на 8:00",
      "description": "Настроить ежедневное напоминание о слоте саморазвития",
      "type": "setup",
      "priority": 1,
      "status": "completed",
      "started_at": "2025-12-10T08:00:00Z",
      "completed_at": "2025-12-12T09:15:00Z"
    },
    {
      "id": "step_2",
      "title": "Провести первую неделю с 15-минутным слотом",
      "description": "Ежедневно выделять 15 минут на чтение руководства",
      "type": "daily_habit",
      "priority": 1,
      "status": "in_progress",
      "started_at": "2025-12-13T08:00:00Z",
      "completed_at": null,
      "progress_notes": "5 из 7 дней выполнено"
    },
    {
      "id": "step_3",
      "title": "Рефлексия по итогам недели",
      "description": "Написать короткий отчёт о первой неделе",
      "type": "reflection",
      "priority": 2,
      "status": "pending",
      "depends_on": ["step_2"]
    }
  ],
  "statistics": {
    "total_steps": 3,
    "completed": 1,
    "in_progress": 1,
    "pending": 1
  }
}
```

---

#### B2. `upsert_learning_route`

**Назначение:** Создать или обновить маршрут.

**JSON-схема входа:**
```json
{
  "tool": "upsert_learning_route",
  "input": {
    "goals": [
      {
        "description": "Закрепить ежедневный слот 15 минут",
        "target_date": "2026-01-15",
        "priority": 1
      },
      {
        "description": "Освоить базовые практики Ученика",
        "target_date": "2026-02-01",
        "priority": 2
      }
    ],
    "steps": [
      {
        "title": "Ежедневно: 15 минут чтения руководства",
        "description": "Читать раздел руководства по методике",
        "type": "daily_habit",
        "priority": 1,
        "estimated_minutes": 15
      },
      {
        "title": "Воскресенье: рефлексия за неделю",
        "description": "Написать короткий отчёт о прогрессе",
        "type": "weekly_reflection",
        "priority": 2,
        "estimated_minutes": 20
      },
      {
        "title": "Пройти тест на определение ступени",
        "description": "Самодиагностика текущего состояния",
        "type": "assessment",
        "priority": 3,
        "estimated_minutes": 10
      }
    ],
    "focus": "regularity",
    "stage_target": "Практикующий",
    "notes": "Фокус на формировании привычки ежедневного слота"
  }
}
```

**JSON-схема выхода:**
```json
{
  "success": true,
  "route_id": "route_user123_v4",
  "version": 4,
  "is_new": false,
  "goals_count": 2,
  "steps_count": 3,
  "created_at": "2025-12-20T11:00:00Z",
  "estimated_total_hours": 3.5
}
```

---

#### B3. `update_route_step_status`

**Назначение:** Обновить статус шага маршрута.

**JSON-схема входа:**
```json
{
  "tool": "update_route_step_status",
  "input": {
    "step_id": "step_2",
    "new_status": "completed",
    "comment": "Выполнено пользователем, 7 дней подряд по 15 минут",
    "actual_minutes": 105
  }
}
```

**Допустимые значения `new_status`:**
- `"pending"` — ожидает начала
- `"in_progress"` — в процессе
- `"completed"` — завершён
- `"skipped"` — пропущен
- `"blocked"` — заблокирован

**JSON-схема выхода:**
```json
{
  "success": true,
  "step_id": "step_2",
  "step_title": "Провести первую неделю с 15-минутным слотом",
  "previous_status": "in_progress",
  "new_status": "completed",
  "updated_at": "2025-12-20T18:30:00Z",
  "route_progress": {
    "completed": 2,
    "total": 3,
    "percentage": 66.7
  }
}
```

---

### 3.3. Группа C. Сессии Проводника и события

#### C1. `log_guide_session`

**Назначение:** Зафиксировать сессию Проводника.

**JSON-схема входа:**
```json
{
  "tool": "log_guide_session",
  "input": {
    "session_type": "weekly",
    "input_summary": "Пользователь спросил о прогрессе за неделю и попросил скорректировать план",
    "actions": [
      "Проведена диагностика показателей",
      "Подтверждена ступень Случайный",
      "Обновлён маршрут с фокусом на регулярность",
      "Даны рекомендации по защите слота от помех"
    ],
    "used_tools": [
      "get_learner_summary",
      "get_learner_core_metrics",
      "upsert_learning_route"
    ],
    "outcome": "Ступень подтверждена: Случайный, маршрут на неделю сформирован",
    "next_session_hint": "Проверить выполнение 7-дневного челленджа"
  }
}
```

**Допустимые значения `session_type`:**
- `"initial"` — первичная диагностика
- `"weekly"` — еженедельная сессия
- `"transition"` — сессия перехода на новую ступень
- `"reactivation"` — реактивация после провала
- `"check_in"` — короткая проверка

**JSON-схема выхода:**
```json
{
  "success": true,
  "session_id": "session_2025-12-20_xyz789",
  "session_type": "weekly",
  "recorded_at": "2025-12-20T19:00:00Z",
  "duration_estimate": "15 минут"
}
```

---

#### C2. `get_recent_guide_sessions`

**Назначение:** Получить последние сессии для контекста диалога.

**JSON-схема входа:**
```json
{
  "tool": "get_recent_guide_sessions",
  "input": {
    "limit": 5
  }
}
```

**JSON-схема выхода:**
```json
{
  "sessions": [
    {
      "session_id": "session_2025-12-15_abc",
      "date": "2025-12-15",
      "type": "weekly",
      "summary": "Диагностика, ступень Случайный, создан маршрут на неделю",
      "decisions": [
        "Цель: 15 минут/день",
        "Установить напоминание на 8:00"
      ],
      "outcome": "Маршрут принят пользователем"
    },
    {
      "session_id": "session_2025-12-08_def",
      "date": "2025-12-08",
      "type": "initial",
      "summary": "Первичная диагностика нового ученика",
      "decisions": [
        "Определена ступень Случайный",
        "Профиль застревания: Хаос"
      ],
      "outcome": "Создан первый маршрут"
    }
  ],
  "total_sessions": 2,
  "period_covered": {
    "from": "2025-12-08",
    "to": "2025-12-15"
  }
}
```

---

### 3.4. Группа D. Агрегаты и динамика

#### D1. `recalc_aggregates_for_period`

**Назначение:** Пересчитать производные показатели (IND.2.*) за период.

**JSON-схема входа:**
```json
{
  "tool": "recalc_aggregates_for_period",
  "input": {
    "period": "week",
    "force": false
  }
}
```

**Допустимые значения `period`:** `"day"`, `"week"`, `"month"`

**JSON-схема выхода:**
```json
{
  "success": true,
  "period": "week",
  "metrics_updated": [
    "2.1.1_hours_per_week",
    "2.1.2_regularity_index",
    "2.2.7_mastery_index"
  ],
  "recalculated_at": "2025-12-20T00:00:00Z",
  "processing_time_ms": 245
}
```

---

#### D2. `get_aggregate_trends`

**Назначение:** Получить динамику ключевых показателей.

**JSON-схема входа:**
```json
{
  "tool": "get_aggregate_trends",
  "input": {
    "metrics": [
      "2.1.1_hours_per_week",
      "2.1.2_regularity_index"
    ],
    "period": "8_weeks",
    "granularity": "week"
  }
}
```

**JSON-схема выхода:**
```json
{
  "trends": {
    "2.1.1_hours_per_week": {
      "values": [1.5, 2.0, 2.5, 3.0, 2.8, 3.2, 3.5, 4.0],
      "dates": ["2025-10-28", "2025-11-04", "2025-11-11", "2025-11-18", "2025-11-25", "2025-12-02", "2025-12-09", "2025-12-16"],
      "trend": "growing",
      "change_percent": 166.7
    },
    "2.1.2_regularity_index": {
      "values": [0.14, 0.21, 0.28, 0.35, 0.32, 0.42, 0.50, 0.57],
      "dates": ["2025-10-28", "2025-11-04", "2025-11-11", "2025-11-18", "2025-11-25", "2025-12-02", "2025-12-09", "2025-12-16"],
      "trend": "growing",
      "change_percent": 307.1
    }
  },
  "period": {
    "weeks": 8,
    "start": "2025-10-28",
    "end": "2025-12-20"
  },
  "summary": "Положительная динамика по обоим показателям"
}
```

---

### 3.5. Группа E. Универсальные tools

#### E1. `read_entities`

**Назначение:** Читать сущности по фильтрам (универсальный доступ).

**JSON-схема входа:**
```json
{
  "tool": "read_entities",
  "input": {
    "entity_type": "slot",
    "filters": {
      "status": "completed",
      "date_from": "2025-12-01"
    },
    "limit": 20,
    "order_by": "date",
    "order_direction": "desc"
  }
}
```

**JSON-схема выхода:**
```json
{
  "entities": [
    {
      "id": "slot_123",
      "type": "slot",
      "date": "2025-12-19",
      "duration_minutes": 25,
      "status": "completed",
      "activity_type": "reading"
    }
  ],
  "total_count": 15,
  "returned_count": 15,
  "has_more": false
}
```

---

#### E2. `upsert_entity`

**Назначение:** Создать или обновить сущность (универсальная запись).

**JSON-схема входа:**
```json
{
  "tool": "upsert_entity",
  "input": {
    "entity_type": "slot",
    "entity_id": "slot_new_123",
    "data": {
      "date": "2025-12-20",
      "planned_duration_minutes": 20,
      "activity_type": "reading",
      "status": "planned"
    }
  }
}
```

**JSON-схема выхода:**
```json
{
  "success": true,
  "entity_id": "slot_new_123",
  "entity_type": "slot",
  "operation": "created",
  "timestamp": "2025-12-20T07:00:00Z"
}
```

---

## 4. Примеры тестирования для разных ролей

### 4.1. Примеры для пользователя (ученика)

| # | Что спрашивает пользователь | Какой tool вызывается | Что получает в ответ |
|---|----------------------------|----------------------|---------------------|
| 1 | "Привет! Как у меня дела с обучением?" | A1 `get_learner_summary` | Сводка: часы, сессии, активность |
| 2 | "На какой я ступени Ученика?" | A2 `get_learner_core_metrics` | Ступень + показатели + рекомендации |
| 3 | "Покажи мою историю развития" | A3 `get_stage_history` | Таймлайн смены ступеней |
| 4 | "Какой у меня сейчас план?" | B1 `get_learning_route` | Цели, шаги, статусы |
| 5 | "Составь мне план на неделю" | A2 + B2 | Диагностика + новый маршрут |
| 6 | "Я выполнил первый шаг!" | B3 `update_route_step_status` | Подтверждение + мотивация |
| 7 | "О чём мы говорили в прошлый раз?" | C2 `get_recent_guide_sessions` | Краткое содержание прошлых сессий |
| 8 | "Покажи динамику моего прогресса" | D2 `get_aggregate_trends` | Графики/числа по неделям |
| 9 | "Я готов к следующей ступени!" | A2 + A4 | Проверка критериев + переход |

### 4.2. Примеры для разработчика Проводника

**Сценарий: Первичная диагностика**
```
1. Пользователь: "Привет, я новый ученик"
2. Проводник вызывает: get_learner_summary(period="4_weeks")
3. Проводник вызывает: get_learner_core_metrics(period="4_weeks")
4. Анализ: часы < 2/неделю, регулярность < 0.3 → ступень "Случайный"
5. Проводник вызывает: upsert_learner_stage_evaluation(stage="Случайный", ...)
6. Проводник вызывает: upsert_learning_route(focus="regularity", ...)
7. Проводник вызывает: log_guide_session(type="initial", ...)
8. Ответ пользователю: "Твоя ступень — Случайный. Вот план на первую неделю..."
```

**Сценарий: Еженедельная сессия**
```
1. Пользователь: "Как мои дела за неделю?"
2. Проводник вызывает: get_recent_guide_sessions(limit=1) — контекст
3. Проводник вызывает: get_learner_summary(period="1_week")
4. Проводник вызывает: get_learning_route()
5. Сравнение: план vs факт
6. При необходимости: update_route_step_status(...) для выполненных шагов
7. Проводник вызывает: log_guide_session(type="weekly", ...)
8. Ответ: "За неделю ты... Рекомендую на следующую неделю..."
```

### 4.3. Примеры для разработчика интерфейса (GPT ↔ MCP)

**Формат запроса от GPT к MCP-серверу:**
```http
POST https://digital-twin-mcp.aisystant.workers.dev/mcp
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "id": "req_123",
  "method": "tools/call",
  "params": {
    "name": "get_learner_core_metrics",
    "arguments": {
      "period": "4_weeks"
    }
  }
}
```

**Формат ответа от MCP-сервера:**
```json
{
  "jsonrpc": "2.0",
  "id": "req_123",
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"metrics\":{\"2.1.1_hours_per_week\":3.2,...},\"interpretation\":{...}}"
      }
    ]
  }
}
```

**Обработка ошибок:**
```json
{
  "jsonrpc": "2.0",
  "id": "req_123",
  "error": {
    "code": -32602,
    "message": "Invalid params: period must be one of: 4_weeks, 8_weeks, 3_months"
  }
}
```

---

## 5. Сценарии использования Проводником

### 5.1. Функции Проводника по ступеням Ученика

| Функция | Описание | Ключевые tools |
|---------|----------|----------------|
| Диагностика ступени | Определение текущей ступени и профиля застревания | A1, A2, A4 |
| Формирование маршрута | Выбор приоритетов, подбор объёма времени и практик | B1, B2 |
| Сопровождение маршрута | Отслеживание выполнения, обнаружение провалов | B1, B3, C1 |
| Рефлексия | Опора на рефлексивные тексты и историю | C2, A3 |
| Анализ динамики | Скорость прохождения ступеней, тренды | D2, A3 |

### 5.2. Сценарий 1: Первичная диагностика нового ученика

**Ситуация:** Человек впервые приходит к Проводнику.

**Последовательность вызовов:**
```
1. get_learner_summary(period="4_weeks")     → базовая сводка
2. get_learner_core_metrics(period="4_weeks") → ядро показателей
3. upsert_learner_stage_evaluation(stage=...) → запись ступени
4. upsert_learning_route(...)                 → создание маршрута
5. log_guide_session(type="initial")          → фиксация сессии
```

### 5.3. Сценарий 2: Еженедельное сопровождение

**Ситуация:** Регулярная сессия для корректировки плана.

**Последовательность вызовов:**
```
1. get_recent_guide_sessions(limit=1)         → контекст прошлой сессии
2. get_learner_summary(period="1_week")       → сводка за неделю
3. get_learner_core_metrics(period="4_weeks") → тренды
4. get_learning_route()                       → текущий маршрут
5. [Диалог с человеком]
6. update_route_step_status(...)              → обновление статусов
7. upsert_learning_route(...)                 → корректировка (если нужно)
8. log_guide_session(type="weekly")           → фиксация
```

### 5.4. Сценарий 3: Переход на следующую ступень

**Ситуация:** Человек «подпирает» следующую ступень.

**Последовательность вызовов:**
```
1. get_stage_history()                        → история ступеней
2. get_learner_core_metrics(period="8_weeks") → расширенный период
3. [Диалог: проверка готовности]
4. upsert_learner_stage_evaluation(stage=...) → переход
5. upsert_learning_route(focus=...)           → переходный маршрут
6. log_guide_session(type="transition")       → фиксация перехода
```

### 5.5. Сценарий 4: Реактивация после провала

**Ситуация:** Длительное отсутствие слотов, падение активности.

**Последовательность вызовов:**
```
1. get_learner_core_metrics(period="4_weeks") → особенно застревание
2. get_learning_route()                       → последний маршрут
3. [Диалог о причинах провала]
4. upsert_learner_stage_evaluation(stage=...) → возможный откат
5. upsert_learning_route(minimal_slot=15)     → компактный маршрут
6. log_guide_session(type="reactivation")     → фиксация
```

---

## 6. Связь tools со ступенями Ученика

| Переход | Задачи Проводника | Ключевые tools |
|---------|-------------------|----------------|
| **Случайный → Практикующий** | Вытащить из хаоса, запустить 15+ мин/день | A1, A2, A4, B2, C1 |
| **Практикующий → Систематический** | Стабилизировать слот на 4+ недель | A1, A2, B1, B2, B3, C1, C2 |
| **Систематический → Дисциплинированный** | Увеличить до 10+ часов/неделю на 3+ месяца | A2, B1, B2, B3, D2, C1, C2 |
| **Дисциплинированный → Проактивный** | Сместить фокус к инициативе, образу будущего | A2, A3, B1, B2, D2, C1, C2 |

---

## 7. Чек-лист тестирования

### 7.1. Функциональное тестирование tools

| # | Tool | Тест-кейс (запрос пользователя) | Ожидаемый результат | Статус |
|---|------|--------------------------------|---------------------|--------|
| 1 | A1 `get_learner_summary` | "Как у меня дела за месяц?" | Сводка с часами, сессиями, активностью | ⬜ |
| 2 | A2 `get_learner_core_metrics` | "На какой я ступени?" | Ступень, показатели, интерпретация | ⬜ |
| 3 | A3 `get_stage_history` | "Покажи историю развития" | Список смен ступеней с датами | ⬜ |
| 4 | A4 `upsert_learner_stage_evaluation` | [После диагностики перехода] | Запись новой оценки ступени | ⬜ |
| 5 | B1 `get_learning_route` | "Какой у меня план?" | Цели, шаги со статусами | ⬜ |
| 6 | B2 `upsert_learning_route` | "Составь план на неделю" | Создание/обновление маршрута | ⬜ |
| 7 | B3 `update_route_step_status` | "Я выполнил первый шаг!" | Обновление статуса шага | ⬜ |
| 8 | C1 `log_guide_session` | [Автоматически после сессии] | Логирование сессии | ⬜ |
| 9 | C2 `get_recent_guide_sessions` | "О чём мы говорили?" | История последних сессий | ⬜ |
| 10 | D1 `recalc_aggregates_for_period` | [Фоновый пересчёт] | Обновление агрегатов | ⬜ |
| 11 | D2 `get_aggregate_trends` | "Покажи динамику прогресса" | Временные ряды показателей | ⬜ |
| 12 | E1 `read_entities` | [Универсальное чтение] | Список сущностей по фильтрам | ⬜ |
| 13 | E2 `upsert_entity` | [Универсальная запись] | Создание/обновление сущности | ⬜ |

### 7.2. Интеграционное тестирование сценариев

| # | Сценарий | Последовательность tools | Ожидаемый результат | Статус |
|---|----------|-------------------------|---------------------|--------|
| 1 | Первичная диагностика | A1 → A2 → A4 → B2 → C1 | Определена ступень, создан маршрут | ⬜ |
| 2 | Еженедельная сессия | C2 → A1 → A2 → B1 → B3 → C1 | Прогресс отслежен, маршрут обновлён | ⬜ |
| 3 | Переход ступени | A3 → A2 → A4 → B2 → C1 | Ступень повышена, маршрут адаптирован | ⬜ |
| 4 | Реактивация | A2 → B1 → A4 → B2 → C1 | Ступень скорректирована, план упрощён | ⬜ |

### 7.3. Тестирование граничных случаев

| # | Случай | Что проверяем | Ожидаемое поведение | Статус |
|---|--------|---------------|---------------------|--------|
| 1 | Новый пользователь без данных | A1, A2 с пустой историей | Корректная обработка, ступень "Случайный" | ⬜ |
| 2 | Неверный период | A2 с period="invalid" | Понятное сообщение об ошибке | ⬜ |
| 3 | Несуществующий step_id | B3 с неверным ID | Ошибка "step not found" | ⬜ |
| 4 | Попытка понизить ступень | A4 с более низкой ступенью | Предупреждение или запрет | ⬜ |
| 5 | Конкурентное обновление маршрута | B2 дважды одновременно | Корректная версионность | ⬜ |

---

## 8. Рекомендации по доработке

### 8.1. Недостающие tools (для будущих версий)

| Tool | Назначение | Приоритет |
|------|------------|-----------|
| `get_learner_stagnation_profile` | Детальный профиль застревания (Хаос/Тупик/Скачки) | Высокий |
| `get_transition_readiness` | Готовность к переходу на следующую ступень | Высокий |
| `create_nudge` | Создать напоминание/подталкивание | Средний |
| `get_peer_comparison` | Сравнение с похожими учениками (анонимно) | Низкий |
| `export_progress_report` | Экспорт отчёта о прогрессе | Низкий |

### 8.2. Улучшения существующих tools

- **A2**: Добавить поле `recommendations[]` с конкретными действиями
- **B1**: Добавить поле `next_milestone` с ближайшей вехой
- **C1**: Добавить автоматическое определение `session_type` по контексту

---

## Связанные документы

- [[Модель данных цифрового двойника 3.2]] — модель данных первичных и производных показателей
- [[Описание цифрового двойника 3.2]] — обзор подсистемы цифрового двойника
- [[Описание ИИ-ассистента Проводник (Ассистент Ученика) 3.2]] — описание ИИ-Проводника
- [[Концепция Проводника (Ассистент Ученика) 3.2]] — техническая архитектура Проводника
- [[Централизованное хранилище 3.2]] — техническая реализация хранилища

---

## Changelog / История версий

| Дата | Версия | Автор | Изменения |
|------|--------|-------|-----------|
| 2025-12-20 | v2.0 | — | Добавлен раздел "Текущее развёртывание" с URL GPT и MCP-сервера. Добавлены JSON-схемы входов/выходов для всех tools. Добавлен раздел "Примеры тестирования для разных ролей". Добавлен "Чек-лист тестирования". Добавлен раздел "Рекомендации по доработке". Обновлены связанные документы |
| 2025-12-09 | v1.0 | — | Создан документ, перенесён из 0.9. Входящие, оформлен по стандартам |
