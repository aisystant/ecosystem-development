#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–±–æ—Ä–∫–∏ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (0.5)
–Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ 0.91

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python ops/build_check_document.py

    # –° AI-–∞–Ω–∞–ª–∏–∑–æ–º –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π (—Ç—Ä–µ–±—É–µ—Ç OPENAI_API_KEY)
    export OPENAI_API_KEY=your_key
    python ops/build_check_document.py --ai-analysis

–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤: content/0. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ/0.5. –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç.md

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- –¶–∏—Ñ—Ä–æ–≤—ã–µ —Ä–∞–∑–¥–µ–ª—ã (1, 2, 3...) - –∑–∞–≥–æ–ª–æ–≤–∫–∏ —É—Ä–æ–≤–Ω—è 2 (##)
- –ë—É–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã (A, B, C...) - –∑–∞–≥–æ–ª–æ–≤–∫–∏ —É—Ä–æ–≤–Ω—è 3 (###)
- –¢–µ–∫—Å—Ç —Å –º–∞—Ä–∫–µ—Ä–æ–º "<!-- –ù–µ –¥–ª—è –ò–ò -->" –∏–ª–∏ –Ω–∏–∂–µ "---\n–ù–µ –¥–ª—è —á—Ç–µ–Ω–∏—è –ò–ò" –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è
"""

import os
import re
import sys
import argparse
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Optional

# –ë–∞–∑–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞
BASE_DIR = Path(__file__).parent.parent

def load_env_file():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞ –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"""
    env_file = BASE_DIR / '.env'
    if env_file.exists():
        with open(env_file, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                if line and not line.startswith('#') and '=' in line:
                    key, value = line.split('=', 1)
                    # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                    value = value.strip().strip('"').strip("'")
                    os.environ[key.strip()] = value
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω .env —Ñ–∞–π–ª: {env_file}")
    else:
        print(f"‚ÑπÔ∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)")

# –ó–∞–≥—Ä—É–∂–∞–µ–º .env —Ñ–∞–π–ª –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
load_env_file()
CONTENT_DIR = BASE_DIR / "content"

# –ú–∞—Ä–∫–µ—Ä—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ AI
EXCLUDE_MARKERS = [
    "<!-- –ù–µ –¥–ª—è –ò–ò -->",
    "<!-- –Ω–µ –¥–ª—è –∏–∏ -->",
    "–ù–µ –¥–ª—è —á—Ç–µ–Ω–∏—è –ò–ò",
    "–Ω–µ –¥–ª—è —á—Ç–µ–Ω–∏—è –∏–∏",
    "Not for AI",
]

# –ú–∞–ø–ø–∏–Ω–≥ —Ä–∞–∑–¥–µ–ª–æ–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
# –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
# –ù—É–º–µ—Ä–∞—Ü–∏—è: 1., 1.1., 1.1.1., 1.1.2., 1.2., 2., 2.1., –∏ —Ç.–¥.
DOCUMENT_MAPPING = {
    "1": {
        "title": "–ó–∞—á–µ–º, –¥–ª—è –∫–æ–≥–æ, —á—Ç–æ –º—ã –¥–µ–ª–∞–µ–º",
        "subsections": {
            "1.1": {
                "title": "–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.4. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¶–ê.md"],
                "extract_sections": ["# 0. –ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ"]
            },
            "1.2": {
                "title": "–£–∫—Ä—É–ø–Ω—ë–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.4. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¶–ê.md"],
                "extract_sections": ["## A. –£–∫—Ä—É–ø–Ω—ë–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞"]
            },
            "1.3": {
                "title": "–ú–∞–Ω–∏—Ñ–µ—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞",
                "sources": ["2. –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ/–ú–∞–Ω–∏—Ñ–µ—Å—Ç.md"],
                "extract_sections": []
            }
        }
    },
    "2": {
        "title": "–ü—Ä–æ–±–ª–µ–º—ã, –≥–∏–ø–æ—Ç–µ–∑—ã –∏ —Ü–µ–ª–∏",
        "subsections": {
            "2.1": {
                "title": "–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.1. –ü—Ä–æ–±–ª–µ–º—ã.md"],
                "summarize": True
            },
            "2.2": {
                "title": "–ì–∏–ø–æ—Ç–µ–∑—ã —Ä–µ—à–µ–Ω–∏—è",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.2. –ì–∏–ø–æ—Ç–µ–∑—ã.md"],
                "summarize": True
            },
            "2.3": {
                "title": "–¶–µ–ª–∏ –∏ –∑–∞–¥–∞—á–∏",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.5. –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–µ–π –∏ –∑–∞–¥–∞—á.md"],
                "summarize": True
            }
        }
    },
    "3": {
        "title": "–§—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã",
        "subsections": {
            "3.1": {
                "title": "–ì–ª–∞–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.4. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¶–ê.md"],
                "extract_sections": ["## B. –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã"]
            },
            "3.2": {
                "title": "–ö–æ–Ω—Ü–µ–ø—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–æ–ª–µ–π",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.4. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¶–ê.md"],
                "extract_sections": ["## F. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"]
            }
        }
    },
    "4": {
        "title": "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Å–∏—Å—Ç–µ–º—ã",
        "subsections": {
            "4.1": {
                "title": "–°–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∏—Å—Ç–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.4. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¶–ê.md"],
                "extract_sections": ["## C. –°–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∏—Å—Ç–µ–º"]
            },
            "4.2": {
                "title": "–î–∞–Ω–Ω—ã–µ –∏ –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.4. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¶–ê.md"],
                "extract_sections": ["## D. –î–∞–Ω–Ω—ã–µ –∏ –ú–ò–ú"]
            },
            "4.3": {
                "title": "–≠–ø–∏—Å—Ç–µ–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—è",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.4. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¶–ê.md"],
                "extract_sections": ["## E. –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"]
            }
        }
    },
    "5": {
        "title": "–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
        "subsections": {
            "5.1": {
                "title": "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞–±–æ—Ç—ã",
                "sources": ["0. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ/0.8. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞–±–æ—Ç—ã.md"],
                "extract_sections": ["### –ö–∞–∫ –∏–¥—ë—Ç —Ä–∞–±–æ—Ç–∞"]
            },
            "5.2": {
                "title": "–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Ç–µ–≥–∏",
                "sources": ["0. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ/0.7. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —Ç–µ–≥–∏.md"],
                "extract_sections": ["## –ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞", "## –ö–∞—Ä—Ç–∞"]
            }
        }
    },
    "6": {
        "title": "–ö—É–ª—å—Ç—É—Ä–∞ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–∞—á–µ—Å—Ç–≤–∞",
        "subsections": {
            "6.1": {
                "title": "–ü—Ä–∏–Ω—Ü–∏–ø—ã –∫—É–ª—å—Ç—É—Ä—ã",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.4. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¶–ê.md"],
                "extract_sections": ["## G. –ö—É–ª—å—Ç—É—Ä–∞ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–∞—á–µ—Å—Ç–≤–∞"]
            },
            "6.2": {
                "title": "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –∏ ADR",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.4. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¶–ê.md"],
                "extract_sections": ["## H. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã"]
            }
        }
    },
    "7": {
        "title": "–ú–µ—Ç—Ä–∏–∫–∏ –∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è",
        "subsections": {
            "7.1": {
                "title": "–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏",
                "sources": ["1. –ò–¥–µ–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã/1.4. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¶–ê.md"],
                "extract_sections": ["## I. –ú–µ—Ç—Ä–∏–∫–∏"]
            }
        }
    },
    "8": {
        "title": "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è—Ö –∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è—Ö",
        "description": "AI-–∞–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å —Ñ–ª–∞–≥–æ–º --ai-analysis"
    }
}


def filter_ai_excluded_content(content: str) -> str:
    """
    –£–¥–∞–ª—è–µ—Ç —Ç–µ–∫—Å—Ç, –ø–æ–º–µ—á–µ–Ω–Ω—ã–π –∫–∞–∫ '–ù–µ –¥–ª—è –ò–ò'

    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
    1. <!-- –ù–µ –¥–ª—è –ò–ò --> ... <!-- /–ù–µ –¥–ª—è –ò–ò -->
    2. –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ "---\n–ù–µ –¥–ª—è —á—Ç–µ–Ω–∏—è –ò–ò"
    """
    # –£–¥–∞–ª—è–µ–º –±–ª–æ–∫–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
    for marker in EXCLUDE_MARKERS:
        # HTML –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        pattern = rf'<!--\s*{re.escape(marker)}\s*-->.*?<!--\s*/.*?-->'
        content = re.sub(pattern, '', content, flags=re.DOTALL | re.IGNORECASE)

    # –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø–æ—Å–ª–µ –º–∞—Ä–∫–µ—Ä–∞ "–ù–µ –¥–ª—è —á—Ç–µ–Ω–∏—è –ò–ò"
    for marker in EXCLUDE_MARKERS:
        pattern = rf'---\s*\n\s*{re.escape(marker)}.*'
        content = re.sub(pattern, '', content, flags=re.DOTALL | re.IGNORECASE)

    return content


def read_document(file_path: Path) -> str:
    """–ß–∏—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        return filter_ai_excluded_content(content)
    except FileNotFoundError:
        return f"‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}"


def extract_sections(content: str, sections: List[str]) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
    result = []
    lines = content.split('\n')
    capturing = False
    current_level = 0

    for line in lines:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª–æ –Ω—É–∂–Ω–æ–π —Å–µ–∫—Ü–∏–∏
        for section in sections:
            if line.strip().startswith(section):
                capturing = True
                current_level = line.count('#')
                result.append(line)
                break
        else:
            if capturing:
                # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞—Ö–≤–∞—Ç –ø—Ä–∏ –≤—Å—Ç—Ä–µ—á–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–æ–≥–æ –∂–µ –∏–ª–∏ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è
                line_level = 0
                if line.startswith('#'):
                    line_level = len(line) - len(line.lstrip('#'))

                if line_level > 0 and line_level <= current_level:
                    is_new_section = any(line.strip().startswith(s) for s in sections)
                    if not is_new_section:
                        capturing = False
                        continue

                if capturing:
                    result.append(line)

    return '\n'.join(result)


def extract_section_content_without_header(content: str, section_header: str) -> str:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –°–û–î–ï–†–ñ–ò–ú–û–ï —Ä–∞–∑–¥–µ–ª–∞ –ë–ï–ó –µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞.
    –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è "## B. –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã" –≤–µ—Ä–Ω—ë—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞,
    –ø—Ä–æ–ø—É—Å—Ç–∏–≤ —Å–∞–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "## B. –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã"
    """
    result = []
    lines = content.split('\n')
    capturing = False
    current_level = 0
    skip_first_header = True  # –§–ª–∞–≥ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞

    for line in lines:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª–æ –Ω—É–∂–Ω–æ–π —Å–µ–∫—Ü–∏–∏
        if line.strip().startswith(section_header):
            capturing = True
            current_level = line.count('#')
            # –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º —Å–∞–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ result
            skip_first_header = True
            continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É

        if capturing:
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞—Ö–≤–∞—Ç –ø—Ä–∏ –≤—Å—Ç—Ä–µ—á–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–æ–≥–æ –∂–µ –∏–ª–∏ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è
            line_level = 0
            if line.startswith('#'):
                line_level = len(line) - len(line.lstrip('#'))

            if line_level > 0 and line_level <= current_level:
                # –í—Å—Ç—Ä–µ—Ç–∏–ª–∏ –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª —Ç–æ–≥–æ –∂–µ —É—Ä–æ–≤–Ω—è - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                capturing = False
                continue

            # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result.append(line)

    return '\n'.join(result)


def summarize_section(content: str, max_items: int = 10) -> str:
    """–°–æ–∑–¥–∞–µ—Ç –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É —Ä–∞–∑–¥–µ–ª–∞"""
    lines = content.split('\n')
    important_lines = []

    for line in lines:
        # –°–æ–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –≤–∞–∂–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
        if (line.startswith('#') or
            line.strip().startswith('**') or
            line.strip().startswith('-') or
            line.strip().startswith('*')):
            important_lines.append(line)
            if len(important_lines) >= max_items:
                break

    return '\n'.join(important_lines[:max_items])


def adjust_heading_levels(content: str, section_num: str) -> str:
    """
    –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç —É—Ä–æ–≤–Ω–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:
    - –¶–∏—Ñ—Ä–æ–≤—ã–µ —Ä–∞–∑–¥–µ–ª—ã (1-9) -> H2
    - –ë—É–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã (–æ–¥–Ω–∞ –∑–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞ A-Z, –ê-–Ø –≤ –Ω–∞—á–∞–ª–µ) -> H3
    - –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ -> H4 –∏ –Ω–∏–∂–µ
    """
    lines = content.split('\n')
    result = []

    for line in lines:
        if line.startswith('#'):
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞
            heading_match = re.match(r'^(#+)\s*(.+)$', line)
            if heading_match:
                hashes, text = heading_match.groups()
                current_level = len(hashes)

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª —Ç–µ–∫—Å—Ç–∞ (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)
                text_start = text.lstrip()

                # –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Å —Ü–∏—Ñ—Ä—ã
                if text_start and text_start[0].isdigit():
                    # –¶–∏—Ñ—Ä–æ–≤–æ–π —Ä–∞–∑–¥–µ–ª -> H2
                    line = f"## {text}"
                # –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Å –æ–¥–Ω–æ–π –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã + —Ç–æ—á–∫–∞/–ø—Ä–æ–±–µ–ª
                # –ù–∞–ø—Ä–∏–º–µ—Ä: "A. ", "B. ", "–ê. ", "–ë. "
                elif (text_start and len(text_start) > 1 and
                      text_start[0].isupper() and text_start[0].isalpha() and
                      (text_start[1] == '.' or text_start[1] == ' ' or text_start[1] == ')') and
                      (ord(text_start[0]) < 128 or ord('–ê') <= ord(text_start[0]) <= ord('–Ø'))):
                    # –ë—É–∫–≤–µ–Ω–Ω—ã–π –ø–æ–¥—Ä–∞–∑–¥–µ–ª -> H3
                    line = f"### {text}"
                else:
                    # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ -> –º–∏–Ω–∏–º—É–º H4
                    # –ï—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –±—ã–ª H1-H3, –¥–µ–ª–∞–µ–º H4
                    # –ï—Å–ª–∏ –±—ã–ª H4+, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                    if current_level <= 3:
                        line = f"#### {text}"
                    else:
                        # –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                        line = f"{'#' * current_level} {text}"

        result.append(line)

    return '\n'.join(result)


def build_section(section_num: str, config: Dict) -> str:
    """–°–æ–±–∏—Ä–∞–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑–¥–µ–ª –∏–ª–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π"""
    result = []

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ç–æ—á–µ–∫
    depth = section_num.count('.')

    # –í—ã–±–∏—Ä–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∑–∞–≥–æ–ª–æ–≤–∫–∞:
    # 1. -> H2 (##) - –Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ build_check_document
    # 1.1 -> H3 (###)
    # 1.1.1 -> H4 (####)
    # 1.1.1.1 -> H5 (#####)
    if depth == 1:  # –ü–æ–¥—Ä–∞–∑–¥–µ–ª –≤—Ç–æ—Ä–æ–≥–æ —É—Ä–æ–≤–Ω—è (1.1, 2.1)
        heading = f"\n### {section_num}. {config['title']}\n"
    elif depth == 2:  # –ü–æ–¥—Ä–∞–∑–¥–µ–ª —Ç—Ä–µ—Ç—å–µ–≥–æ —É—Ä–æ–≤–Ω—è (1.1.1)
        heading = f"\n#### {section_num}. {config['title']}\n"
    elif depth >= 3:  # –ü–æ–¥—Ä–∞–∑–¥–µ–ª —á–µ—Ç–≤–µ—Ä—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è (1.1.1.1)
        heading = f"\n##### {section_num}. {config['title']}\n"
    else:  # depth == 0 - —Ä–∞–∑–¥–µ–ª –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è (1, 2, 3)
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ build_check_document, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
        heading = ""

    if heading:
        result.append(heading)

    # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –µ—Å–ª–∏ –µ—Å—Ç—å sources
    if 'sources' in config:
        for source in config['sources']:
            source_path = CONTENT_DIR / source
            content = read_document(source_path)

            if "‚ö†Ô∏è" in content:
                result.append(content)
                continue

            # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω—É–∂–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –∏–ª–∏ –¥–µ–ª–∞–µ–º —Å–≤–æ–¥–∫—É
            if 'extract_sections' in config and config['extract_sections']:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ë–ï–ó –∑–∞–≥–æ–ª–æ–≤–∫–∞
                extracted_parts = []
                for section_header in config['extract_sections']:
                    extracted = extract_section_content_without_header(content, section_header)
                    if extracted.strip():
                        extracted_parts.append(extracted)

                if extracted_parts:
                    combined = '\n\n'.join(extracted_parts)
                    # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–ø–æ–Ω–∏–∂–∞–µ–º —É—Ä–æ–≤–µ–Ω—å)
                    adjusted = adjust_heading_levels(combined, section_num)
                    result.append(adjusted)
            elif config.get('summarize'):
                summary = summarize_section(content)
                # –¢–∞–∫–∂–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫ —Å–≤–æ–¥–∫–µ
                adjusted_summary = adjust_heading_levels(summary, section_num)
                result.append(adjusted_summary)
            elif not config.get('extract_sections'):  # –ï—Å–ª–∏ extract_sections –ø—É—Å—Ç–æ–π, –±–µ—Ä—ë–º –≤–µ—Å—å —Ñ–∞–π–ª
                # –ë–µ—Ä—ë–º –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç
                adjusted_content = adjust_heading_levels(content, section_num)
                result.append(adjusted_content)

    return '\n'.join(result)


def collect_all_documents() -> str:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ markdown –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞

    Returns:
        –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
    """
    all_content = []

    # –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã
    exclude_patterns = ['.keep', 'README', 'Template', 'Agent-Template']

    print("üìö –°–æ–±–∏—Ä–∞—é –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞...")

    for md_file in sorted(CONTENT_DIR.rglob("*.md")):
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã
        if any(pattern in md_file.name for pattern in exclude_patterns):
            continue

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ä–µ–∫—É—Ä—Å–∏–∏
        if "0.5. –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç" in md_file.name:
            continue

        try:
            content = read_document(md_file)
            if content and not content.startswith("‚ö†Ô∏è"):
                # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø—É—Ç—ë–º –∫ —Ñ–∞–π–ª—É
                relative_path = md_file.relative_to(CONTENT_DIR)
                all_content.append(f"\n## üìÑ {relative_path}\n")
                all_content.append(content)
                all_content.append("\n---\n")
        except Exception as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {md_file.name}: {e}")
            continue

    full_content = '\n'.join(all_content)
    doc_count = len([c for c in all_content if 'üìÑ' in c])
    print(f"üìä –°–æ–±—Ä–∞–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: {doc_count}")
    print(f"üìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: {len(full_content):,} —Å–∏–º–≤–æ–ª–æ–≤")

    return full_content


def analyze_contradictions_with_ai(sections_content: str) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤–æ –í–°–ï–• –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å –ø–æ–º–æ—â—å—é AI

    Args:
        sections_content: –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

    Returns:
        –¢–µ–∫—Å—Ç —Ä–∞–∑–¥–µ–ª–∞ 9 —Å –∞–Ω–∞–ª–∏–∑–æ–º –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π
    """
    try:
        import openai
        from openai import OpenAI
    except ImportError:
        return """
## 9. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è—Ö –∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è—Ö

‚ö†Ô∏è **AI-–∞–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**: –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞–∫–µ—Ç `openai`

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: `pip install openai`

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –æ–±–ª–∞—Å—Ç–∏ –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è:
1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–ª–µ–π –∏ —Å–∏—Å—Ç–µ–º
2. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
4. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏
"""

    api_key = os.getenv('OPENAI_API_KEY')
    if not api_key:
        return """
## 9. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è—Ö –∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è—Ö

‚ö†Ô∏è **AI-–∞–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**: –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω OPENAI_API_KEY

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
export OPENAI_API_KEY=your_api_key
```

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –æ–±–ª–∞—Å—Ç–∏ –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è:
1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–ª–µ–π –∏ —Å–∏—Å—Ç–µ–º
2. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
4. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏
"""

    print("ü§ñ –ó–∞–ø—É—Å–∫–∞—é AI-–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π...")

    try:
        client = OpenAI(api_key=api_key)

        # –°–æ–±–∏—Ä–∞–µ–º –í–°–ï –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        all_documents = collect_all_documents()

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è OpenAI (128K —Ç–æ–∫–µ–Ω–æ–≤ ‚âà 512K —Å–∏–º–≤–æ–ª–æ–≤, –±–µ—Ä—ë–º —Å –∑–∞–ø–∞—Å–æ–º)
        # GPT-4o-mini –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 128K —Ç–æ–∫–µ–Ω–æ–≤ –≤—Ö–æ–¥–∞
        max_chars = 400000  # ~100K —Ç–æ–∫–µ–Ω–æ–≤
        if len(all_documents) > max_chars:
            print(f"‚ö†Ô∏è  –î–æ–∫—É–º–µ–Ω—Ç—ã –æ–±—Ä–µ–∑–∞–Ω—ã: {len(all_documents):,} ‚Üí {max_chars:,} —Å–∏–º–≤–æ–ª–æ–≤")
            all_documents = all_documents[:max_chars]

        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–°–ï –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã —Ä–∞–∑–≤–∏—Ç–∏—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –ø–æ –í–°–ï–ú–£ –†–ï–ü–û–ó–ò–¢–û–†–ò–Æ.

–í–ê–ñ–ù–û: –ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –í–°–ï –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –∫–∞–∂–¥—ã–π —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º ## üìÑ –ø—É—Ç—å/–∫/—Ñ–∞–π–ª—É
–î–æ–∫—É–º–µ–Ω—Ç—ã –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –ø–æ –∏–µ—Ä–∞—Ä—Ö–∏–∏: –æ—Ç –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö (–ø–∞–ø–∫–∞ "0. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ") –¥–æ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π —Å–∏—Å—Ç–µ–º.

–í–°–ï –î–û–ö–£–ú–ï–ù–¢–´ –ü–†–û–ï–ö–¢–ê:
{all_documents}

–ó–ê–î–ê–ß–ò –ê–ù–ê–õ–ò–ó–ê –ü–û –í–°–ï–ú–£ –†–ï–ü–û–ó–ò–¢–û–†–ò–Æ:

1. **–ò–µ—Ä–∞—Ä—Ö–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑)**:
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏–∑ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (0. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, 1. –ò–¥–µ–∏) –≤ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö (4. –°–∏—Å—Ç–µ–º—ã)?
   - –°–æ–±–ª—é–¥–∞—é—Ç –ª–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è?

2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (—Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö)**:
   - –ú–æ–≥—É—Ç –ª–∏ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –≤–ª–∏—è—Ç—å –Ω–∞ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã?
   - –ï—Å—Ç—å –ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≥–¥–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–º–∏ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º–∏?

3. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–ª–µ–π –∏ —Å–∏—Å—Ç–µ–º**:
   - –í—Å–µ –ª–∏ –æ–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∑–∞—è–≤–ª–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏?
   - –ù–µ—Ç –ª–∏ —Å–∏—Å—Ç–µ–º –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç —Ü–µ–ª—è–º?

4. **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã**:
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–∞–±–æ—Ç—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å–∏—Å—Ç–µ–º?

5. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏**:
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ª–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ?

6. **–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å**:
   - –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã –ª–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã —ç–∫–æ–Ω–æ–º–∏–∫–∏ –≤–∫–ª–∞–¥–∞ –≤–æ –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö?

7. **–¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è –∏ –ø–æ–Ω—è—Ç–∏—è**:
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ —Ç–µ—Ä–º–∏–Ω—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏–ª–∏ –µ—Å—Ç—å —Ä–∞–∑–Ω–æ—á—Ç–µ–Ω–∏—è?

8. **–†–æ–ª–∏ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**:
   - –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã –ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è —Ä–æ–ª–µ–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤?

9. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ —Ñ–æ–∫—É—Å**:
   - –ù–µ—Ç –ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞—Ö –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π?

10. **–î—Ä—É–≥–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è**:
    - –õ—é–±—ã–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –∏–µ—Ä–∞—Ä—Ö–∏–∏.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

–°–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –≤ Markdown:

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –°—Ç–∞—Ç—É—Å | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|--------|-------------|
| –ò–µ—Ä–∞—Ä—Ö–∏—è —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ | üî¥/üü°/üü¢ | X/10 | –ö—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö | üî¥/üü°/üü¢ | X/10 | –ö—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–ª–µ–π –∏ —Å–∏—Å—Ç–µ–º | üî¥/üü°/üü¢ | X/10 | –ö—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| –ü—Ä–æ—Ü–µ—Å—Å—ã –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | üî¥/üü°/üü¢ | X/10 | –ö—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ | üî¥/üü°/üü¢ | X/10 | –ö—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å | üî¥/üü°/üü¢ | X/10 | –ö—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è | üî¥/üü°/üü¢ | X/10 | –ö—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| –†–æ–ª–∏ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å | üî¥/üü°/üü¢ | X/10 | –ö—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| **–ò–¢–û–ì–û** | üî¥/üü°/üü¢ | X/10 | –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ |

–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã: üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (0-4) | üü° –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è (5-7) | üü¢ –•–æ—Ä–æ—à–æ (8-10)

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è

#### 1. [–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è]
- **–ì–¥–µ**: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã (—É–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏)
- **–£—Ä–æ–≤–µ–Ω—å**: –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π ‚Üî –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π / –≤–Ω—É—Ç—Ä–∏—É—Ä–æ–≤–Ω–µ–≤—ã–π
- **–°—É—Ç—å**: –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å —Ü–∏—Ç–∞—Ç–∞–º–∏
- **–í–ª–∏—è–Ω–∏–µ**: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ üî¥ / –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ üü° / –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ üü¢
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏

(–ú–∞–∫—Å–∏–º—É–º 10 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π)

### –û–±–ª–∞—Å—Ç–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏

–ü–µ—Ä–µ—á–∏—Å–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –æ–±–ª–∞—Å—Ç–∏ –≥–¥–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã –∏ –¥–æ–ø–æ–ª–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞.

### –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

- **–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞**: X/10
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è** üî¥: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
- **–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è** üü°: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
- **–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã** üü¢: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
- **–¢–æ–ø-3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
"""

        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –≤—ã—è–≤–ª–µ–Ω–∏—é –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏. –¢—ã –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞–µ—à—å –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ü–µ–ª–∏–∫–æ–º –∏ –Ω–∞—Ö–æ–¥–∏—à—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏, –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ —Ü–µ–ª—è—Ö –∏ –ø–æ–¥—Ö–æ–¥–∞—Ö."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.3,
            max_tokens=4000  # –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        )

        analysis = response.choices[0].message.content

        print("‚úÖ AI-–∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω")

        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        doc_count = all_documents.count('## üìÑ')
        chars_analyzed = len(all_documents)
        tokens_approx = chars_analyzed // 4  # –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ 4 —Å–∏–º–≤–æ–ª–∞ = 1 —Ç–æ–∫–µ–Ω

        # –û—Ü–µ–Ω–∏–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å (–¥–ª—è GPT-4o-mini)
        # Input: $0.150 / 1M tokens, Output: $0.600 / 1M tokens
        input_cost = (tokens_approx / 1_000_000) * 0.150
        output_cost = (4000 / 1_000_000) * 0.600  # max_tokens = 4000
        total_cost = input_cost + output_cost

        return f"""
> ü§ñ **AI-–∞–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
>
> üìä **–û—Ö–≤–∞—Ç –∞–Ω–∞–ª–∏–∑–∞**: –í–°–ï {doc_count} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
>
> üìä **–û–±—ä—ë–º –∞–Ω–∞–ª–∏–∑–∞**: {chars_analyzed:,} —Å–∏–º–≤–æ–ª–æ–≤ (~{tokens_approx:,} —Ç–æ–∫–µ–Ω–æ–≤)
>
> üí∞ **–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞**: ~${total_cost:.4f}
>
> üìà **–ú–æ–¥–µ–ª—å**: GPT-4o-mini (128K context)

{analysis}

---

### –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è**: –í—Å–µ markdown –¥–æ–∫—É–º–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è AI-–∞–≥–µ–Ω—Ç–æ–º –ø–æ –≤—Å–µ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç:

1. **–ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å**:
   - –°–≤–µ—Ä—Ö—É –≤–Ω–∏–∑: –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –≤ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
   - –°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö: –º–æ–≥—É—Ç –ª–∏ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–∏—Å—Ç–µ–º –≤–ª–∏—è—Ç—å –Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é

2. **–ú–µ–∂—É—Ä–æ–≤–Ω–µ–≤—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è**:
   - –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üî –°–∏—Å—Ç–µ–º—ã)
   - –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏
   - –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ —Ü–µ–ª—è—Ö –∏ –ø–æ–¥—Ö–æ–¥–∞—Ö

3. **–ü—Ä–æ–±–µ–ª—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**:
   - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É —É—Ä–æ–≤–Ω—è–º–∏
   - –ù–µ–æ–ø–∏—Å–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

_–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å–±–æ—Ä–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞._

---

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π OpenAI (2025)

| –ú–æ–¥–µ–ª—å | –ö–æ–Ω—Ç–µ–∫—Å—Ç | Input (1M tokens) | Output (1M tokens) | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è |
|--------|----------|-------------------|--------------------|--------------------|
| **GPT-4o-mini** ‚úÖ | 128K | $0.150 | $0.600 | –¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ) |
| GPT-4o | 128K | $2.50 | $10.00 | –°–ª–æ–∂–Ω—ã–π –∞–Ω–∞–ª–∏–∑ |
| GPT-4 Turbo | 128K | $10.00 | $30.00 | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ |
| GPT-3.5 Turbo | 16K | $0.50 | $1.50 | –ü—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏ |

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: GPT-5 –ø–æ–∫–∞ –Ω–µ –≤—ã–ø—É—â–µ–Ω (–æ–∂–∏–¥–∞–µ—Ç—Å—è –≤ 2025). –¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä GPT-4o-mini –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Ü–µ–Ω–∞/–∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

**–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞**: ${total_cost:.4f} (~{total_cost * 100:.1f} —Ü–µ–Ω—Ç–æ–≤)
"""

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ AI-–∞–Ω–∞–ª–∏–∑–∞: {e}")
        return f"""
‚ö†Ô∏è **–û—à–∏–±–∫–∞ AI-–∞–Ω–∞–ª–∏–∑–∞**: {str(e)}

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –æ–±–ª–∞—Å—Ç–∏ –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è:
1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–ª–µ–π –∏ —Å–∏—Å—Ç–µ–º
2. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
4. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏
"""


def build_check_document(use_ai: bool = False) -> str:
    """–°–æ–±–∏—Ä–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π"""

    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
    header = f"""# –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç

> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ –¥–∞—ë—Ç —Å–≤–æ–¥–∫—É —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏:
–ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫–∞–∫ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏ —Ä–µ—à–µ–Ω–∏—è –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–∞—Ö, —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞—Ö –∏ –º–µ—Ç—Ä–∏–∫–∞—Ö;
—á–µ–ª–æ–≤–µ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏–ª–∏ –ø–æ–º–µ—á–∞–µ—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞**: –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è (1., 1.1., 1.1.1., ...)

**–û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞:** `0.91. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞.md`

---
"""

    # –°–æ–±–∏—Ä–∞–µ–º —Ä–∞–∑–¥–µ–ª—ã —Å –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
    sections = []
    all_content = []

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è —á–∏—Å–ª–µ–Ω–Ω–æ
    main_sections = sorted(DOCUMENT_MAPPING.keys(), key=lambda x: int(x))

    for section_num in main_sections:
        config = DOCUMENT_MAPPING[section_num]

        # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ 8 (AI-–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π)
        if section_num == "8":
            print(f"–°–æ–±–∏—Ä–∞—é —Ä–∞–∑–¥–µ–ª {section_num}: {config['title']}...")
            section_header = f"\n## {section_num}. {config['title']}\n"
            sections.append(section_header)

            if use_ai:
                combined_content = '\n'.join(all_content)
                analysis_section = analyze_contradictions_with_ai(combined_content)
                # –£–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ ## –∏–∑ AI-–æ—Ç–≤–µ—Ç–∞ –µ—Å–ª–∏ –µ—Å—Ç—å, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏ –µ–≥–æ
                analysis_section = re.sub(r'^##\s*\d+\.\s*–ó–∞–∫–ª—é—á–µ–Ω–∏–µ.*\n', '', analysis_section, flags=re.MULTILINE)
                sections.append(analysis_section)
            else:
                sections.append("""
### –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

AI-–∞–Ω–∞–ª–∏–∑ (–ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç **–í–°–ï –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç:
- **–ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏**: —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ –∏ —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö
- **–ú–µ–∂—É—Ä–æ–≤–Ω–µ–≤—ã—Ö –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π**: –º–µ–∂–¥—É –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º ‚Üî –ò–¥–µ—è–º–∏ ‚Üî –°–∏—Å—Ç–µ–º–∞–º–∏
- **–ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏** –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏

### –û–±–ª–∞—Å—Ç–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| –ò–µ—Ä–∞—Ä—Ö–∏—è —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ | –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏–∑ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ |
| –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö | –ú–æ–≥—É—Ç –ª–∏ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–∏—Å—Ç–µ–º –≤–ª–∏—è—Ç—å –Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é |
| –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–ª–µ–π –∏ —Å–∏—Å—Ç–µ–º | –í—Å–µ –ª–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∑–∞—è–≤–ª–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏ |
| –ü—Ä–æ—Ü–µ—Å—Å—ã –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ |
| –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å | –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã –ª–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã —ç–∫–æ–Ω–æ–º–∏–∫–∏ –≤–∫–ª–∞–¥–∞ |

### –°—Ç–∞—Ç—É—Å

üîÑ **–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫ —Å --ai-analysis –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏**

```bash
python3 ops/build_check_document.py --ai-analysis
```
""")
            continue

        # –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–æ–≤ 1-7
        print(f"–°–æ–±–∏—Ä–∞—é —Ä–∞–∑–¥–µ–ª {section_num}: {config['title']}...")

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–¥–µ–ª–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è
        section_header = f"\n## {section_num}. {config['title']}\n"
        sections.append(section_header)
        all_content.append(section_header)

        # –°–æ–±–∏—Ä–∞–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        if 'subsections' in config:
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã
            subsection_keys = sorted(config['subsections'].keys(),
                                    key=lambda x: tuple(map(int, x.split('.'))))

            for subsection_num in subsection_keys:
                subconfig = config['subsections'][subsection_num]
                print(f"  ‚îî‚îÄ –ü–æ–¥—Ä–∞–∑–¥–µ–ª {subsection_num}: {subconfig['title']}...")
                subsection_content = build_section(subsection_num, subconfig)
                sections.append(subsection_content)
                all_content.append(subsection_content)

    # –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
    full_document = header + '\n'.join(sections)

    return full_document


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    parser = argparse.ArgumentParser(description='–°–±–æ—Ä–∫–∞ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞')
    parser.add_argument('--ai-analysis', action='store_true',
                       help='–í–∫–ª—é—á–∏—Ç—å AI-–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π (—Ç—Ä–µ–±—É–µ—Ç OPENAI_API_KEY)')
    args = parser.parse_args()

    print("üöÄ –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É –ü—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞...")
    print(f"üìÅ –ë–∞–∑–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {BASE_DIR}")
    print(f"üìÑ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {CONTENT_DIR}")

    if args.ai_analysis:
        print("ü§ñ AI-–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π: –í–ö–õ–Æ–ß–ï–ù")
    else:
        print("‚ÑπÔ∏è  AI-–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π: –í–´–ö–õ–Æ–ß–ï–ù (–¥–æ–±–∞–≤—å—Ç–µ --ai-analysis –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è)")

    print()

    # –°–æ–±–∏—Ä–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
    document = build_check_document(use_ai=args.ai_analysis)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    output_path = CONTENT_DIR / "0. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" / "0.5. –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç.md"
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(document)

    print(f"\n‚úÖ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!")
    print(f"üìç –°–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {output_path}")
    print(f"üìä –†–∞–∑–º–µ—Ä: {len(document)} —Å–∏–º–≤–æ–ª–æ–≤")

    if args.ai_analysis:
        print(f"\nü§ñ AI-–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –≤–∫–ª—é—á–µ–Ω –≤ —Ä–∞–∑–¥–µ–ª 8")
    else:
        print(f"\nüí° –î–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –∑–∞–ø—É—Å—Ç–∏—Ç–µ:")
        print(f"   export OPENAI_API_KEY=your_key")
        print(f"   python ops/build_check_document.py --ai-analysis")


if __name__ == "__main__":
    main()
