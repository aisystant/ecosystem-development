name: Generate AI Reports

on:
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ push Ð² main Ð²ÐµÑ‚ÐºÑƒ
  push:
    branches: [ main ]
    paths:
      - 'content/**/*.md'
      - 'ops/build_report.py'

  # Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº (Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 05:00 UTC = 08:00 ÐœÐ¡Ðš)
  schedule:
    - cron: '0 5 * * 0'

  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼ Ð¾Ð¿Ñ†Ð¸Ð¹
  workflow_dispatch:
    inputs:
      ai_analysis:
        description: 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ AI-Ð°Ð½Ð°Ð»Ð¸Ð· (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ ANTHROPIC_API_KEY)'
        required: false
        type: boolean
        default: false
      report_type:
        description: 'Ð¢Ð¸Ð¿ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - architecture-snapshot
          - content-completeness
          - technical-issues
          - terminology
          - recommendations
          - links-map

jobs:
  generate-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ anthropic Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶ÐµÐ½ AI-Ð°Ð½Ð°Ð»Ð¸Ð·
          if [ "${{ github.event_name }}" == "schedule" ] || [ "${{ github.event.inputs.ai_analysis }}" == "true" ]; then
            pip install anthropic
          fi

      - name: Generate reports
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          REPORT_TYPE="${{ github.event.inputs.report_type || 'all' }}"

          echo "ðŸ“Š Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð²: $REPORT_TYPE"
          echo ""

          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð½ÑƒÐ¶ÐµÐ½ Ð»Ð¸ AI-Ð°Ð½Ð°Ð»Ð¸Ð·
          AI_FLAG=""
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "ðŸ“… Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº - AI-Ð°Ð½Ð°Ð»Ð¸Ð· Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½"
            AI_FLAG="--ai-analysis"
          elif [ "${{ github.event.inputs.ai_analysis }}" == "true" ]; then
            echo "ðŸ”§ Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ AI-Ð°Ð½Ð°Ð»Ð¸Ð·Ð¾Ð¼"
            AI_FLAG="--ai-analysis"
          else
            echo "â„¹ï¸ Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð±ÐµÐ· AI-Ð°Ð½Ð°Ð»Ð¸Ð·Ð°"
          fi

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ
          python3 ops/build_report.py --report "$REPORT_TYPE" $AI_FLAG

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet "content/0. Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ/0.4. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹ Ð˜Ð˜/"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add "content/0. Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ/0.4. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹ Ð˜Ð˜/"

          REPORT_TYPE="${{ github.event.inputs.report_type || 'all' }}"

          git commit -m "chore: Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð² Ð˜Ð˜

          Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹: $REPORT_TYPE
          Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€: ${{ github.event_name }}
          Ð’Ñ€ÐµÐ¼Ñ: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          Generated with [Claude Code](https://claude.com/claude-code)"

      - name: Push changes
        if: steps.check_changes.outputs.changed == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Create summary
        run: |
          echo "### ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð²" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… ÐžÑ‚Ñ‡Ñ‘Ñ‚Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð¸ Ð·Ð°ÐºÐ¾Ð¼Ð¼Ð¸Ñ‡ÐµÐ½Ñ‹" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð½Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¾" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          echo "| ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Ð¢Ð¸Ð¿ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°** | \`${{ github.event.inputs.report_type || 'all' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **AI-Ð°Ð½Ð°Ð»Ð¸Ð·** | ${{ github.event_name == 'schedule' && 'âœ… Ð”Ð°' || (github.event.inputs.ai_analysis == 'true' && 'âœ… Ð”Ð°' || 'âŒ ÐÐµÑ‚') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ð’Ñ€ÐµÐ¼Ñ** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **ÐŸÐ°Ð¿ÐºÐ° Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð²:** \`content/0. Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ/0.4. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹ Ð˜Ð˜/\`" >> $GITHUB_STEP_SUMMARY
