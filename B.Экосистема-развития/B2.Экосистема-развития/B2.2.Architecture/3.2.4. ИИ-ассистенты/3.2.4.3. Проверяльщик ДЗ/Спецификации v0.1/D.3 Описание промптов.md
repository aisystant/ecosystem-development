# D.3 Описание промптов

Структура промптов и формат ответа LLM в ДЗ-чекере.

---

## Структура промптов в n8n

ДЗ-чекер использует два промпта, которые собираются в Code-нодах:

| Промпт | Где задаётся | Назначение |
|--------|--------------|------------|
| **Системный** | HTTP Request (LLM) → поле `system` | Роль, принципы, формат ответа |
| **Пользовательский** | Code (Build Prompt) → поле `prompt` | Вопрос, ответ, норматив, критерии |

---

## Системный промпт

Задаётся в HTTP Request ноде при вызове Claude API:

```javascript
{
  model: "claude-3-haiku-20240307",
  max_tokens: 800,
  system: "Ты — опытный наставник образовательной программы. Проверяй ответы стажёров доброжелательно, конструктивно, опираясь на норматив. Отвечай строго в JSON-формате.",
  messages: [...]
}
```

### Принципы проверки

1. **Доброжелательность** — конструктивная критика, поддержка стажёра
2. **Конкретность** — указывать конкретные места в ответе
3. **Опора на норматив** — оценивать относительно материалов курса
4. **Развивающая обратная связь** — рекомендации для улучшения
5. **Честность** — если ответ слабый, сказать об этом конструктивно

---

## Пользовательский промпт (Build Prompt)

Собирается в Code-ноде из данных запроса и контекста:

```javascript
const criteriaText = (data.rubric?.criteria || [])
  .map(c => `- ${c.id} (${c.weight}%): ${c.description || ""}`)
  .join("\n");

const prompt = [
  "## Вопрос домашнего задания",
  data.question_text || "(нет вопроса)",
  "",
  "## Ответ стажера",
  data.answer_text || "(нет ответа)",
  "",
  "## Норматив",
  data.normative_text || "(норматив не найден)",
  "",
  "## Критерии оценки",
  criteriaText || "(критерии не переданы)",
  "",
  "## Инструкция",
  "Проверь ответ стажера по указанным критериям, опираясь на норматив.",
  "Верни результат в формате JSON: verdict, score, strengths, issues [{criterion, issue, suggestion}], next_step, criterion_scores."
].join("\n");
```

### Структура промпта

```markdown
## Вопрос домашнего задания
{question_text}

## Ответ стажера
{answer_text}

## Норматив
{normative_text}

## Критерии оценки
- main_idea (40%): Стажёр передал ключевую идею
- own_example (30%): Приведён собственный пример
- terminology (20%): Корректно использована терминология
- completeness (10%): Ответ полный

## Инструкция
Проверь ответ стажера по указанным критериям, опираясь на норматив.
Верни результат в формате JSON: verdict, score, strengths, issues [{criterion, issue, suggestion}], next_step, criterion_scores.
```

---

## Формат ответа LLM

LLM должен вернуть JSON:

```json
{
  "verdict": "accepted | needs_revision | rejected",
  "score": 0-100,
  "strengths": ["string", ...],
  "issues": [
    {
      "criterion": "criterion_id",
      "issue": "Что не так",
      "suggestion": "Как улучшить"
    }
  ],
  "next_step": "Рекомендация для дальнейшего изучения",
  "criterion_scores": {
    "criterion_id": score,
    ...
  }
}
```

### Правила verdict

| Verdict | Условие |
|---------|---------|
| `accepted` | score >= 80 |
| `needs_revision` | 40 <= score < 80 |
| `rejected` | score < 40 или ответ не по теме |

---

## Обработка ответа (Format node)

Code-нода парсит JSON от LLM и формирует Markdown-комментарий:

```javascript
const rawText = items[0].json.content?.[0]?.text;
let llm;

if (rawText) {
  try {
    llm = JSON.parse(rawText);
  } catch (e) {
    // Если LLM вернул не-JSON, создаём fallback
    llm = {
      verdict: "needs_revision",
      score: null,
      issues: [{ issue: "Ответ LLM не в JSON", suggestion: rawText }],
      next_step: "Верните JSON по шаблону"
    };
  }
}

const verdictMap = {
  accepted: "✓ Принято",
  needs_revision: "На доработку",
  rejected: "Не принято"
};

const comment = [
  `**${verdictMap[llm.verdict] || "—"}** (${llm.score}/100)`,
  "",
  "**Сильные стороны:**",
  (llm.strengths || []).map(s => `- ${s}`).join("\n") || "—",
  "",
  "**Замечания:**",
  (llm.issues || []).map(i =>
    `- ${i.criterion || "критерий"}: ${i.issue}` +
    (i.suggestion ? `\n  _Рекомендация: ${i.suggestion}_` : "")
  ).join("\n") || "—",
  "",
  "**Следующий шаг:**",
  llm.next_step || "—"
].join("\n");
```

---

## Результирующий комментарий

Стажёр видит Markdown-комментарий:

```markdown
**✓ Принято** (85/100)

**Сильные стороны:**
- Верно указано ключевое положение: любая модель фокусируется...
- Приведён хороший практический пример

**Замечания:**
- terminology: Не использован термин «описание системы»
  _Рекомендация: используйте терминологию из материалов_

**Следующий шаг:**
Попробуйте привести ещё один пример из другой области
```

---

## Примеры хороших и плохих комментариев

### Хорошо

> **Сильные стороны:**
> - Вы верно указали, что модель фокусируется на определённых свойствах — это ключевая идея раздела

### Плохо

> **Сильные стороны:**
> - Хороший ответ

(Слишком абстрактно, не указано что именно хорошо)

### Хорошо

> **Замечания:**
> - terminology: Вы написали "разные описания", но в курсе используется термин "описание системы"
>   _Рекомендация: используйте точную терминологию_

### Плохо

> **Замечания:**
> - Неправильная терминология

(Не указано что неправильно и как исправить)

---

## Используемая модель

| Параметр | Значение |
|----------|----------|
| Модель | `claude-3-haiku-20240307` |
| max_tokens | 800 |
| API | https://api.anthropic.com/v1/messages |

**Почему Haiku:**
- Быстрый отклик для синхронных запросов
- Достаточное качество для задач проверки
- Оптимальная стоимость для массовых проверок

---

## Связанные документы

- [D.4 Рубрики проверки](./D.4%20Рубрики%20проверки.md)
- [Общее описание Проверяльщика ДЗ](../Общее%20описание%20Проверяльщика%20ДЗ%20(ДЗ-чекер)%203.2.md)

---

**Версия:** 0.1
**Дата:** 2025-12-31
