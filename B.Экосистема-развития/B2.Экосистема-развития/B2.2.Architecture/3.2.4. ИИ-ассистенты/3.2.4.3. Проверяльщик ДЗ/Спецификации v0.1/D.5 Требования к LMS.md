# D.5 Требования к LMS

Требования к LMS (Aisystant) для интеграции с ДЗ-чекером v0.1.

---

## Общие требования

| Требование | Описание |
|------------|----------|
| **Тип задания** | Только чеклист/ДЗ |
| **Подписка** | Только пользователи с действующей подпиской БР |
| **Интерфейс** | Кнопка «Проверить с ИИ» |

---

## UI: Кнопка «Проверить с ИИ»

### Расположение

Кнопка располагается рядом с полем комментария к пункту чеклиста/ДЗ:

```
┌────────────────────────────────────────────────────────────┐
│  Пункт 1: Почему физический мир может иметь множество      │
│  описаний?                                                 │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐  │
│  │ Ваш ответ:                                           │  │
│  │                                                      │  │
│  │ Любая модель части физического мира фокусируется... │  │
│  │                                                      │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                            │
│  [ Сохранить ]   [ Проверить с ИИ ]                       │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### Состояния кнопки

| Состояние | Вид | Действие при клике |
|-----------|-----|-------------------|
| **Готова** | `[ Проверить с ИИ ]` | Отправить запрос |
| **Загрузка** | `[ Проверяю... ]` | Ничего (disabled) |
| **Неактивна** | `[ Проверить с ИИ ]` (серая) | Показать причину |

---

## Интеграция с API

### Формирование запроса

```javascript
const response = await fetch('/webhook/check', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    answer_text: document.querySelector('.answer-input').value,
    question_text: document.querySelector('.question-text').textContent,
    course_name: getCourseNameFromNavigation(),
    section_name: getSectionNameFromNavigation()
  })
});
```

### Обработка ответов

| Код | Сообщение пользователю |
|-----|------------------------|
| **200** | Рендерить `comment` как Markdown + показать `checked_at` |
| **400** | «Ошибка в запросе, проверьте текст ответа» |
| **500/503** | «Сервис временно недоступен, попробуйте позже» |

### Пример обработки

```javascript
async function checkWithAI() {
  const button = document.querySelector('.check-ai-button');
  button.disabled = true;
  button.textContent = 'Проверяю...';

  try {
    const response = await fetch('/webhook/check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        answer_text: getAnswerText(),
        question_text: getQuestionText(),
        course_name: getCourseName(),
        section_name: getSectionName()
      })
    });

    if (response.status === 200) {
      const data = await response.json();
      renderMarkdown(data.comment);
      showCheckedAt(data.checked_at);
    } else if (response.status === 400) {
      showError('Ошибка в запросе, проверьте текст ответа');
    } else {
      showError('Сервис временно недоступен, попробуйте позже');
    }
  } catch (e) {
    showError('Сервис временно недоступен, попробуйте позже');
  } finally {
    button.disabled = false;
    button.textContent = 'Проверить с ИИ';
  }
}
```

---

## UI: Отображение результата

### После получения ответа

Результат отображается под кнопкой:

```
┌────────────────────────────────────────────────────────────┐
│  Результат ИИ-проверки                                     │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ✓ Принято (85/100)                    31.12.2025 в 12:00 │
│                                                            │
│  Сильные стороны:                                          │
│  • Верно указано, что любая модель фокусируется на        │
│    определённых свойствах                                  │
│  • Хороший пример с программным продуктом                  │
│                                                            │
│  Замечания:                                                │
│  • Не использован термин «описание системы» —              │
│    рекомендую использовать точную терминологию             │
│                                                            │
│  Следующий шаг:                                            │
│  Попробуйте привести ещё один пример из вашей практики    │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### Рендеринг Markdown

Комментарий приходит в Markdown и должен быть отрендерен:

| Синтаксис | Результат |
|-----------|-----------|
| `**текст**` | **текст** (жирный) |
| `- элемент` | • элемент (список) |
| `_текст_` | _текст_ (курсив) |

---

## Предупреждение v0.1

> **Важно:** В v0.1 результат проверки **не сохраняется** и потеряется при:
> - Обновлении страницы
> - Переходе на другой раздел курса
> - Закрытии вкладки

Необходимо показать пользователю это предупреждение:

```
┌────────────────────────────────────────────────────────────┐
│  ⚠️ Результат проверки не сохраняется автоматически.       │
│  Скопируйте текст, если хотите сохранить его.             │
└────────────────────────────────────────────────────────────┘
```

---

## Проверка подписки БР

### Логика

```javascript
function canUseAICheck(user) {
  return user.hasActiveSubscription('BR');
}
```

### Сообщение для пользователей без подписки

> Проверка с ИИ доступна для пользователей с подпиской БР.
> [Узнать о подписке →]

---

## URL для запросов

| Режим | URL |
|-------|-----|
| Production | `/webhook/check` |
| Test | `/webhook-test/check` (только для разработки) |

**Важно:** В production использовать только `/webhook/check`.

---

## Roadmap интеграции

### v0.1 (текущая)

- Кнопка «Проверить с ИИ»
- Синхронный запрос к webhook
- Отображение результата без сохранения
- Обработка ошибок 200/400/500

### v0.2

- Сохранение результатов в БД
- Статусы: «На проверке ИИ», «Проверено ИИ»
- История проверок

### v0.3

- Пакетная проверка всего чеклиста
- Интеграция с наставниками

---

## Связанные документы

- [D.1 Спецификация API ДЗ-чекера](./D.1%20Спецификация%20API%20ДЗ-чекера.md)
- [Общее описание Проверяльщика ДЗ](../Общее%20описание%20Проверяльщика%20ДЗ%20(ДЗ-чекер)%203.2.md)

---

**Версия:** 0.1
**Дата:** 2025-12-31
**Статус:** Для согласования с командой фронтенда
