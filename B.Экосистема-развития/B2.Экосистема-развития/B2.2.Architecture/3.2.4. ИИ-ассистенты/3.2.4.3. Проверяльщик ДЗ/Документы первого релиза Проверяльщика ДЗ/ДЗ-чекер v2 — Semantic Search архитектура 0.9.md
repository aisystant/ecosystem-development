# ДЗ-чекер v2 — Semantic Search архитектура

> **Статус:** draft
> **Семейство:** F0 (Управление знаниями)
> **Автор:** Claude
> **Дата:** 2026-01-04
> **Версия:** 0.9

## 0. Назначение документа

Описание новой архитектуры ДЗ-чекера на основе семантического поиска (`semantic_search`), которая работает напрямую с текстом вопроса без необходимости знать структуру руководства.

**Потребители:**
- Архитектор (проектирование и развёртывание)
- Разработчики (интеграция с LMS)
- Операторы (мониторинг и отладка)

**Связанные документы:**
- [[Workflow ДЗ-чекера в n8n 0.9]] — предыдущая версия (deprecated)
- [[Структура репозитория руководств 0.9]]
- [[Канонический шаблон описания MCP Tools и Resources]]

---

## 1. Проблема предыдущего подхода

### Старая архитектура (v1)

```
course_name → маппинг на руководство
section_name → fuzzy match по списку секций
get_guide_sections → get_section_content → норматив
```

**Проблемы:**

| Проблема | Описание |
|----------|----------|
| **Нет идентификаторов на фронте** | Пользователь на странице вопросов, не на текстовом разделе |
| **Жёсткая структура** | Требуется уникальность заголовков и точный маппинг |
| **Два вызова MCP** | `get_guide_sections` + `get_section_content` |
| **Fuzzy matching** | Ненадёжно при похожих названиях разделов |

---

## 2. Новая архитектура (v2)

### Ключевая идея

**Вместо резолвинга названий используем семантический поиск по тексту вопроса.**

```
question_text → semantic_search → релевантные фрагменты → LLM оценивает ответ
```

### Преимущества

| Аспект | v1 (старый) | v2 (новый) |
|--------|-------------|------------|
| Маппинг названий | Требуется | **Не нужен** |
| Количество вызовов MCP | 2 | **1** |
| Работа с неточными названиями | Fuzzy match | **Семантический поиск** |
| Структура руководства | Жёсткая | **Любая** |

---

## 3. Входные данные (с фронта LMS)

```json
{
  "question_text": "Почему важно развивать мышление письмом?",
  "answer_text": "Ответ стажера...",
  "course_name": "Системное саморазвитие",
  "section_name": "Мышление письмом"
}
```

| Поле | Обязательное | Использование |
|------|--------------|---------------|
| `question_text` | **Да** | Запрос для semantic_search |
| `answer_text` | **Да** | Ответ для оценки |
| `course_name` | Нет | Контекст для LLM (опционально) |
| `section_name` | Нет | Контекст для LLM (опционально) |

**Важно:** `section_name` больше не используется для поиска — только как контекст в промпте.

---

## 4. Схема workflow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         n8n workflow v2                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────┐    ┌──────────┐    ┌─────────────────────────────────┐   │
│  │ Webhook  │───▶│ Validate │───▶│         AI Agent                │   │
│  │ POST     │    │          │    │                                 │   │
│  │ /check   │    │          │    │  Tool: semantic_search          │   │
│  └──────────┘    └──────────┘    │  ├── query: question_text       │   │
│                                  │  ├── lang: "ru"                 │   │
│                                  │  └── limit: 3-5                 │   │
│                                  │                                 │   │
│                                  │  LLM: сравнивает answer_text    │   │
│                                  │       с найденными фрагментами  │   │
│                                  └─────────────────────────────────┘   │
│                                           │                             │
│  ┌──────────┐    ┌──────────┐             │                             │
│  │ Respond  │◀───│  Parse   │◀────────────┘                             │
│  │ Webhook  │    │ + Format │                                           │
│  └──────────┘    └──────────┘                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Количество узлов:** 4 (вместо 7+ в v1)

---

## 5. Инструмент semantic_search

MCP-сервер: `https://guides-mcp.aisystant.workers.dev/mcp`

### 5.1 Параметры вызова

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `query` | string | Да | Поисковый запрос (текст вопроса) |
| `lang` | string | Нет | Язык (`ru`, `en`). По умолчанию `ru` |
| `limit` | number | Нет | Количество результатов. По умолчанию 5 |

### 5.2 Пример вызова (JSON-RPC 2.0)

```json
{
  "jsonrpc": "2.0",
  "id": "search-1",
  "method": "tools/call",
  "params": {
    "name": "semantic_search",
    "arguments": {
      "query": "Почему важно развивать мышление письмом?",
      "lang": "ru",
      "limit": 3
    }
  }
}
```

### 5.3 Формат ответа

```json
{
  "jsonrpc": "2.0",
  "id": "search-1",
  "result": {
    "content": [
      {
        "type": "text",
        "text": "[{...}, {...}, {...}]"
      }
    ]
  }
}
```

Поле `result.content[0].text` содержит JSON-массив с результатами поиска.

### 5.4 Структура результата поиска

Каждый элемент массива:

```json
{
  "content": "Не нужно сосредотачиваться на слове "письмом", намного важнее слово "размышлять". При малейшей возможности необходимо размышлять письмом. Мышление письмом — главная привычка современного человека, которая демонстрирует культуру мышления.",
  "guide_id": "guides:ru_self-development-methods",
  "heading": "Что такое мышление письмом",
  "score": 0.7303,
  "section_id": "sections:ru_self-development-methods_what-is-thinking-through-writing"
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `content` | string | **Текст чанка (норматив)** — главное поле для проверки |
| `heading` | string | Заголовок раздела, откуда взят фрагмент |
| `score` | number | Релевантность запросу (0–1). Чем выше, тем лучше |
| `guide_id` | string | Идентификатор руководства |
| `section_id` | string | Идентификатор секции |

### 5.5 Пример реального ответа

Запрос: `"Почему важно мышление письмом?"`

```json
[
  {
    "content": "Не нужно сосредотачиваться на слове "письмом", намного важнее слово "размышлять". При малейшей возможности необходимо размышлять письмом. Мышление письмом — главная привычка современного человека, которая демонстрирует культуру мышления.",
    "guide_id": "guides:ru_self-development-methods",
    "heading": "Что такое мышление письмом",
    "score": 0.7303
  },
  {
    "content": "Письмо не является результатом мышления, это среда, в которой оно происходит. В процессе мышления письмом участвуют ваш мозг и глаза, руки (десятипальцевый метод), компьютер...",
    "guide_id": "guides:ru_self-development-methods",
    "heading": "Принципы практики мышления письмом.",
    "score": 0.7061
  },
  {
    "content": "Мышление письмом начинается с чтения. Размышление письмом происходит, когда вы составляете заметки, а потом, когда переносите и дополняете их в черновиках...",
    "guide_id": "guides:ru_self-development-methods",
    "heading": "Принципы практики мышления письмом.",
    "score": 0.7004
  }
]
```

---

## 6. Детальное описание узлов

### 6.1 Webhook (POST /check)

**Тип:** `n8n-nodes-base.webhook`
**Путь:** `/check`
**Метод:** POST

**Пример запроса:**

```json
{
  "answer_text": "Мышление письмом важно потому что...",
  "question_text": "Почему важно развивать мышление письмом?",
  "course_name": "Системное саморазвитие",
  "section_name": "Мышление письмом"
}
```

---

### 6.2 Code — Валидация входных данных

**Обязательные поля (v2):**
- `question_text` — для semantic_search
- `answer_text` — для оценки

**Опциональные поля:**
- `course_name` — контекст для LLM
- `section_name` — контекст для LLM

```javascript
const body = items[0]?.json?.body ?? items[0]?.json ?? {};

const required = ["question_text", "answer_text"];
const missing = required.filter(k => !body[k]);

if (missing.length) {
  return [{
    json: {
      ok: false,
      status: 400,
      body: {
        ok: false,
        error: {
          code: "bad_request",
          message: `Missing required fields: ${missing.join(", ")}`
        }
      }
    }
  }];
}

const request_id = `req_${Date.now()}_${Math.random().toString(16).slice(2)}`;

return [{
  json: {
    ok: true,
    request_id,
    received_at: new Date().toISOString(),
    question_text: body.question_text,
    answer_text: body.answer_text,
    course_name: body.course_name ?? null,
    section_name: body.section_name ?? null,
    debug: !!body.debug
  }
}];
```

---

### 6.3 AI Agent (semantic_search + оценка)

**Тип:** `@n8n/n8n-nodes-langchain.agent`
**Модель:** Claude 3.5 Haiku

**Системный промпт:**

```
Ты — проверяющий ответы стажёров по нормативам из руководств.

АЛГОРИТМ:
1. Вызови semantic_search с query = текст вопроса
2. Получи релевантные фрагменты (поле "content" в каждом результате — это норматив)
3. Используй фрагменты с score > 0.6 как основу для проверки
4. Сравни ответ стажера с нормативом по критериям:
   - Полнота: все ли ключевые идеи из норматива отражены
   - Корректность: нет ли противоречий с нормативом
   - Терминология: используется ли терминология из норматива
   - Структура: логичен ли ответ

ФОРМАТ ОТВЕТА (строго JSON):
{
  "verdict": "accepted" | "needs_revision" | "rejected",
  "score": 0-100,
  "strengths": ["...", "..."],
  "issues": [
    {"criterion": "...", "issue": "...", "suggestion": "..."}
  ],
  "next_step": "..."
}

ПРАВИЛА ОЦЕНКИ:
- 90-100: accepted (ответ полный и корректный)
- 60-89: needs_revision (есть что улучшить)
- 0-59: rejected (ответ не соответствует нормативу)

Если semantic_search не вернул результатов — верни verdict="needs_revision",
score=0, issue="normative_not_found".
```

**Пользовательский промпт (шаблон):**

```
Курс: {{course_name}}
Раздел: {{section_name}}

ВОПРОС:
{{question_text}}

ОТВЕТ СТАЖЕРА:
{{answer_text}}

Найди релевантный норматив через semantic_search и оцени ответ.
```

---

### 6.4 HTTP Request Tool — semantic_search

**Тип:** `n8n-nodes-base.httpRequestTool`
**URL:** `https://guides-mcp.aisystant.workers.dev/mcp`
**Метод:** POST

**Описание для AI:** `Семантический поиск по руководствам. Возвращает релевантные фрагменты с полями: content (текст), heading (заголовок), score (релевантность 0-1).`

**Тело запроса:**

```javascript
={{
  ({
    jsonrpc: "2.0",
    id: "search-1",
    method: "tools/call",
    params: {
      name: "semantic_search",
      arguments: {
        query: $fromAI("query"),
        lang: "ru",
        limit: 5
      }
    }
  })
}}
```

---

### 6.5 Code — Parse + Format

**Назначение:** Парсинг ответа LLM и форматирование комментария.

Проверяет:
- Был ли вызван semantic_search (через intermediateSteps)
- Валидность JSON-ответа от LLM
- Нормализация полей verdict, score, issues

---

### 6.6 Respond to Webhook

Возвращает результат проверки.

```json
{
  "ok": true,
  "request_id": "req_...",
  "checked_at": "2026-01-04T12:00:00.000Z",
  "verdict": "needs_revision",
  "score": 75,
  "comment": "**На доработку** (75/100)...",
  "strengths": [...],
  "issues": [...],
  "next_step": "..."
}
```

---

## 7. Поток данных

```
┌───────────────────────────────────────────────────────────────────────┐
│                           ВХОДНЫЕ ДАННЫЕ                              │
│  question_text (обязательно), answer_text (обязательно)              │
│  course_name (опционально), section_name (опционально)               │
└─────────────────────────────────┬─────────────────────────────────────┘
                                  │
                                  ▼
┌───────────────────────────────────────────────────────────────────────┐
│                    MCP-СЕРВЕР (guides-mcp)                            │
│                                                                       │
│  semantic_search(query=question_text, lang="ru", limit=5)            │
│                                                                       │
│  Возвращает массив чанков:                                           │
│  [{content, heading, score, guide_id, section_id}, ...]              │
└─────────────────────────────────┬─────────────────────────────────────┘
                                  │
                                  ▼
┌───────────────────────────────────────────────────────────────────────┐
│                         CLAUDE LLM                                    │
│                                                                       │
│  Входы:                                                               │
│  - question_text                                                      │
│  - answer_text                                                        │
│  - найденные чанки (норматив из поля content)                        │
│                                                                       │
│  Выход: verdict, score, strengths, issues, next_step                 │
└─────────────────────────────────┬─────────────────────────────────────┘
                                  │
                                  ▼
┌───────────────────────────────────────────────────────────────────────┐
│                        ВЫХОДНЫЕ ДАННЫЕ                                │
│  ok, request_id, checked_at, verdict, score, comment, ...            │
└───────────────────────────────────────────────────────────────────────┘
```

---

## 8. Сравнение v1 и v2

| Аспект | v1 | v2 |
|--------|----|----|
| Входные данные | 4 обязательных поля | 2 обязательных + 2 опциональных |
| Маппинг названий | course_name → руководство | **Не нужен** |
| Резолвинг секции | section_name → секция | **Не нужен** |
| Вызовы MCP | 2 (sections + content) | **1 (semantic_search)** |
| Поиск норматива | Точное/fuzzy совпадение | **Семантический поиск** |
| Узлы workflow | 7+ | **4** |
| Обработка неточностей | Сложная логика | **Встроена в search** |

---

## 9. Обработка ошибок

| Ситуация | Обработка |
|----------|-----------|
| Нет question_text или answer_text | Ошибка 400 |
| semantic_search вернул пустой массив | verdict: "needs_revision", issue: "normative_not_found" |
| Все результаты с score < 0.5 | verdict: "needs_revision", issue: "low_relevance" |
| MCP-сервер недоступен | Ошибка 503, retry |
| LLM вернул не-JSON | Fallback-структура с raw_text |

---

## 10. Использование score из semantic_search

Поле `score` (0–1) показывает релевантность чанка запросу:

| Score | Интерпретация | Действие |
|-------|---------------|----------|
| > 0.7 | Высокая релевантность | Использовать как основной норматив |
| 0.5–0.7 | Средняя релевантность | Использовать как дополнительный контекст |
| < 0.5 | Низкая релевантность | Игнорировать или предупреждать |

**Рекомендация:** Если все результаты имеют score < 0.5, LLM должен вернуть issue: "low_relevance".

---

## 11. Следующие шаги

1. ~~Получить формат ответа `semantic_search` от MCP-сервера~~ ✓ Готово
2. Создать n8n workflow по новой архитектуре
3. Протестировать на реальных вопросах из LMS
4. Обновить интеграцию с LMS (убрать section_name из обязательных)
5. Добавить логирование для анализа качества проверок

---

*Документ описывает архитектуру ДЗ-чекера v2 с использованием семантического поиска.*
