---
type: guide
status: draft
version: 0.2
created: 2025-12-30
updated: 2025-12-30
layer: integration
scope: ecosystem
related:
  - "Архитектура доступа ИИ к данным экосистемы 3.2"
  - "FSM-архитектура ИИ-ассистентов 3.2"
  - "Канонический шаблон описания MCP Tools и Resources"
description: "Пошаговая процедура интеграции MCP-серверов с LLM через OpenAI Apps SDK"
---

# Интеграция MCP-серверов с LLM через OpenAI Apps SDK

> **Назначение:** Пошаговое руководство по подключению MCP-серверов экосистемы к LLM через OpenAI Apps SDK для предоставления пользователям доступа через ChatGPT.

---

## Что вы получите в результате

После выполнения этого руководства:

1. **Пользователи** смогут обращаться к ИИ-ассистентам экосистемы через ChatGPT
2. **LLM** получит доступ ко всем инструментам всех подключённых MCP-серверов
3. **MCP-app** сможет вызывать MCP-data для получения персонализированных данных

---

## Ключевые принципы интеграции

| Принцип | Реализация |
|---------|------------|
| **Разделение логики и данных** | MCP-app (логика) отдельно от MCP-data (доступ к данным) |
| **Все MCP на одном уровне** | LLM может вызывать любой MCP; MCP-app также может вызывать MCP-data |
| **Приватность по умолчанию** | Агент получает только данные текущего пользователя |
| **Доступ к БД только через MCP-data** | MCP-app не имеет прямого доступа к базам данных |

---

## Схема архитектуры интеграции

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ПОЛЬЗОВАТЕЛИ                                   │
│                                                                             │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                   │
│  │ Вася          │  │ Петя          │  │ Маша          │                   │
│  │ "Подведи      │  │ "Найди        │  │ "Какие        │                   │
│  │  итоги недели"│  │  руководство" │  │  мои цели?"   │                   │
│  └───────────────┘  └───────────────┘  └───────────────┘                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ взаимодействует через
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ChatGPT (Apps SDK)                                  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ GPT (LLM)                                                           │   │
│  │                                                                     │   │
│  │ • Понимает запрос пользователя                                     │   │
│  │ • Вызывает любые MCP-инструменты (MCP-app и MCP-data)              │   │
│  │ • Формирует ответ                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ вызов инструментов
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       MCP-СЕРВЕРЫ (один уровень)                            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           MCP-APP                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ fsm-mcp (Cloudflare Workers)                                │   │   │
│  │  │                                                             │   │   │
│  │  │ ИИ-ассистенты:                                              │   │   │
│  │  │ • Проводник по персональному маршруту развития              │   │   │
│  │  │   (Ассистент Ученика)                                        │   │   │
│  │  │ • ... (другие ассистенты в будущем)                          │   │   │
│  │  │                                                             │   │   │
│  │  │ Инструменты: get_instruction(state?)                        │   │   │
│  │  │ Может вызывать: MCP-data (server-to-server)                 │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           MCP-DATA                                  │   │
│  │  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐          │   │
│  │  │ dt-mcp         │ │ guides-mcp     │ │ exercises-mcp  │          │   │
│  │  │ (Цифр. двойник)│ │ (Руководства)  │ │ (Упражнения)   │          │   │
│  │  │                │ │                │ │                │          │   │
│  │  │ dt.get_progress│ │ guides.search  │ │ exercises.get  │          │   │
│  │  │ dt.get_goals   │ │ guides.get     │ │ exercises.check│          │   │
│  │  │ dt.save_*      │ │                │ │                │          │   │
│  │  └────────────────┘ └────────────────┘ └────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Все MCP доступны для LLM. MCP-app также может вызывать MCP-data.          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ доступ к БД только через MCP-data
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           БАЗЫ ДАННЫХ                                       │
│                                                                             │
│  ┌────────────────────┐ ┌────────────────────┐ ┌────────────────────┐      │
│  │ Digital Twin Store │ │ Guides Repository  │ │ Exercises Bank     │      │
│  │ (SurrealDB)        │ │ (Git + SurrealDB)  │ │ (SurrealDB + S3)   │      │
│  └────────────────────┘ └────────────────────┘ └────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Два типа MCP-серверов

### MCP-app (логика)

| Характеристика | Описание |
|----------------|----------|
| **Назначение** | Оркестрация диалога, FSM-переходы между состояниями |
| **Инструменты** | `get_instruction(state?)` |
| **Содержимое** | `states/*.md` — инструкции для каждого состояния |
| **Вызывает** | MCP-data (server-to-server) |
| **Кто создаёт** | Разработчики ИИ-ассистентов |
| **Размещение** | Cloudflare Workers |
| **Репозиторий** | [github.com/aisystant/fsm-mcp](https://github.com/aisystant/fsm-mcp) |

### MCP-data (данные)

| Характеристика | Описание |
|----------------|----------|
| **Назначение** | Чтение/запись данных в хранилища |
| **Инструменты** | `dt.get_progress()`, `guides.search()`, `exercises.get()` и др. |
| **Содержимое** | Логика доступа к базам данных |
| **Вызывается** | LLM напрямую или из MCP-app (server-to-server) |
| **Вызывает** | Данные из баз данных (только MCP-data имеет доступ к БД) |
| **Кто создаёт** | Архитектор ИИ-платформы |
| **Размещение** | Cloudflare Workers |

---

## Предварительные требования

| Требование | Описание |
|------------|----------|
| **Аккаунт OpenAI** | Верифицированный аккаунт разработчика |
| **MCP-серверы** | Развёрнутые и доступные по HTTPS |
| **OAuth-провайдер** | Aisystant Identity для авторизации пользователей |

### Проверка готовности MCP-серверов

Перед интеграцией убедитесь, что MCP-серверы отвечают:

```bash
# MCP-app
curl -X POST https://fsm-mcp.aisystant.workers.dev/mcp \
  -H "Content-Type: application/json" \
  -d '{"method": "tools/list"}'

# MCP-data
curl -X POST https://dt-mcp.aisystant.workers.dev/mcp \
  -H "Content-Type: application/json" \
  -d '{"method": "tools/list"}'
```

---

## Таблица компонентов

| Компонент | Тип | Размещение | Технологии |
|-----------|-----|------------|------------|
| **ChatGPT App** | Интерфейс | OpenAI | Apps SDK |
| **fsm-mcp** | MCP-app | Cloudflare Workers | TypeScript |
| **dt-mcp** | MCP-data | Cloudflare Workers | TypeScript |
| **guides-mcp** | MCP-data | Cloudflare Workers | TypeScript |
| **exercises-mcp** | MCP-data | Cloudflare Workers | TypeScript |
| **Identity Provider** | Авторизация | Сервер МИМ | Keycloak / Custom |
| **Digital Twin Store** | База данных | Cloud | SurrealDB |
| **Guides Repository** | База данных | Cloud | Git + SurrealDB |
| **Exercises Bank** | База данных | Cloud | SurrealDB + S3 |

---

## Пошаговая процедура интеграции

### Шаг 1. Включить Developer Mode в ChatGPT

1. Войдите в ChatGPT с аккаунтом OpenAI
2. Откройте **Settings → Apps & Connectors → Advanced**
3. Включите **Developer Mode**
4. Сохраните изменения

**Результат:** Доступ к созданию коннекторов в Developer Platform.

---

### Шаг 2. Создать приложение в Developer Platform

1. Откройте [platform.openai.com](https://platform.openai.com)
2. Перейдите в **Apps**
3. Нажмите **Create App**

Заполните базовые параметры:

| Поле | Значение |
|------|----------|
| Name | Aisystant Ecosystem |
| Description | Персонализированное развитие через ИИ-ассистентов |
| Category | Education, Productivity |

**Результат:** Создано приложение, готовое к подключению MCP-серверов.

---

### Шаг 3. Подключить все MCP-серверы

В настройках приложения добавьте все MCP-серверы экосистемы (MCP-app + MCP-data):

#### 3.1 Добавить MCP-app (логика ассистентов)

| Параметр | Значение |
|----------|----------|
| Name | fsm-mcp |
| URL | `https://fsm-mcp.aisystant.workers.dev/mcp` |
| Auth | OAuth (Aisystant Identity) |

#### 3.2 Добавить MCP-data (данные)

**dt-mcp (Цифровой двойник):**

| Параметр | Значение |
|----------|----------|
| Name | dt-mcp |
| URL | `https://dt-mcp.aisystant.workers.dev/mcp` |
| Auth | OAuth (Aisystant Identity) |

**guides-mcp (Руководства):**

| Параметр | Значение |
|----------|----------|
| Name | guides-mcp |
| URL | `https://guides-mcp.aisystant.workers.dev/mcp` |
| Auth | OAuth (Aisystant Identity) |

**exercises-mcp (Упражнения):**

| Параметр | Значение |
|----------|----------|
| Name | exercises-mcp |
| URL | `https://exercises-mcp.aisystant.workers.dev/mcp` |
| Auth | OAuth (Aisystant Identity) |

#### Конфигурация в формате JSON

```json
{
  "mcpServers": {
    "fsm-mcp": {
      "url": "https://fsm-mcp.aisystant.workers.dev/mcp"
    },
    "dt-mcp": {
      "url": "https://dt-mcp.aisystant.workers.dev/mcp"
    },
    "guides-mcp": {
      "url": "https://guides-mcp.aisystant.workers.dev/mcp"
    },
    "exercises-mcp": {
      "url": "https://exercises-mcp.aisystant.workers.dev/mcp"
    }
  }
}
```

**Важно:**
- Сколько MCP в Apps SDK: Все (N MCP-app + N MCP-data)
- Какие инструменты видит GPT: Все инструменты всех подключённых MCP
- Как GPT выбирает инструмент: По контексту запроса пользователя

**Результат:** Все MCP-серверы подключены. GPT видит все инструменты.

---

### Шаг 4. Настроить OAuth авторизацию

#### 4.1 В Aisystant Identity

Создайте OAuth-клиент для OpenAI Apps SDK:

| Параметр | Значение |
|----------|----------|
| Client ID | `openai-apps-sdk` |
| Redirect URI | Согласно документации OpenAI |
| Scopes | `profile`, `read:dt`, `write:dt`, `read:guides` |

#### 4.2 В Developer Platform

Настройте OAuth в приложении:

| Параметр | Значение |
|----------|----------|
| OAuth Provider | Aisystant Identity |
| Authorization URL | `https://identity.aisystant.com/oauth/authorize` |
| Token URL | `https://identity.aisystant.com/oauth/token` |
| Scopes | `profile read:dt write:dt read:guides` |

#### 4.3 Поток авторизации

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  1. Пользователь входит через ChatGPT                                      │
│                                                                             │
│  2. OAuth авторизация через Aisystant Identity                             │
│     • Пользователь логинится                                               │
│     • Получает access_token                                                │
│                                                                             │
│  3. Токен передаётся в MCP-запросы                                         │
│     • Apps SDK → любой MCP (Authorization: Bearer <token>)                 │
│     • MCP-app → MCP-data (Authorization: Bearer <token>) при s2s вызовах  │
│                                                                             │
│  4. Каждый MCP проверяет токен                                             │
│     • Валидность токена                                                    │
│     • Извлекает user_id                                                    │
│     • Возвращает только данные этого пользователя                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Результат:** Пользователи смогут авторизоваться, токен будет передаваться в MCP-запросы.

---

### Шаг 5. Проверить доступность инструментов

После подключения GPT должен видеть все инструменты. Проверьте в Developer Console:

**Ожидаемые инструменты:**

| MCP-сервер | Тип | Инструменты |
|------------|-----|-------------|
| fsm-mcp | MCP-app | `get_instruction(state?)` |
| dt-mcp | MCP-data | `dt.get_progress()`, `dt.get_goals()`, `dt.save_reflection()` |
| guides-mcp | MCP-data | `guides.search(query)`, `guides.get(id)` |
| exercises-mcp | MCP-data | `exercises.get(id)`, `exercises.check(id, answer)` |

**Результат:** GPT может вызывать любой инструмент любого MCP-сервера.

---

### Шаг 6. Тестирование сценариев

#### Два варианта вызова MCP

LLM может работать с MCP двумя способами:

| Вариант | Когда использовать | Пример |
|---------|-------------------|--------|
| **LLM → MCP-app → MCP-data** | Сложные сценарии с FSM-логикой | "Подведи итоги недели" |
| **LLM → MCP-data напрямую** | Простые запросы данных | "Найди руководство по системному мышлению" |

#### Сценарий 1: Через MCP-app (FSM-логика)

Пользователь: *"Подведи итоги недели"*

```
1. LLM вызывает get_instruction() → fsm-mcp
2. fsm-mcp определяет состояние weekly_reflection
3. fsm-mcp вызывает dt.get_week_summary() → dt-mcp (server-to-server)
4. fsm-mcp возвращает инструкции + данные
5. LLM формирует структурированный ответ
```

#### Сценарий 2: Напрямую к MCP-data

Пользователь: *"Найди руководство по системному мышлению"*

```
1. LLM вызывает guides.search("системное мышление") → guides-mcp напрямую
2. guides-mcp возвращает список руководств
3. LLM формирует ответ
```

#### Сценарий 3: Комбинированный

Пользователь: *"Какие мои цели? И дай упражнение по первой цели"*

```
1. LLM вызывает dt.get_goals() → dt-mcp
2. LLM вызывает exercises.get(goal_id) → exercises-mcp
3. LLM формирует комбинированный ответ
```

#### Диаграмма: оба варианта вызова

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  ChatGPT    │      │    GPT      │      │  fsm-mcp    │      │ guides-mcp  │
└──────┬──────┘      └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
       │                    │                    │                    │
       │                    │                    │                    │
       │  Вариант 1: через MCP-app               │                    │
       │  ─────────────────────────              │                    │
       │                    │                    │                    │
       │                    │  get_instruction() │                    │
       │                    │───────────────────>│                    │
       │                    │                    │  guides.search()   │
       │                    │                    │───────────────────>│
       │                    │                    │<───────────────────│
       │                    │<───────────────────│                    │
       │                    │                    │                    │
       │                    │                    │                    │
       │  Вариант 2: напрямую к MCP-data         │                    │
       │  ──────────────────────────────         │                    │
       │                    │                    │                    │
       │                    │  guides.search()   │                    │
       │                    │────────────────────────────────────────>│
       │                    │<────────────────────────────────────────│
       │                    │                    │                    │
```

**Результат:** Все сценарии работают корректно.

---

### Шаг 7. Настроить server-to-server вызовы (MCP-app → MCP-data)

Для сложных сценариев MCP-app должен уметь вызывать MCP-data:

```typescript
// fsm-mcp: получает токен от интерфейса, передаёт в dt-mcp

async function callMcpData(tool: string, args: object, token: string) {
  const response = await fetch('https://dt-mcp.aisystant.workers.dev/mcp', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`  // передаём токен дальше
    },
    body: JSON.stringify({ tool, args })
  });

  return response.json();
}

// Использование в get_instruction
async function getInstruction(state: string, context: Context) {
  const token = context.headers.get('Authorization');

  // Получаем данные пользователя из dt-mcp
  const progress = await callMcpData(
    'dt.get_progress',
    {},
    token
  );

  // Возвращаем инструкции с данными
  return {
    instructions: loadState(state),
    userData: progress
  };
}
```

**Ключевой момент:** Токен пользователя передаётся от Apps SDK → MCP-app → MCP-data. Каждый MCP проверяет токен и возвращает только данные этого пользователя.

**Результат:** MCP-app может обогащать инструкции данными из MCP-data.

---

### Шаг 8. Публикация приложения

#### 8.1 Подготовка метаданных

| Параметр | Значение |
|----------|----------|
| Иконка | 512x512 PNG |
| Скриншоты | 3-5 примеров диалогов |
| Категории | Education, Productivity |
| Описание | Подробное описание возможностей |

#### 8.2 Отправка на ревью

1. В Developer Platform нажмите **Submit for Review**
2. Дождитесь ответа (обычно 3-5 рабочих дней)
3. Доработайте по замечаниям при необходимости

**Результат:** Приложение доступно пользователям ChatGPT.

---

## Чек-лист интеграции

| # | Шаг | Статус |
|---|-----|--------|
| 1 | Developer Mode включён | ☐ |
| 2 | Приложение создано в Developer Platform | ☐ |
| 3 | MCP-app подключён (fsm-mcp) | ☐ |
| 4 | MCP-data подключены (dt-mcp, guides-mcp, exercises-mcp) | ☐ |
| 5 | OAuth настроен (Aisystant Identity) | ☐ |
| 6 | Инструменты доступны GPT | ☐ |
| 7 | Сценарий через MCP-app работает | ☐ |
| 8 | Сценарий напрямую к MCP-data работает | ☐ |
| 9 | Server-to-server вызовы работают (токен передаётся) | ☐ |
| 10 | Приложение опубликовано | ☐ |

---

## Типичные проблемы и решения

| Проблема | Причина | Решение |
|----------|---------|---------|
| MCP-сервер недоступен | Неверный URL или сервер не запущен | Проверить URL, статус Workers |
| Инструменты не видны GPT | MCP не возвращает `tools/list` | Проверить реализацию MCP |
| Ошибка авторизации | Неверный OAuth-конфиг | Проверить Client ID, Redirect URI |
| s2s вызовы не работают | Токен не передаётся | Убедиться, что токен передаётся в заголовке |
| Данные не возвращаются | MCP-data не имеет доступа к БД | Проверить подключение к базе данных |

---

## Безопасность

### Передача токена

```
Apps SDK → MCP-app → MCP-data
              ↓         ↓
        Authorization: Bearer <token>
```

- Каждый MCP проверяет токен
- Извлекает `user_id`
- Возвращает только данные этого пользователя

### Изоляция данных

- **MCP-app** не имеет прямого доступа к базам данных
- **MCP-data** — единственный способ получить данные из хранилищ
- Каждый MCP-data сервер отвечает за свой домен данных

### Content Security Policy

```json
{
  "connect_domains": [
    "fsm-mcp.aisystant.workers.dev",
    "dt-mcp.aisystant.workers.dev",
    "guides-mcp.aisystant.workers.dev",
    "exercises-mcp.aisystant.workers.dev"
  ]
}
```

---

## ИИ-ассистенты

### Текущий ассистент

| Название | Описание | MCP |
|----------|----------|-----|
| **Проводник по персональному маршруту развития** (Ассистент Ученика) | Помогает планировать обучение, подводить итоги, работать с затыками | fsm-mcp |

### Добавление новых ассистентов

Новые ассистенты создаются как:
1. Новые `states/*.md` в существующем MCP-app (если используют ту же логику)
2. Отдельный MCP-app (если логика существенно отличается)

Все ассистенты используют общие MCP-data (dt-mcp, guides-mcp, exercises-mcp).

---

## Связанные документы

- **[[Архитектура доступа ИИ к данным экосистемы 3.2]]** — общая архитектура (MCP-app / MCP-data)
- **[[FSM-архитектура ИИ-ассистентов 3.2]]** — архитектура FSM-логики ассистентов
- **[[Канонический шаблон описания MCP Tools и Resources]]** — формат описания инструментов

---

## Changelog

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-30 | v0.1 | Документ создан на основе архитектуры v1.3. Фокус на пошаговой процедуре |
| 2025-12-30 | v0.2 | Полное обновление: добавлены схемы из архитектуры, таблица компонентов, поток авторизации, сценарии вызовов |
