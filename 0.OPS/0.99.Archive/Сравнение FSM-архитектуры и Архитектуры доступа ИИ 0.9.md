---
type: analysis
status: draft
version: 0.1
created: 2025-12-29
layer: architecture
scope: ecosystem
description: "Сравнительный анализ принятой FSM-архитектуры и новой архитектуры доступа ИИ к данным"
related:
  - "FSM-архитектура ИИ-ассистентов 3.2"
  - "Архитектура доступа ИИ к данным экосистемы 0.9"
---

# Сравнение FSM-архитектуры и Архитектуры доступа ИИ

## Назначение документа

Этот документ объясняет **разницу между двумя архитектурными решениями** и их взаимоотношение:

| Документ | Статус | Фокус |
|----------|--------|-------|
| **[[FSM-архитектура ИИ-ассистентов 3.2]]** | `accepted` | Как ИИ-ассистент принимает решения |
| **[[Архитектура доступа ИИ к данным экосистемы 0.9]]** | `draft` | Откуда берутся данные для решений |

**Ключевой тезис:** Это не конкурирующие, а **дополняющие** архитектуры. FSM описывает "мозг", а новая архитектура — "нервную систему" доступа к данным.

---

## Что описывает каждый документ

### FSM-архитектура (принятая, работающая)

```
┌─────────────────────────────────────────────────────────────┐
│                    FSM-АРХИТЕКТУРА                          │
│                                                             │
│  Отвечает на вопрос:                                       │
│  "Как организовать логику диалога ИИ-ассистента?"          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Ассистент = LLM + Системный промпт + MCP-сервер    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Ключевые концепции:                                       │
│  • Состояния (states/*.md) — что делать в каждой точке    │
│  • Переходы — когда менять состояние                       │
│  • Деградация — что делать без данных                      │
│  • Единственный инструмент: get_instruction(state?)        │
│                                                             │
│  Референсная реализация: fsm-mcp на Cloudflare Workers     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Что НЕ описывает FSM-архитектура:**
- Откуда берутся данные Цифрового двойника
- Как проверяется согласие пользователя
- Как работает авторизация
- Кто ещё может создавать агентов

### Архитектура доступа ИИ (новая, расширение)

```
┌─────────────────────────────────────────────────────────────┐
│              АРХИТЕКТУРА ДОСТУПА ИИ К ДАННЫМ                │
│                                                             │
│  Отвечает на вопрос:                                       │
│  "Как ИИ-агенты безопасно получают данные пользователей?" │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Агенты → Доверие → MCP-серверы → Хранилища данных  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Ключевые концепции:                                       │
│  • 4 слоя: Агенты / Доверие / Доступ / Данные             │
│  • Policy Engine — кто что может                           │
│  • Consent Service — согласие пользователя                 │
│  • MCP Gateway — единая точка проверки доступа             │
│  • Два типа агентов: МИМ и сообщество                      │
│                                                             │
│  Статус: проектирование (draft)                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Что НЕ описывает Архитектура доступа:**
- Формат состояний FSM
- Как писать инструкции для LLM
- Структуру репозитория агента
- Конкретные сценарии диалога

---

## Схема взаимоотношения

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                         FSM-АРХИТЕКТУРА                                     │
│                    (как ассистент думает)                                   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  states/init.md ──► states/plan_entry.md ──► states/plan_save.md  │   │
│  │       │                     │                        │             │   │
│  │       │                     │                        │             │   │
│  │       ▼                     ▼                        ▼             │   │
│  │  get_instruction()     get_instruction()       get_instruction()   │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    │ "нужны данные ЦД"                     │
│                                    │ dt_load_week()                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │                    АРХИТЕКТУРА ДОСТУПА ИИ                          │   │
│  │                  (как получить данные)                              │   │
│  │                                                                     │   │
│  │  ┌───────────┐   ┌───────────┐   ┌───────────┐   ┌───────────┐    │   │
│  │  │ Identity  │──►│ Consent   │──►│ Policy    │──►│ MCP       │    │   │
│  │  │ Provider  │   │ Service   │   │ Engine    │   │ Gateway   │    │   │
│  │  └───────────┘   └───────────┘   └───────────┘   └─────┬─────┘    │   │
│  │                                                        │          │   │
│  │                                                        ▼          │   │
│  │                                              ┌───────────────┐    │   │
│  │                                              │ DigitalTwin   │    │   │
│  │                                              │ MCP → Store   │    │   │
│  │                                              └───────────────┘    │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Детальное сравнение

### 1. Область ответственности

| Аспект | FSM-архитектура | Архитектура доступа ИИ |
|--------|-----------------|------------------------|
| **Фокус** | Логика диалога | Инфраструктура данных |
| **Главный вопрос** | "Что сказать пользователю?" | "Какие данные можно показать?" |
| **Уровень абстракции** | Один ассистент | Вся платформа агентов |
| **Состояние реализации** | ✅ Работает (fsm-mcp) | 📋 Проект (draft) |

### 2. Ключевые сущности

| FSM-архитектура | Архитектура доступа ИИ |
|-----------------|------------------------|
| State (состояние) | Layer (слой) |
| Transition (переход) | Policy (политика) |
| Instruction (инструкция) | Scope (разрешение) |
| Degradation (деградация) | Consent (согласие) |
| MCP-сервер (один) | MCP-серверы (много) + Gateway |

### 3. Компоненты

| Компонент | FSM | Доступ ИИ | Комментарий |
|-----------|-----|-----------|-------------|
| **LLM** | ✅ Центральный | ✅ В Runtime | Одинаково |
| **fsm-mcp** | ✅ Единственный MCP | ✅ Часть Runtime | FSM внутри нового |
| **Цифровой двойник** | ⚠️ "Внешний сервис" | ✅ Детализирован | Новый раскрывает |
| **Identity Provider** | ❌ Не описан | ✅ Keycloak/Custom | Добавлено |
| **Consent Service** | ⚠️ Состояния dt_consent | ✅ Отдельный сервис | Вынесено |
| **Policy Engine** | ❌ Не описан | ✅ OPA | Добавлено |
| **MCP Gateway** | ❌ Нет | ✅ PEP | Добавлено |
| **Агенты сообщества** | ❌ Нет | ✅ Marketplace | Добавлено |
| **Audit Log** | ❌ Нет | ✅ ClickHouse | Добавлено |

### 4. Модель согласия (consent)

**FSM-архитектура:**
```
states/
├── dt_consent.md      ← Состояние "спросить разрешение"
├── dt_load_profile.md ← Состояние "загрузить данные"
├── dt_load_week.md    ← Состояние "загрузить неделю"
└── no_dt_mode.md      ← Состояние "работа без данных"
```
Согласие — это **состояние FSM**, которое LLM обрабатывает в диалоге.

**Архитектура доступа ИИ:**
```
┌─────────────────────────────────────────────────────────────┐
│ Consent Service                                             │
│                                                             │
│  • База данных согласий (user_id, agent_id, scopes, ttl)   │
│  • API для проверки: hasConsent(user, agent, scope)        │
│  • UI для управления согласиями                             │
│  • Интеграция с Policy Engine                              │
└─────────────────────────────────────────────────────────────┘
```
Согласие — это **отдельный сервис** с персистентным хранением.

### 5. Типы агентов

**FSM-архитектура:**
- Описывает **одного** ассистента (Ассистент Ученика / Проводник)
- Все агенты имплицитно от МИМ

**Архитектура доступа ИИ:**
| Тип | Владелец | Статус | Consent | Квоты |
|-----|----------|--------|---------|-------|
| ИИ-системы МИМ | Платформа | verified | implicit | нет |
| Агенты сообщества | Участники | audited | explicit | есть |

---

## Почему нужны оба документа

### FSM-архитектура нужна потому что:

1. **Уже работает** — есть референсная реализация fsm-mcp
2. **Решает конкретную задачу** — структурирует сложный диалог
3. **Понятна методологам** — состояния в markdown, не нужно программировать
4. **Проверена практикой** — используется для Ассистента Ученика

### Архитектура доступа ИИ нужна потому что:

1. **FSM не отвечает на вопросы безопасности** — кто проверяет доступ?
2. **Появляются агенты сообщества** — нужна изоляция и квоты
3. **Нужен аудит** — кто когда что запрашивал
4. **Масштабирование** — много агентов, много MCP-серверов

---

## Как они работают вместе

### Сценарий: Пользователь просит "подвести итоги недели"

```
1. ИНТЕРФЕЙС
   Пользователь пишет в ChatGPT: "Подведи итоги недели"

2. FSM-АРХИТЕКТУРА (get_instruction)
   ┌────────────────────────────────────────────────┐
   │ LLM вызывает: get_instruction()               │
   │ fsm-mcp возвращает: инструкции init.md        │
   │                                                │
   │ LLM понимает намерение → weekly_reflection    │
   │ LLM вызывает: get_instruction("weekly_refl..") │
   │ fsm-mcp возвращает: инструкции weekly_refl.md │
   │                                                │
   │ Инструкции говорят: "загрузи данные недели"   │
   └────────────────────────────────────────────────┘

3. АРХИТЕКТУРА ДОСТУПА (dt.get_week_summary)
   ┌────────────────────────────────────────────────┐
   │ fsm-mcp вызывает: dt.get_week_summary()       │
   │                     ↓                          │
   │ Identity: user = vasia ✓                       │
   │                     ↓                          │
   │ Consent: dt:read:time = implicit (агент МИМ)  │
   │                     ↓                          │
   │ Policy: allow (verified agent)                 │
   │                     ↓                          │
   │ MCP Gateway → DigitalTwin MCP → SurrealDB     │
   │                     ↓                          │
   │ Возврат: { pomodoros: 12, total_minutes: 540 } │
   └────────────────────────────────────────────────┘

4. FSM-АРХИТЕКТУРА (формирование ответа)
   ┌────────────────────────────────────────────────┐
   │ LLM получил данные                             │
   │ Следует инструкциям weekly_reflection.md      │
   │ Формирует ответ: "На этой неделе вы..."       │
   └────────────────────────────────────────────────┘

5. ИНТЕРФЕЙС
   Пользователь видит структурированный итог недели
```

---

## Терминологическое соответствие

| Термин в FSM | Термин в Архитектуре доступа | Связь |
|--------------|------------------------------|-------|
| `dt_consent` (состояние) | Consent Service | FSM спрашивает, сервис хранит |
| `dt_load_week` (состояние) | `dt.get_week_summary` (tool) | FSM инициирует, tool выполняет |
| `no_dt_mode` (состояние) | `data_quality.coverage = 0` | Деградация по метаданным |
| MCP-сервер (fsm-mcp) | Managed Agent Runtime | fsm-mcp внутри Runtime |
| "Цифровой двойник" | DigitalTwin MCP + Store | Детализация слоёв |

---

## Рекомендации по развитию

### Для FSM-архитектуры

1. **Не менять** работающую логику состояний
2. **Добавить** в документацию ссылку на Архитектуру доступа
3. **Уточнить** что `dt_*` состояния работают через новую инфраструктуру

### Для Архитектуры доступа ИИ

1. **Сохранить совместимость** с fsm-mcp
2. **Использовать терминологию** FSM-архитектуры где применимо
3. **Добавить раздел** "Соответствие FSM-архитектуре"

### Общие

1. **Синхронизировать** названия инструментов: `dt_load_week` ↔ `dt.get_week_summary`
2. **Создать глоссарий** общих терминов
3. **Поддерживать обратные ссылки** между документами

---

## Заключение

| Вопрос | Ответ |
|--------|-------|
| Противоречат ли документы? | Нет, они дополняют друг друга |
| Нужно ли переписывать FSM? | Нет, она работает и останется |
| Что добавляет новая архитектура? | Инфраструктуру безопасности и масштабирования |
| Можно ли реализовать новую? | Да, поэтапно, начиная с dt-mcp |

**Метафора:** FSM-архитектура — это "мозг" ассистента (как думать). Архитектура доступа — это "нервная система" (как безопасно получать информацию от органов чувств).

---

## Связанные документы

- **[[FSM-архитектура ИИ-ассистентов 3.2]]** — принятое решение по логике ассистентов
- **[[Архитектура доступа ИИ к данным экосистемы 0.9]]** — проект инфраструктуры доступа
- **[[Интеграция ассистентов через OpenAI Apps SDK 0.9]]** — конкретная реализация
- **[[Канонический шаблон описания MCP Tools и Resources]]** — формат описания инструментов

---

## Changelog

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-29 | v0.1 | Документ создан |
